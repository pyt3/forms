<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <base target="_top">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <!-- icon -->
    <link rel="icon" href="https://img.icons8.com/3d-fluency/94/move-by-trolley.png" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: 'Prompt', sans-serif;
            /* background-color: #e9b33b; */
            /* background-color: #D3D3D3; */
        }

        #sticker {
            width: 100%;
            height: 100%;
        }

        .load-bar {
            position: relative;
            margin-top: 0px;
            width: 100%;
            height: 6px;
            background-color: #fdba2c;
        }

        .bar {
            content: "";
            display: inline;
            position: absolute;
            width: 0;
            height: 100%;
            left: 50%;
            text-align: center;
        }

        .bar:nth-child(1) {
            background-color: #da4733;
            animation: loading 3s linear infinite;
        }

        .bar:nth-child(2) {
            background-color: #3b78e7;
            animation: loading 3s linear 1s infinite;
        }

        .bar:nth-child(3) {
            background-color: #fdba2c;
            animation: loading 3s linear 2s infinite;
        }

        @keyframes loading {
            from {
                left: 0;
                width: 0;
                z-index: 100;
            }

            33.3333% {
                left: 0;
                width: 100%;
                z-index: 10;
            }

            to {
                left: 0;
                width: 100%;
            }
        }
    </style>
    <title>อัพเดทงาน</title>
</head>

<body class="bg-body-tertiary">
    <div class="load-bar">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>
    <main>
        <div class="container-fluid d-none">
            <div class="row mt-3">
                <div class="col-md-4 d-none">
                    <div class="alert alert-success">
                        WO. <span id="workorder"></span><br>
                        <i class="bi bi-check-circle-fill"></i><span id="reciever"></span>
                    </div>
                </div>
            </div>
            <div class="row g-3 justify-content-center">
                <div class="col-md-4 has-code d-none">
                    <div class="form-floating">
                        <input type="text" id="request-no" name="request-no" class="form-control" id="floatingInput"
                            readonly>
                        <label for="request-no">Request No.</label>
                    </div>
                </div>
                <div class="col-md-4 has-code d-none">
                    <div class="form-floating">
                        <input type="text" id="code" name="code" class="form-control" id="floatingInput" readonly>
                        <label for="code">Code</label>
                    </div>
                </div>
                <div class="col-12 mobile">
                    <label for="update">อัพเดท</label>
                    <textarea name="update" id="update" class="form-control" rows="5"
                        placeholder="กรอกข้อมูลอัพเดท"></textarea>
                </div>
                <div class="col-md-4 mobile">
                    <label for="name">ชื่อผู้กรอก</label>
                    <select name="name" id="name" class="form-select">
                        <option value="" selected disabled>ชื่อผู้กรอก</option>
                        <option value="CHAIWAT SALAIWONG">CHAIWAT SALAIWONG</option>
                        <option value="PASSAWAN TOANUN">PASSAWAN TOANUN</option>
                        <option value="PANALEE UEASUNTHONNOP">PANALEE UEASUNTHONNOP</option>
                        <option value="SERMKEAT HADJANG">SERMKEAT HADJANG</option>
                        <option value="CHANCHAI SAE-LEE">CHANCHAI SAE-LEE</option>
                        <option value="SARAN THAMMATHORN">SARAN THAMMATHORN</option>
                        <option value="PUKARIN TONGKLIANG">PUKARIN TONGKLIANG</option>
                        <option value="ANUPHAB CHANTO">ANUPHAB CHANTO</option>
                        <option value="NARUECHA CHAIYAPHAN">NARUECHA CHAIYAPHAN</option>
                        <option value="ITTIPAT IEMDEE">ITTIPAT IEMDEE</option>
                        <option value="SASIMAPORN KHANTHAHOME">SASIMAPORN KHANTHAHOME</option>
                        <option value="DARANPHOP YIMYAM">DARANPHOP YIMYAM</option>
                        <option value="RAPIPHAN KHAMSUWAN">RAPIPHAN KHAMSUWAN</option>
                        <option value="SOM KONKAEW">SOM KONKAEW</option>
                        <option value="PATCHARAPORN JORNSAMER">PATCHARAPORN JORNSAMER</option>
                        <option value="RATCHATA PIRIYAKITTSAKUL">RATCHATA PIRIYAKITTSAKUL</option>
                        <option value="ILADA BUAPRALAT">ILADA BUAPRALAT</option>
                        <option value="THANIPONG PHIEWKHLAM">THANIPONG PHIEWKHLAM</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3 justify-content-center mobile">
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" id="submit">ยืนยัน</button>
                </div>
            </div>
        </div>
        <div class="container-fluid d-none">
            <div class="row g-3 mt-3 mb-5 justify-content-center">
                <div class="col-md-4">
                    <button class="btn btn-danger w-100" id="summary-btn">สรุปงาน</button>
                </div>
                <div class="col-12 d-none m-3 border p-3 rounded mt-3 bg-info-subtle">
                    <p class="user-select-all" id="summary"></p>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" id="more-update-btn">อัพเดทเพิ่ม</button>
                </div>
            </div>
        </div>
    </main>
    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbyGpvPo7JHYeCr9z3IIT_Sek1xbazhaDeBKXeHnTjdQWyNK8qitAq8G_ibfTW1ThLB5/exec'
        const liff_id = '1661543046-a1pJexbX'
        $(document).ready(async () => {
            moment.locale('th')
            liff.init({
                liffId: liff_id,
                withLoginOnExternalBrowser: true
            })

            liff.ready.then(async () => {
                if (liff.getContext().type != 'group') {
                    $('.mobile').addClass('d-none')
                }
                const defaultProject = firebase.initializeApp(await $.getJSON('service-account.json'));
                firestore = defaultProject.firestore();
                auth = defaultProject.auth();
                if (!auth.currentUser) {
                    // await getAuth()
                    await getAuth(await liff.getDecodedIDToken().sub)
                }
                initialData();
            })
        })
        var jobid
        function initialData() {
            let url = new URL(window.location.href);
            jobid = url.searchParams.get("jobid");
            if(!jobid || jobid == '' || jobid == undefined || jobid == null){
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่พบข้อมูล',
                    text: 'ไม่พบข้อมูล',
                })
                return liff.closeWindow()
            }
            let code = url.searchParams.get("code");
            let action = url.searchParams.get("action");
            let updateText = localStorage.getItem('updateText' + jobid)
            if (updateText != null) $('#update').val(updateText)
            $("#code").val(code);
            $("#request-no").val(jobid);
            $(".has-code").removeClass("d-none")
            $('#name').val(localStorage.getItem('name') || '')
            $('#name').change(function () {
                localStorage.setItem('name', $(this).val())
            })
            if (action == 'summary') {
                $('.mobile').addClass('d-none')
                $('input').attr('readonly', true)
                $('#summary').parent().removeClass('d-none')
                $('#summary').parents('.row').find('.col-md-4').first().addClass('d-none')
                $('#summary').parents('.container-fluid').removeClass('d-none')
                $('#request-no').parents('.container-fluid').removeClass('d-none')
                $.LoadingOverlay("show");


                firestore.collection('jobdata/').doc(jobid).collection('update').get().then(data => {
                    data = data.docs.map(doc => doc.data())
                    let msg
                    if (data.length == 0) msg = 'ยังไม่มีการอัพเดทงาน'
                    else msg = data.map(r => {
                        r.timestamp = moment(r.timestamp.toDate()).format('DD/MM/YYYY HH:mm (dddd)')
                        return r
                    }).map(d => {
                        return `${d.timestamp}<br>${d.update}<br>#${d.name}`
                    }).join('<br><br>-----------------------------------')
                    $('#summary').html(msg)
                    $('#summary').parent().removeClass('d-none').focus()
                    $.LoadingOverlay("hide");
                    $('.load-bar').addClass('d-none')
                })

                firestore.collection('jobdata/').doc(jobid).get().then(data => {
                    data = data.data()
                    $('#code').val(data.code)
                    if (!data.name && !data.reciever) {
                        $('#reciever').html = '&nbsp;ยังไม่มีคนรับงาน'
                        $('#reciever').parent().find('i').removeClass('bi-check-circle-fill').addClass('bi-x-circle-fill')
                        $('#reciever').parent().removeClass('alert-success').addClass('alert-danger')
                    }
                    else $('#reciever').html("&nbsp;รับงานโดย: " + (data.name || data.reciever))
                    $('#workorder').html(data.wo || data.workorder || 'ยังไม่มี').parents('.col-md-4').removeClass('d-none')
                })
                // $.ajax({
                //     url: scriptUrl,
                //     method: 'POST',
                //     data: {
                //         jobid: jobid,
                //         opt: 'summary'
                //     },
                //     success: (res) => {
                //         console.log("🚀 !! res:", res)
                //         $.LoadingOverlay("hide");
                //         if (res.status == 'success') {
                //             if (res.result.replace(/\n/g, '<br>') == '') res = 'ยังไม่มีสรุปงาน'
                //             else res = res.result.replace(/\n/g, '<br>')
                //             $('#summary').html(res)
                //             $('#summary').parent().removeClass('d-none').focus()
                //         } else {
                //             Swal.fire({
                //                 icon: 'error',
                //                 title: 'สรุปงานไม่สำเร็จ',
                //                 text: 'สรุปงานไม่สำเร็จ',
                //             })
                //         }
                //     },
                // })
                $('#more-update-btn').click(() => {
                    let url = new URL('line://app/' + liff_id)
                    url.searchParams.set('code', code)
                    url.searchParams.set('jobid', jobid)
                    url.searchParams.set('action', 'update')
                    window.open(url, '_self')
                })
            } else {
                firestore.collection('jobdata/').doc(jobid).get().then(data => {
                    $('.load-bar').addClass('d-none')
                    data = data.data()
                    if (!data.name && !data.reciever) {
                        $('#reciever').html = '&nbsp;ยังไม่มีคนรับงาน'
                        $('#reciever').parent().find('i').removeClass('bi-check-circle-fill').addClass('bi-x-circle-fill')
                        $('#reciever').parent().removeClass('alert-success').addClass('alert-danger')
                    }
                    else $('#reciever').html("&nbsp;รับงานโดย: " + (data.name || data.reciever))
                    $('#workorder').html(data.wo || data.workorder || 'ยังไม่มี').parents('.col-md-4').removeClass('d-none')
                })
                $('.container-fluid').removeClass('d-none')
                $('#more-update-btn').addClass('d-none')
            }
            $("#submit").click(() => {
                let update = $("#update").val();
                let name = $("#name").val();
                if (update == "") {
                    Swal.fire({
                        icon: 'error',
                        title: 'กรุณากรอกข้อมูลอัพเดท',
                        text: 'กรุณากรอกข้อมูลอัพเดท',
                    })
                } else if (name == null || name == '') {
                    Swal.fire({
                        icon: 'error',
                        title: 'กรุณาเลือกชื่อผู้กรอก',
                        text: 'กรุณาเลือกชื่อผู้กรอก',
                    })
                } else {
                    let text = `UPDATE<br>รหัส ${code}<br>วันที่ ${new Date().toLocaleString('en-GB', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: false })} น.<br><br>${update}<br><br>#${name}`
                    Swal.fire({
                        title: 'ตรวจสอบข้อมูล',
                        html: text,
                        showCancelButton: true,
                        confirmButtonText: 'ยืนยัน',
                        cancelButtonText: 'ยกเลิก',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                    }).then(result => {
                        if (result.isConfirmed) {
                            updateData(code, jobid, update, text.replace(/<br>/g, '\n'), name);
                        }
                    })

                }
            })

            $('#summary-btn').click(function () {
                let url = new URL('line://app/' + liff_id)
                url.searchParams.set('code', code)
                url.searchParams.set('jobid', jobid)
                url.searchParams.set('action', 'summary')
                window.open(url, '_self')
            })

            // listen on user finish typing on update field
            let typingTimer;
            let doneTypingInterval = 800;
            $('#update').keyup(function () {
                clearTimeout(typingTimer);
                if ($('#update').val()) {
                    typingTimer = setTimeout(doneTyping, doneTypingInterval);
                }
            });




        }

        function doneTyping() {
            console.log(jobid);
            let update = $("#update").val();
            localStorage.setItem('updateText' + jobid, update)
        }

        function updateData(code, jobid, update, text, name) {
            // $.ajax({
            //     url: scriptUrl,
            //     method: 'POST',
            //     data: {
            //         code: code,
            //         jobid: jobid,
            //         update: update,
            //         name: name,
            //     },
            //     success: (res) => {
            //         if (res.status == 'success') {
            //             Swal.fire({
            //                 icon: 'success',
            //                 title: 'อัพเดทข้อมูลสำเร็จ',
            //                 text: 'อัพเดทข้อมูลสำเร็จ',
            //             })
            //         } else {
            //             Swal.fire({
            //                 icon: 'error',
            //                 title: 'อัพเดทข้อมูลไม่สำเร็จ',
            //                 text: 'อัพเดทข้อมูลไม่สำเร็จ',
            //             })
            //         }
            //     },
            // })
            firestore.collection('jobdata/').doc(jobid).collection('update').add({
                update: update,
                name: name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            localStorage.removeItem('updateText' + jobid)
            const colorArrays = [
                ["#ffffff", "#1a237e"],
                ["#000000", "#ffb74d"],
                ["#800080", "#00e676"],
                ["#FF4500", "#80d8ff"],
                ["#8A2BE2", "#ffd600"],
                ["#2E8B57", "#d50000"],
                ["#FF1493", "#00c853"],
                ["#4169E1", "#e91e63"],
                ["#DAA520", "#4a148c"],
                ["#228B22", "#ff6d00"],
                ["#FFD700", "#263238"],
                ["#8B4513", "#01579b"],
                ["#800000", "#4caf50"],
                ["#9932CC", "#ff5722"],
                ["#A0522D", "#00b0ff"],
                ["#8B0000", "#00695c"],
                ["#6A5ACD", "#d32f2f"],
                ["#BDB76B", "#1b5e20"],
                ["#FF6347", "#6200ea"],
                ["#DC143C", "#00796b"],
                ["#87CEEB", "#ff3d00"],
                ["#8B4513", "#ffab00"],
                ["#1E90FF", "#7b1fa2"],
                ["#006400", "#ff6f00"],
                ["#7B68EE", "#64dd17"],
                ["#FF69B4", "#2962ff"],
                ["#556B2F", "#c51162"],
                ["#2F4F4F", "#f50057"],
                ["#800080", "#009688"],
                ["#9932CC", "#1a237e"],
                ["#D2691E", "#0288d1"]
            ];

            console.log(colorArrays);

            let random = Math.floor(Math.random() * colorArrays.length);
            let color = colorArrays[random];

            liff.sendMessages([
                {
                    type: 'text',
                    text: text
                },
                {
                    type: 'flex',
                    altText: 'Update ' + code,
                    contents: {
                        "type": "bubble",
                        "size": "nano",
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "ดูสรุปงาน",
                                    "weight": "bold",
                                    "align": "center",
                                    "scaling": true,
                                    "color": color[0]
                                }
                            ],
                            "action": {
                                "type": "uri",
                                "label": "action",
                                "uri": "https://liff.line.me/1661543046-a1pJexbX?action=summary&jobid=" + jobid + "&code=" + code
                            }
                        },
                        "styles": {
                            "body": {
                                "backgroundColor": color[1]
                            }
                        }
                    }
                }
            ]).then(() => {
                liff.closeWindow();
            })
        }

        $('.user-select-all').click(function () {
            // copy to clipboard
            var $temp = $("<textarea>");
            $("body").append($temp);
            $temp.val($(this).text()).select();
            document.execCommand("copy");
            $temp.remove();
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1000
            })

            Toast.fire({
                icon: 'success',
                title: 'คัดลอกสำเร็จ'
            })
        })
    </script>
    <script>
        var firestore, auth
        async function getAuth(uid = 'test') {
            console.log("🚀 !! uid:", uid)
            let email = uid + '@jobdata.com'
            let password = 'jobdata'
            await auth.signInWithEmailAndPassword(email, password).then(function (user) {
                console.log('sign in successful')
            }).catch(async function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                var credential = error.credential;
                console.log(errorCode)
                console.log(errorMessage)
                console.log(credential)
                await auth.createUserWithEmailAndPassword(email, password).then(function (user) {
                    console.log('sign up successful')
                }).catch(function (error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    // ...
                    console.log(errorCode)
                    console.log(errorMessage)
                    console.log(email)
                    console.log(credential)
                });
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
</body>

</html>