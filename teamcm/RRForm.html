<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    
    <base target="_top">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <!-- icon -->
    <link rel="icon" href="https://img.icons8.com/3d-fluency/94/maintenance.png" type="image/x-icon" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: 'Prompt', sans-serif;
            background-color: #f05217;
            /* background-color: #D3D3D3; */
        }

        #sticker {
            width: 100%;
            height: 100%;
        }

        .nsmart-img {
            cursor: grab;
        }

        .nsmart-img:active {
            cursor: grabbing;
        }
    </style>
    <title>RR Form</title>
</head>

<body>
    <header>
        <nav class="navbar" style="background-color: #b9181b;">
            <div class="container-fluid">
                <img width="30" height="30" src="https://img.icons8.com/3d-fluency/94/maintenance.png" alt="trash" />
                <form class="d-flex" role="search" id="search-form">
                    <input class="form-control form-control-sm me-2" type="search" placeholder="กรอกรหัสเพื่อค้นหา"
                        aria-label="Search" id="search-input">
                    <button class="btn btn-sm btn-light" type="submit">Search</button>
                </form>
            </div>
        </nav>
        <div class="container-fluid d-flex flex-column align-items-center justify-content-center w-100 mt-4">
            <div class="col-auto">
                <img width="80" src="https://img.icons8.com/3d-fluency/94/maintenance.png" alt="repair" />
            </div>

            <div class="col text-center">
                <h4 class="h1 fw-bold text-light">RR Form</h4>
            </div>
        </div>
    </header>
    <main>
        <div class="container-fluid">
            <form id="myForm" class="mt-3 mb-5">
                <!-- <section class="mt-4 m-2">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="name">ชื่อผู้กรอก</label>
                            <select name="name" id="name" class="form-select">
                                <option value="" selected disabled>ชื่อผู้กรอก</option>
                                <option value="CHAIWAT SALAIWONG">CHAIWAT SALAIWONG</option>
                                <option value="PASSAWAN TOANUN">PASSAWAN TOANUN</option>
                                <option value="PANALEE UEASUNTHONNOP">PANALEE UEASUNTHONNOP</option>
                                <option value="SERMKEAT HADJANG">SERMKEAT HADJANG</option>
                                <option value="CHANCHAI SAE-LEE">CHANCHAI SAE-LEE</option>
                                <option value="SARAN THAMMATHORN">SARAN THAMMATHORN</option>
                                <option value="PUKARIN TONGKLIANG">PUKARIN TONGKLIANG</option>
                                <option value="ANUPHAB CHANTO">ANUPHAB CHANTO</option>
                                <option value="NARUECHA CHAIYAPHAN">NARUECHA CHAIYAPHAN</option>
                                <option value="ITTIPAT IEMDEE">ITTIPAT IEMDEE</option>
                                <option value="SASIMAPORN KHANTHAHOME">SASIMAPORN KHANTHAHOME</option>
                                <option value="DARANPHOP YIMYAM">DARANPHOP YIMYAM</option>
                                <option value="CHATVIPA KAEWPRESERT">CHATVIPA KAEWPRESERT</option>
                                <option value="RAPIPHAN KHAMSUWAN">RAPIPHAN KHAMSUWAN</option>
                                <option value="SOM KONKAEW">SOM KONKAEW</option>
                                <option value="PATCHARAPORN JORNSAMER">PATCHARAPORN JORNSAMER</option>
                                <option value="RATCHATA PIRIYAKITTSAKUL">RATCHATA PIRIYAKITTSAKUL</option>
                                <option value="ILADA BUAPRALAT">ILADA BUAPRALAT</option>
                                <option value="THANIPONG PHIEWKHLAM">THANIPONG PHIEWKHLAM</option>
                            </select>
                        </div>
                    </div>
                </section> -->
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow">
                    <div class="row justify-content-between">
                        <div class="col text-start d-none">
                            <!-- download btn -->
                            <a class="btn btn-primary" id="download-from-search-btn" type="button"><img width="30"
                                    src="https://img.icons8.com/papercut/60/pdf.png" alt="opened-folder" />
                                ดูไฟล์ PDF</a>
                        </div>
                        <div class="col text-end">
                            <button class="btn btn-primary" id="auto-fill" type="button" data-bs-toggle="offcanvas"
                                data-bs-target="#autoFillOffCanvas" aria-controls="autoFillOffCanvas">Auto Fill</button>
                        </div>
                    </div>
                    <div class="row justify-content-start">
                        <div class="col-12 d-flex align-items-center mt-3">
                            <img src="https://img.icons8.com/external-flaticons-flat-flat-icons/64/external-defibrillator-medical-and-healthcare-flaticons-flat-flat-icons.png"
                                alt="icon" width="50">
                            <h4 class="fw-bold">&nbsp;รายละเอียดเครื่องมือ</h4>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr_no">เลข RR</label>
                            <input type="text" name="rr_no" id="rr_no" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="job_id">Work Order</label>
                            <input type="text" name="job_id" id="job_id" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_name">ชื่อเครื่องมือ</label>
                            <input type="text" name="e_name" id="e_name" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_dept">แผนก</label>
                            <select name="e_dept" id="e_dept" class="form-select">
                                <option value="" disabled="" selected="">Select value</option>
                                <option data-dept-id="244">ANESTHESIA (วิสัญญี)</option>
                                <option data-dept-id="162">ART-LAB (ศูนย์ผู้มีบุตรยาก)</option>
                                <option>Biomolecular Laboratory</option>
                                <option>BME-PYT3</option>
                                <option data-dept-id="232">CATH-LAB</option>
                                <option data-dept-id="151">CHECK-UP (ตรวจสุขภาพ)</option>
                                <option data-dept-id="551">CORPORATE CUSTOMER SERVICE</option>
                                <option data-dept-id="245">CSSD (จ่ายกลาง)</option>
                                <option data-dept-id="291">DENTAL (ทันตกรรม)</option>
                                <option data-dept-id="411">DIABETIC&amp;METABOLIC(เบาหวาน)</option>
                                <option data-dept-id="271">EENT( หูตาคอจมูก)</option>
                                <option data-dept-id="101">EMERGENCY( ฉุกเฉิน)</option>
                                <option data-dept-id="351">GASTROINTESTINAL LABORATORY(GI)</option>
                                <option data-dept-id="212">HEMODIALYSIS (ไตเทียม)</option>
                                <option data-dept-id="211">HOPD CENTER (ศุนย์มะเร็ง)</option>
                                <option data-dept-id="123">INFECTION CONTROL ( IC)</option>
                                <option data-dept-id="241">INTENSIVE CARE UNIT(ผู้ป่วยหนัก)</option>
                                <option data-dept-id="163">LABOR ROOM(ห้องคลอด)</option>
                                <option data-dept-id="311">LABORATORY</option>
                                <option>MAID</option>
                                <option data-dept-id="571">MARKETING</option>
                                <option data-dept-id="167">NURSERY(เด็กอ่อน)</option>
                                <option data-dept-id="671">NURSING DEPARTMENT</option>
                                <option>OBSERVE(สังเกตอาการ)</option>
                                <option data-dept-id="231">OPD CARDIO(ศูนย์หัวใจ)</option>
                                <option data-dept-id="381">OPD COUNTER NURSE (CN คัดกรอง)</option>
                                <option data-dept-id="134">OPD HEAD NECK BREAST(ศุนย์เต้านม)</option>
                                <option data-dept-id="111">OPD MEDICINE(อายุกรรม)</option>
                                <option data-dept-id="181">OPD NEURO (ศูนย์สมอง)</option>
                                <option data-dept-id="161">OPD OB/GYN(ศุนย์สุขภาพหญิง)</option>
                                <option data-dept-id="171">OPD PEDIATRIC( แผนกเด็ก)</option>
                                <option data-dept-id="131">OPD SURGERY(ศัลยกรรม)</option>
                                <option data-dept-id="133">OPD UROLOGY (ทางเดินปัสสาวะ)</option>
                                <option data-dept-id="243">OPERATING ROOM(ห้องผ่าตัด)</option>
                                <option data-dept-id="321">PHARMARCY(เภสัชกรรม ห้องยา)</option>
                                <option data-dept-id="191">PHYATHAI BEAUTY CENTER (PBC ความงาม)</option>
                                <option data-dept-id="331">PHYSICAL THERAPY( กายภาพ)</option>
                                <option data-dept-id="179">PICU</option>
                                <option data-dept-id="193">PWA LIFE CENTER</option>
                                <option data-dept-id="193">PWA ชะลอวัย</option>
                                <option data-dept-id="254">WARD 10</option>
                                <option data-dept-id="174">WARD 11</option>
                                <option data-dept-id="175">WARD 12</option>
                                <option>WARD 14</option>
                                <option data-dept-id="255">WARD 15</option>
                                <option data-dept-id="246">WARD 17</option>
                                <option data-dept-id="164">WARD 7</option>
                                <option data-dept-id="238">WARD 8</option>
                                <option data-dept-id="185">WARD 9</option>
                                <option data-dept-id="301">X-RAY</option>
                                <option data-dept-id="653">รับส่ง</option>
                                <option>ห้องเก็บของชั้น 19</option>
                            </select>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_date">วันที่ซื้อ</label>
                            <input type="text" name="e_date" id="e_date" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_brand">ยี่ห้อ</label>
                            <input type="text" name="e_brand" id="e_brand" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_model">รุ่น</label>
                            <input type="text" name="e_model" id="e_model" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_sn">เลขเครื่อง (SN)</label>
                            <input type="text" name="e_sn" id="e_sn" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_code">หมายเลขเครื่อง (ME Code)</label>
                            <input type="text" name="e_code" id="e_code" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_age">อายุเครื่อง</label>
                            <input type="text" name="e_age" id="e_age" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_price">ราคาซื้อ <span class="text-secondary">(บาท)</span></label>
                            <input type="text" name="e_price" id="e_price" class="form-control">
                        </div>
                        <div class="col-12"></div>
                        <div class="col-md-4 mt-3">
                            <label for="e_repair_price">ค่าซ่อมสะสม <span class="text-secondary">(บาท)</span></label>
                            <input type="text" name="e_repair_price" id="e_repair_price" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_repair_percent">คิดเป็น % ของราคาซื้อ</label>
                            <input type="text" name="e_repair_percent" id="e_repair_percent" class="form-control">
                        </div>
                        <div class="col-12"></div>
                        <div class="col-md-4 mt-3">
                            <label for="consumable">ค่า Accessory & Consumable สะสม <span
                                    class="text-secondary">(บาท)</span></label>
                            <input type="text" name="consumable" id="consumable" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="consumable_percent">คิดเป็น % ของราคาซื้อ</label>
                            <input type="text" name="consumable_percent" id="consumable_percent" class="form-control">
                        </div>

                        <div class="col-12 mt-3">
                            <label for="failure">อาการเสีย</label>
                            <input type="text" name="failure" id="failure" class="form-control">
                        </div>
                        <div class="col-12 mt-3">
                            <label for="result">ผลการตรวจเช็ค</label>
                            <input type="text" name="result" id="result" class="form-control">
                        </div>
                        <div class="col-12 mt-3">
                            <label for="recommend">การดำเนินการ</label>
                            <textarea rows="2" name="recommend" id="recommend" class="form-control"></textarea>
                        </div>
                        <div class="col-12 m-0 p-0">
                            <div class="row m-0 p-0">
                                <div class="col-md-4 mt-3">
                                    <div class="rounded bg-info-subtle d-flex align-items-center justify-content-center btn"
                                        id="e_img_div">
                                        <img height="40" src="https://img.icons8.com/fluency/48/image.png" alt="image"
                                            id="preview-img" />
                                        &nbsp;รูปภาพเครื่อง
                                    </div>
                                </div>
                                <div class="col-md-4 mt-3 ">
                                    <div class="rounded bg-info-subtle d-flex align-items-center justify-content-center btn"
                                        id="e_img_code_div">
                                        <img height="40" src="https://img.icons8.com/fluency/48/image.png" alt="image"
                                            id="preview-img-code" />
                                        &nbsp;รูปภาพโค้ด
                                    </div>
                                </div>
                                <div class="col-md-4 mt-3">
                                    <div class="rounded bg-info-subtle d-flex align-items-center justify-content-center btn"
                                        id="e_img_nameplate_div">
                                        <img height="40" src="https://img.icons8.com/fluency/48/image.png" alt="image"
                                            id="preview-img-nameplate" />
                                        &nbsp;รูปภาพ Nameplate
                                    </div>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="button"
                                        class="btn btn-sm btn-outline-danger bg-danger-subtle mt-3 text-dark"
                                        id="img-only-btn">สร้างเฉพาะรูปภาพ</button>
                                </div>
                            </div>
                        </div>
                        <input type="file" name="e_img_file" id="e_img_file" hidden>

                    </div>
                </section>
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow has-checkboxes">
                    <div class="row justify-content-start align-items-end">
                        <div class="col-12 d-flex align-items-center mt-3">
                            <img src="https://img.icons8.com/color/48/fail.png" alt=" icon" width="50">
                            <h4 class="fw-bold">&nbsp;สาเหตุอาการเสีย</h4>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="cause_of_fail">เลือกสาเหตุ</label>
                            <select name="cause_of_fail" id="cause_of_fail" class="form-select">
                                <option value="" disabled selected>เลือก</option>
                                <option value="cause_of_fail_user" id="cause_of_fail_user">
                                    Users
                                </option>
                                <option value="cause_of_fail_other" id="cause_of_fail_other">
                                    Other
                                </option>
                            </select>
                        </div>
                    </div>
                </section>
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow">
                    <div class="row justify-content-start">
                        <div class="col-12 d-flex align-items-center mt-3">
                            <img src="https://img.icons8.com/cotton/64/red-file--v2.png" alt="icon" width="50">
                            <h4 class="fw-bold">&nbsp;รายละเอียดใบเสนอราคา</h4>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr_vender">Vender</label>
                            <input type="text" name="rr_vender" id="rr_vender" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="quatation_no">เลขใบเสนอราคา</label>
                            <input type="text" name="quatation_no" id="quatation_no" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr_price">ราคาสินค้า/บริการ <span class="text-secondary">(บาท)</span></label>
                            <input type="text" name="rr_price" id="rr_price" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr_vat">ภาษีมูลค่าเพิ่ม 7% <span class="text-secondary">(บาท)</span></label>
                            <input type="text" name="rr_vat" id="rr_vat" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr_grand_price">ราคาทั้งสิ้น <span class="text-secondary">(บาท)</span></label>
                            <input type="text" name="rr_grand_price" id="rr_grand_price" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_current_repair_percent">คิดเป็น % ของราคาเครื่อง <span
                                    class="text-secondary">(บาท)</span></label>
                            <input type="text" name="e_current_repair_percent" id="e_current_repair_percent"
                                class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="delivery">กำหนดส่งของ <span class="text-secondary">(วัน)</span></label>
                            <input type="text" name="delivery" id="delivery" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="valadity">กำหนดยืนราคา <span class="text-secondary">(วัน)</span></label>
                            <input type="text" name="valadity" id="valadity" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="warranty">การรับประกัน <span class="text-secondary">(วัน)</span></label>
                            <input type="text" name="warranty" id="warranty" class="form-control">
                        </div>
                    </div>
                </section>
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow has-checkboxes">
                    <div class="row justify-content-start align-items-end">
                        <div class="col-12 d-flex align-items-center mt-3">
                            <img src="https://img.icons8.com/stickers/100/bank.png" alt=" icon" width="50">
                            <h4 class="fw-bold">&nbsp;ประเภทของค่าใช้จ่ายที่นาเสนอให้ดำเนินการ</h4>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr-cm">เลือกประเภทค่าใช้จ่าย</label>
                            <select name="rr-cm" id="rr-cm" class="form-select">
                                <option value="" disabled selected>เลือก</option>
                                <option value="Accessory" id="Accessory">Accessory</option>
                                <option value="Sparepart" id="Sparepart">Spare part</option>
                                <option value="Component" id="Component">Component</option>
                                <option value="Other" id="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-4 mt-3" style="display: none;">
                            <input type="text" name="rr-cm-other" id="rr-cm-other" class="form-control"
                                placeholder="กรอกข้อมูลกรณีเลือกอื่นๆ">
                        </div>
                    </div>
                </section>
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow has-checkboxes">
                    <div class="row justify-content-start align-items-end">
                        <div class="col-12 d-flex align-items-center mt-3">
                            <img src="https://img.icons8.com/fluency/48/signing-a-document.png" alt=" icon" width="50">
                            <h4 class="fw-bold">&nbsp;ประเภทสัญญาบริการของโรงพยาบาล</h4>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="rr-contract">เลือกประเภทสัญญา</label>
                            <select name="rr-contract" id="rr-contract" class="form-select">
                                <option value="" disabled selected>เลือก</option>
                                <option value="contract_part_include" id="contract_part_include">สัญญาบริการรวมอะไหล่
                                </option>
                                <option value="contract_part_exclude" id="contract_part_exclude">สัญญาบริการไม่รวมอะไหล่
                                </option>
                            </select>
                        </div>
                    </div>
                </section>
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow">
                    <div class="row justify-content-center align-items-start">
                        <div class="col-md-6 mt-3 text-center">
                            <label for="1-file-nsmart">ไฟล์ใบงาน NSmart</label>
                            <input type="file" name="1-file-nsmart" accept="application/pdf" id="1-file-nsmart"
                                class="form-control file">
                            <iframe class="mt-2" frameborder="0" notoolbar=1
                                style="display: none; width: 100%; height: calc(100vw *(1.4142/3.45));"></iframe>
                        </div>
                        <div class="col-md-6 mt-3 text-center">
                            <label for="2-file-quatation">ไฟล์ใบเสนอราคา</label>
                            <input type="file" name="2-file-quatation" id="2-file-quatation" accept="application/pdf"
                                class="form-control file">
                            <iframe class="mt-2" frameborder="0" notoolbar=1
                                style="display: none; width: 100%; height: calc(100vw *(1.4142/3.45));"></iframe>
                        </div>
                    </div>
                </section>
                <div class="row justify-content-center">
                    <div class="col-md-4 mt-3 text-center">
                        <button type="submit" class="btn btn-warning btn-lg shadow" style="min-width: 200px;"><img
                                width="40" src="https://img.icons8.com/3d-fluency/94/pdf.png" alt="pdf" />
                            สร้างไฟล์</button>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-4 mt-3 mb-4 text-center">
                        <a id="a-download" target="_blank" style="display: none;" class="fw-bold">ดาวน์โหลด</a>
                    </div>
                </div>
            </form>
            <div class="container-fluid">
                <iframe id="pdf" style="width: 100%; height: calc(100vw *(1.4142)); display: none;"></iframe>
            </div>
        </div>

    </main>

    <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="autoFillOffCanvas"
        aria-labelledby="autoFillOffCanvasLabel">

        <div class="offcanvas-body container-fluid">
            <div class="alert alert-info" role="alert">
                <div class="row">
                    <div class="col m-0">
                        <input name="console-code" id="console-code" class="form-control" readonly>
                    </div>
                    <div class="col-auto m-0">
                        <button class="btn btn-warning" onclick="copy()"><span id="copy-icon"><img width="20"
                                    src="https://img.icons8.com/cotton/64/documents.png"
                                    alt="documents" /></span>&nbsp;Copy</button>
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <textarea name="input-json" id="input-json" class="form-control" rows="10"
                        placeholder="ข้อมูลจากหน้า Add Update"></textarea>
                </div>
                <div class="col-12">
                    <button class="btn btn-primary w-100" id="input-json-btn"><img width="30"
                            src="https://img.icons8.com/color/48/task--v1.png" alt="task--v1" /> กรอกฟอร์ม</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwQBbvEpNXYqFZBuai4IRpDvy-kR4YeJZFt4KcGdOpMry7SphLRox1JL233Io7jYxfFeA/exec'
        var form_pdf_bytes, font_bytes, signature_bytes, e_img_bytes, e_img_code_bytes, e_img_nameplate_bytes
        $(document).ready(async function () {
            form_pdf_bytes = await fetch('./formRR.pdf').then(res => res.arrayBuffer())
            font_bytes = await fetch('../teampm/THSarabun.ttf').then(res => res.arrayBuffer())
            // read text from file
            let text = await fetch('./console.js').then(res => res.text())
            $('#console-code').val(text)
            // if no decimal mask input with localestring else mask with 2 decimal
            let mask_options = {
                reverse: true,
                onKeyPress: function (cep, e, field, options) {
                    calRepairPricePercent()
                    calConsumablePercent()
                    calCurrentRepairPercent()
                }
            }
            let mask_options2 = {
                reverse: true,
                onKeyPress: function (cep, e, field, options) {
                    calConsumablePercent()
                }
            }
            let mask_options3 = {
                reverse: true,
                onKeyPress: function (cep, e, field, options) {
                    // calCurrentRepairPercent()
                }
            }
            $('#e_price, #e_repair_price').mask('#,##0.00', mask_options)
            $('#consumable').mask('#,##0.00', mask_options2)
            $('#rr_price, #rr_vat, #rr_grand_price').mask('#,##0.00', mask_options3)

        })
        $('#search-form').submit(function () {
            event.preventDefault()
            let search = $('#search-input').val()
            if (search == '') {
                return
            }
            Swal.fire({
                icon: 'info',
                title: 'กำลังค้นหา',
                text: 'กรุณารอสักครู่',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            $.getJSON(scriptUrl + '?action=search&search=' + search, function (data) {
                console.log(data);
                if (data.status != 'success') {
                    Swal.fire({
                        icon: 'error',
                        title: 'ไม่พบข้อมูล',
                        text: 'กรุณาตรวจสอบรหัสอีกครั้ง',
                        confirmButtonText: 'ตกลง',
                    })
                    return
                }
                Swal.fire({
                    icon: 'success',
                    title: 'พบข้อมูล',
                    timer: 1000,
                })
                Object.keys(data.data).forEach(key => {
                    let element = $('[name="' + key + '"]')
                    if (element.attr('type') == 'checkbox') {
                        if (data.data[key] == '✓') {
                            element.prop('checked', true)
                        } else {
                            element.prop('checked', false)
                        }
                    } else {
                        fillValue(key, data.data[key])
                    }
                })
                // show pdf in new tab
                let base64 = data.pdf.base64
                let type = data.pdf.type
                let dataurl = 'data:' + type + ';base64,' + base64
                let blob = base64ToBlob(base64, type)
                let blobUrl = URL.createObjectURL(blob) + '#toolbar=1&view=fit'
                $('#download-from-search-btn').attr('href', blobUrl).attr('target', '_blank').parent().removeClass('d-none')

            })

        })

        function base64ToBlob(base64, type) {
            {
                let binary = atob(base64)
                let array = []
                for (let i = 0; i < binary.length; i++) {
                    array.push(binary.charCodeAt(i))
                }
                return new Blob([new Uint8Array(array)], { type: type })
            }
        }

        $('#dept option').not(':disabled').each(function () {
            $(this).val($(this).text());
        });
        $('#input-json').on('keyup', function () {
            // detect enter key
            if (event.keyCode == 13) {
                $('#input-json-btn').click()
            }
        })
        $('#name').change(async function () {
            let name = $(this).val()
            signature_bytes = await fetch('../img_sign/' + name.replace(/ /g, '_') + '.png').then(res => res.arrayBuffer())

        })
        $('#rr-cm').change(function () {
            let val = $(this).val()
            if (val == 'Other') {
                $('#rr-cm-other').parent().show()
            } else {
                $('#rr-cm-other').parent().hide()
            }
        })
        function calRepairPricePercent() {
            let price = $('#e_price').val().toString().replace(/,/g, '')
            console.log("🚀 !! price:", price)
            let repair_price = $('#e_repair_price').val().toString().replace(/,/g, '')
            price = Number(price)
            repair_price = Number(repair_price)
            let percent = 0
            if (price == '' || price == NaN || price == undefined || price == null) {
                price = 0
                repair_price = 0
                percent = 0
            }
            else if (repair_price == '' || repair_price == NaN || repair_price == undefined || repair_price == null) {
                repair_price = 0
                percent = 0
            } else {
                percent = (repair_price / price) * 100
            }
            console.log("🚀 !! price:", price)
            console.log("🚀 !! repair_price:", repair_price)
            $('#e_repair_percent').val(percent.toFixed(2))
        }
        function calConsumablePercent() {
            let price = $('#e_price').val().toString().replace(/,/g, '')
            let consumable = $('#consumable').val().toString().replace(/,/g, '')
            price = Number(price)
            console.log("🚀 !! price:", price)
            consumable = Number(consumable)
            console.log("🚀 !! consumable:", consumable)
            let percent = 0
            if (price == '' || price == NaN || price == undefined || price == null) {
                price = 0
                consumable = 0
                percent = 0
            }
            else if (consumable == '' || consumable == NaN || consumable == undefined || consumable == null) {
                consumable = 0
                percent = 0
            } else {
                percent = (consumable / price) * 100
            }
            console.log("🚀 !! price:", price)
            console.log("🚀 !! consumable:", consumable)
            $('#consumable_percent').val(percent.toFixed(2))
        }
        function calCurrentRepairPercent() {
            let price = $('#e_price').val().toString().replace(/,/g, '')
            let rr_grand_price = $('#rr_grand_price').val().toString().replace(/,/g, '')
            price = Number(price)
            console.log("🚀 !! price:", price)
            rr_grand_price = Number(rr_grand_price)
            console.log("🚀 !! rr_grand_price:", rr_grand_price)
            let percent = 0
            if (price == '' || price == NaN || price == undefined || price == null) {
                price = 0
                rr_grand_price = 0
                percent = 0
            }
            else if (rr_grand_price == '' || rr_grand_price == NaN || rr_grand_price == undefined || rr_grand_price == null) {
                rr_grand_price = 0
                percent = 0
            } else {
                percent = (rr_grand_price / price) * 100
            }
            console.log("🚀 !! price:", price)
            console.log("🚀 !! rr_grand_price:", rr_grand_price)
            $('#e_current_repair_percent').val(percent.toFixed(2))
        }

        $('#img-only-btn').click(async function () {
            const embedImage = async function (bytes, key) {
                let preview, e_img
                switch (key) {
                    case 'e_img_file':
                        preview = $('#preview-img')
                        break;
                    case 'e_img_code_file':
                        preview = $('#preview-img-code')
                        break;
                    case 'e_img_nameplate_file':
                        preview = $('#preview-img-nameplate')
                        break;
                    default:
                        break;
                }
                if (preview.attr('data-type') == 'png') {
                    e_img = await pdfDoc.embedPng(bytes)
                } else if (preview.attr('data-type') == 'jpg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                } else if (preview.attr('data-type') == 'jpeg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                }
                return e_img
            }
            $.LoadingOverlay("show");
            event.preventDefault()

            if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
            var form = pdfDoc.getForm()
            let imgs_obj = {}
            if (e_img_bytes) {
                console.log('aa');
                imgs_obj['e_img'] = await embedImage(e_img_bytes, 'e_img_file')
            }
            if (e_img_code_bytes) {
                imgs_obj['e_img_code'] = await embedImage(e_img_code_bytes, 'e_img_code_file')
            }
            if (e_img_nameplate_bytes) {
                imgs_obj['e_img_nameplate'] = await embedImage(e_img_nameplate_bytes, 'e_img_nameplate_file')
            }
            if (imgs_obj['e_img']) form.getTextField('e_img').setImage(imgs_obj['e_img'])
            if (imgs_obj['e_img_code']) form.getTextField('e_img_code').setImage(imgs_obj['e_img_code'])
            if (imgs_obj['e_img_nameplate']) form.getTextField('e_img_nameplate').setImage(imgs_obj['e_img_nameplate'])
            form.flatten()
            // remove first page
            pdfDoc.removePage(0)
            var pdfBytes = await pdfDoc.save()
            var pdfdatauri = await pdfDoc.saveAsBase64({ dataUri: true })
            $.LoadingOverlay("hide");
            Swal.fire({
                icon: 'success',
                title: 'สร้างไฟล์เสร็จสิ้น',
                timer: 2000,
                showConfirmButton: false,
            }).then(async () => {
                var iframe = document.getElementById('pdf')
                // open pdf in new small window
                var blob = new Blob([pdfBytes], { type: 'application/pdf' })
                var url = URL.createObjectURL(blob)
                iframe.src = url + '#toolbar=1&view=fitH'
                let e_code = $('#e_code').val() ? $('#e_code').val() : 'no_code'
                let e_name = $('#e_name').val() ? $('#e_name').val() : 'no_name'
                let dept = $('#dept').val() ? $('#dept').val() : 'no_department'
                let name = 'IMAGE-ONLY-' + e_code + '-' + e_name + '-' + dept + '.pdf'
                $(iframe).show(200)
                $('#a-download').attr('href', url)
                $('#a-download').attr('download', name).show()
                // scroll to pdf
                $('html, body').animate({
                    scrollTop: $(iframe).offset().top
                }, 500);
                pdfDoc = await PDFDocument.load(form_pdf_bytes)
                $('#1-file-nsmart, #2-file-quatation').change()

            })

        })

        $('#pr-cm').change(function () {
            let data_id = $(this).find('option:selected').attr('id')
            $(this).attr('data-id', data_id)
            if (data_id == 'rr_cm_maintenance') {
                $('#rr_cm_maintenance_ea').val('1').parent().show()
            } else {
                $('#rr_cm_maintenance_ea').val('').parent().hide()
            }
            if (data_id == 'rr_cm_other') {
                showOtherFieldInput('rr_cm_other_text')
            } else {
                $('#rr_cm_other_text').val('').parent().hide()
            }

        })
        $('#pr-status').change(function () {
            let data_id = $(this).find('option:selected').attr('id')
            $(this).attr('data-id', data_id)
            if (data_id == 'rr_status_other') {
                showOtherFieldInput('rr_status_other_text')
            } else {
                $('#rr_status_other_text').val('').parent().hide()
            }
        })
        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('click', function () {
            $('#e_img_file').attr('data-id', $(this).attr('id')).click()
        })

        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('dragover', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('bg-info-subtle').addClass('text-bg-info')
        })
        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('dragleave', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('text-bg-info').addClass('bg-info-subtle')
        })

        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('drop', function (e) {
            e.preventDefault()
            e.stopPropagation()
            let dataID = $(this).attr('id')
            $('#e_img_file').attr('data-id', dataID)

            let preview = $('#' + dataID + ' img')
            $('#' + dataID).LoadingOverlay('show')
            // check if file is url
            if (e.originalEvent.dataTransfer.getData('text/uri-list')) {
                // $('#' + dataID).LoadingOverlay('hide')
                // Swal.fire({
                //     icon: 'warning',
                //     title: 'ผิดพลาด',
                //     text: 'เนื่องจาก NSmart ป้องกันการดึงภาพโดยตรง กรุณาบันทึกภาพลงคอมพิวเตอร์ และเลือกจากคอมพิวเตอร์เท่านั้น',
                //     confirmButtonText: 'ตกลง',
                // })
                // return


                preview.attr('src', e.originalEvent.dataTransfer.getData('text/uri-list'))
                // check if src is base64
                if (preview.attr('src').includes('base64')) {
                    let base64 = preview.attr('src').split(',')[1]
                    let type = preview.attr('src').split(';')[0].split(':')[1]
                    let file = new File([base64ToArrayBuffer(base64)], 'filename.' + preview.attr('src').split(',')[0].split('/')[1].split(';')[0], {
                        type: type,
                        lastModified: Date.now()
                    })
                    compressImage(file, dataID, preview)
                    return
                }
            }
            let file = e.originalEvent.dataTransfer.files[0]
            if (!file) {
                return
            }
            compressImage(file, dataID, preview)
        })

        $('#e_img_file').change(function () {
            let dataID = $('#e_img_file').attr('data-id')
            let preview = $('#' + dataID + ' img')
            $('#' + dataID).LoadingOverlay('show')
            let file = $(this)[0].files[0]
            let quality = getCompressionQuality(file)
            new Compressor(file, {
                quality: quality,

                // The compression process is asynchronous,
                // which means you have to access the `result` in the `success` hook function.
                success(result) {
                    let reader = new FileReader()

                    reader.onloadend = function (e) {
                        preview.attr('src', e.target.result).attr('data-type', file.type.split('/')[1])
                        setImageBytes(dataID, e.target.result)
                        $('#' + dataID).LoadingOverlay('hide')

                    }
                    reader.readAsDataURL(result)
                },
                error(err) {
                    console.log(err.message);
                },
            });
        })
        // $('#autoFillOffCanvas').offcanvas('show')

        $('#rr_price').on('keyup', function () {
            let price = Number($(this).val().replace(/,/g, ''))
            let vat = price * 0.07
            let total = price * 1.07
            if (isNaN(price)) return
            if (isNaN(vat)) return
            if (isNaN(total)) return
            $('#rr_vat').val(vat.toFixed(2).split('.').map(function (item, idx) {
                return idx > 0 ? item.padStart(2, '0') : Number(item).toLocaleString()
            }).join('.'))
            $('#rr_grand_price').val(total.toFixed(2).split('.').map(function (item, idx) {
                return idx > 0 ? item.padStart(2, '0') : Number(item).toLocaleString()
            }).join('.'))
            calCurrentRepairPercent()
        })
        $('#rr_vat').on('keyup', function () {
            let vat = Number($(this).val().replace(/,/g, ''))
            let total = Number($('#rr_price').val()) + Number(vat)
            if (isNaN(vat)) return
            if (isNaN(total)) return
            $('#rr_grand_price').val(total.toFixed(2).split('.').map(function (item, idx) {
                return idx > 0 ? item.padStart(2, '0') : Number(item).toLocaleString()
            }).join('.'))
            calCurrentRepairPercent()
        })

        $('#rr_grand_price').on('keyup', function () {
            let grand_price = Number($(this).val().replace(/,/g, ''))
            console.log("🚀 !! grand_price:", grand_price)
            let price = grand_price / 1.07
            let vat = grand_price - price
            if (isNaN(grand_price)) return
            if (isNaN(price)) return
            if (isNaN(vat)) return
            $('#rr_price').val(price.toFixed(2).split('.').map(function (item, idx) {
                return idx > 0 ? item.padStart(2, '0') : Number(item).toLocaleString()
            }).join('.'))
            $('#rr_vat').val(vat.toFixed(2).split('.').map(function (item, idx) {
                return idx > 0 ? item.padStart(2, '0') : Number(item).toLocaleString()
            }).join('.'))
            calCurrentRepairPercent()
        })

        function showOtherFieldInput(key) {
            Swal.fire({
                title: 'ระบุ อื่นๆ',
                input: 'text',
                inputLabel: 'ระบุ',
                inputPlaceholder: 'ระบุ',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'กรุณากรอกข้อมูล'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#' + key).val(result.value).parent().show()
                }
            })
        }

        function base64ToArrayBuffer(base64) {
            var binaryString = atob(base64);
            var bytes = new Uint8Array(binaryString.length);
            for (var i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            return bytes.buffer;
        }

        function getCompressionQuality(file) {
            let quality = 0.3
            switch (true) {
                case file.size / 1024 <= 200:
                    quality = 0.8
                    break;

                case file.size / 1024 <= 600:
                    quality = 0.6
                    break;

                case file.size / 1024 <= 2000:
                    quality = 0.4
                    break;
                default:
                    quality = 0.3
                    break;
            }
            return quality
        }

        function setImageBytes(dataID, file) {
            if (typeof file == 'string') file = base64ToArrayBuffer(file.split(',')[1])
            switch (dataID) {
                case 'e_img_div':
                    e_img_bytes = file
                    break;
                case 'e_img_code_div':
                    e_img_code_bytes = file
                    break;
                case 'e_img_nameplate_div':
                    e_img_nameplate_bytes = file
                    break;
                default:
                    break;
            }
        }
    </script>
    <script>
        var pdfDoc
        var PDFDocument = PDFLib.PDFDocument;
        var StandardFonts = PDFLib.StandardFonts;
        var pdfFiles = []
        $('#1-file-nsmart, #2-file-quatation').on('dragover', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).addClass('text-bg-info')
        })
        $('#1-file-nsmart, #2-file-quatation').on('dragleave', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('text-bg-info')
        })
        $('#1-file-nsmart, #2-file-quatation').on('drop', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('from-control-lg')
            let files = e.originalEvent.dataTransfer.files
            let file = files[0]
            if (!file) return;
            // set files to $(this)
            $(this).prop('files', files)
            renderNsmartFile(file, $(this))
        })

        $('#1-file-nsmart, #2-file-quatation').on('change', function (e) {
            let files = e.target.files
            let file = files[0]
            if (!file) return;
            renderNsmartFile(file, $(this))
        })

        function renderNsmartFile(file, ele) {
            if (file.type != 'application/pdf') {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกไฟล์ PDF',
                    text: 'ไฟล์ที่เลือกไม่ใช่ PDF',
                })
                return
            }
            if (file.size > 10000000) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไฟล์มีขนาดใหญ่เกินไป',
                    text: 'ไฟล์มีขนาดใหญ่เกิน 10 MB',
                })
                return
            }
            let obj = $(ele)
            let id = obj.attr('id')
            let reader = new FileReader()
            reader.onloadend = async function (e) {
                if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
                pdfFiles[id] = e.target.result
                // load pdf
                let pdf = await PDFDocument.load(e.target.result)
                let pages = pdf.getPages().length
                for (var i = 0; i < pages; i++) {
                    let [page] = await pdfDoc.copyPages(pdf, [i])
                    pdfDoc.insertPage(1, page)
                }
                pdf = await pdf.save()
                let iframe = $(obj).parent().find('iframe')[0]
                var blob = new Blob([pdf], {
                    type: 'application/pdf'
                })
                var url = URL.createObjectURL(blob)
                iframe.src = url + '#toolbar=1&view=fitH'

                $(iframe).show()

            }
            reader.readAsArrayBuffer(file);
        }

        $('#myForm').submit(async function () {
            const embedImage = async function (bytes, key) {
                let preview, e_img
                switch (key) {
                    case 'e_img_file':
                        preview = $('#preview-img')
                        break;
                    case 'e_img_code_file':
                        preview = $('#preview-img-code')
                        break;
                    case 'e_img_nameplate_file':
                        preview = $('#preview-img-nameplate')
                        break;
                    default:
                        break;
                }
                if (preview.attr('data-type') == 'png') {
                    e_img = await pdfDoc.embedPng(bytes)
                } else if (preview.attr('data-type') == 'jpg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                } else if (preview.attr('data-type') == 'jpeg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                }
                return e_img
            }
            $.LoadingOverlay("show");
            event.preventDefault()

            if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
            var form = pdfDoc.getForm()
            pdfDoc.registerFontkit(fontkit);
            const sarabun = await pdfDoc.embedFont(font_bytes, { subset: true })
            const symbol = await pdfDoc.embedFont(StandardFonts.ZapfDingbats, { subset: true })
            var signature, e_img
            if (signature_bytes) {
                signature = await pdfDoc.embedPng(signature_bytes)
            }
            let imgs_obj = {}
            if (e_img_bytes) {
                imgs_obj['e_img'] = await embedImage(e_img_bytes, 'e_img_file')
            }
            if (e_img_code_bytes) {
                imgs_obj['e_img_code'] = await embedImage(e_img_code_bytes, 'e_img_code_file')
            }
            if (e_img_nameplate_bytes) {
                imgs_obj['e_img_nameplate'] = await embedImage(e_img_nameplate_bytes, 'e_img_nameplate_file')
            }
            const setText = (inputId, pdfElementId) => {
                let val = $('#' + inputId).val()
                if (val == '' || val == null || val == undefined) return
                let pdfElement = form.getTextField(pdfElementId)
                if (pdfElement.isMultiline()) {
                    pdfElement.setLineHeight(0.5)
                }
                else if (val.length >= 45) pdfElement.setFontSize(10)
                else if (val.length >= 35) pdfElement.setFontSize(11)
                else if (val.length >= 29) pdfElement.setFontSize(12)
                pdfElement.setText(val)
            }
            form.getTextField('date').setText(new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
            }))
            setText('e_dept', 'e_dept')
            setText('e_dept', 'e_dept_2')
            setText('e_name', 'e_name')
            form.getTextField('quotation').setText(toTitleCase($('#rr_vender').val()) + ' (ใบเสนอราคาเลขที่ ' + $('#quatation_no').val() + ')')
            if ($('#e_dept').val() != null && $('#e_dept').val() != undefined && $('#e_dept').val() != '') {
                if ($('#e_dept option:selected').data('dept-id') && $('#e_dept option:selected').data('dept-id') != '') form.getTextField('dept_no').setText($('#e_dept option:selected').data('dept-id').toString())
            }

            $('form input, form select, form textarea').not('input[type="search"]').each(function () {
                let _this = $(this)
                if (_this.val() == '' || _this.prop('id') == '' || _this.val() == null || _this.val() == undefined) return
                if (['e_manufacturer', 'e_img_file', '1-file-nsmart', '2-file-quatation', 'e_date', 'e_name', 'rr_vender', 'quatation_no', 'rr-cm-other', 'e_dept', 'cause_of_fail'].includes(_this.prop('id'))) return
                if (_this.prop('id') == 'rr-cm' || _this.prop('id') == 'rr-contract') {
                    let v = _this.find('option:selected').val()
                    if (v == '') return
                    form.getTextField(v).setText('✓')
                    if (v == 'Other') {
                        form.getTextField('rr_cm_other_text').setText($('#rr-cm-other').val())
                    }
                    return
                }
                if (_this.prop('id') == 'e_brand/model') {
                    if (_this.val() == '') return
                    let val = _this.val().split('/')
                    form.getTextField('e_brand').setText(val[0])
                    form.getTextField('e_model').setText(val[1])
                    return
                }
                if (_this.prop('id') == 'rr_grand_price') {
                    form.getTextField('total_text').setText(ArabicNumberToText(Number(_this.val().toString().replace(/,/g, ''))))
                }
                if (['delivery', 'valadity', 'warranty'].includes(_this.prop('id'))) {
                    return form.getTextField(_this.prop('id')).setText(_this.val() + ' วัน')
                }
                if (_this.prop('id') == 'recommend') {
                    let reccommend = _this.val().split('\n')
                    let formElement = form.getTextField(_this.prop('id'))
                    if (reccommend.length == 1) {
                        formElement.setFontSize(14)
                    } else if (reccommend.length == 2) {
                        formElement.setFontSize(12)
                    } else {
                        formElement.setFontSize(10)
                    }
                    return formElement.setText(_this.val())
                }
                console.log(_this.prop('id'));
                form.getTextField(_this.prop('id')).setText(_this.val())
            })

            // $('#e_price, #e_repair_price #consumable').each(function () {
            //     if ($(this).val() == '') return
            //     let val = $(this).val().replace(/,/g, '')
            //     let pdfElement = form.getTextField($(this).prop('id'))
            //     console.log("🚀 !! $(this).prop('id'):", $(this).prop('id'))
            //     console.log($(this).val(),$(this).val().length);
            //     if ($(this).val().length >= 12) pdfElement.setFontSize(7)
            //     else if ($(this).val().length >= 11) pdfElement.setFontSize(8)
            //     else if ($(this).val().length >= 10) pdfElement.setFontSize(6)
            //     else if ($(this).val().length >= 9) pdfElement.setFontSize(11)
            //     else if ($(this).val().length > 7) pdfElement.setFontSize(12)
            //     pdfElement.setText($(this).val())
            // })

            $('.has-checkboxes option').each(function () {
                if ($(this).prop('id') == '') {
                    return
                }
                if ($(this).is(':selected')) {
                    let textField = form.getTextField($(this).prop('id'))
                    textField.setText('✓')
                    textField.updateAppearances(symbol)

                } else {
                    form.getTextField($(this).prop('id')).setText('')
                }
            })
            if (signature && $('#name').val() == 'DARANPHOP YIMYAM') form.getTextField('bme_sign').setImage(signature)
            if (imgs_obj['e_img']) form.getTextField('e_img').setImage(imgs_obj['e_img'])
            if (imgs_obj['e_img_code']) form.getTextField('e_img_code').setImage(imgs_obj['e_img_code'])
            if (imgs_obj['e_img_nameplate']) form.getTextField('e_img_nameplate').setImage(imgs_obj['e_img_nameplate'])
            form.updateFieldAppearances(sarabun);
            form.flatten()
            if (!e_img_bytes && !e_img_code_bytes && !e_img_nameplate_bytes) {
                // remove last page
                pdfDoc.removePage(pdfDoc.getPages().length - 1)
            }
            var pdfBytes = await pdfDoc.save()
            var pdfdatauri = await pdfDoc.saveAsBase64({ dataUri: true })
            let form_obj = {}
            $('#myForm input:not([type="file"]), select').each(function () {
                form_obj[$(this).attr('name')] = $(this).val()
            })
            form_obj['pdfFile'] = pdfdatauri
            $.ajax({
                url: scriptUrl,
                type: 'POST',
                data: {
                    opt: 'save',
                    form_obj: JSON.stringify(form_obj)
                }
            })
            $.LoadingOverlay("hide");
            Swal.fire({
                icon: 'success',
                title: 'สร้างไฟล์เสร็จสิ้น',
                timer: 2000,
                showConfirmButton: false,
            }).then(async () => {
                var iframe = document.getElementById('pdf')
                // open pdf in new small window
                var blob = new Blob([pdfBytes], { type: 'application/pdf' })
                var url = URL.createObjectURL(blob)
                iframe.src = url + '#toolbar=1&view=fitH'
                let e_code = $('#e_code').val() ? $('#e_code').val() : 'no_code'
                let e_name = $('#e_name').val() ? $('#e_name').val() : 'no_name'
                let dept = $('#e_dept').val() ? $('#e_dept').val() : 'no_department'
                let rr_no = $('#rr_no').val()
                let name = 'RR_' + rr_no.split('_').slice(1).join('_') + '_' + e_name + ', ' + dept + '.pdf'
                $(iframe).show(200)
                $('#a-download').attr('href', url)
                $('#a-download').attr('download', name).show()
                // scroll to pdf
                $('html, body').animate({
                    scrollTop: $(iframe).offset().top
                }, 500);
                pdfDoc = await PDFDocument.load(form_pdf_bytes)
                $('#1-file-nsmart, #2-file-quatation').change()

            })
            // $('#a-download').attr('href', pdfDataUri)
            // $('#a-download').attr('download', name).show()
        })
        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }

        function compressImage(file, dataID, preview) {
            let quality = getCompressionQuality(file)
            new Compressor(file, {
                quality: quality,
                success(result) {
                    let fr = new FileReader()
                    fr.onload = function (e) {
                        setImageBytes(dataID, e.target.result)
                        preview.attr('data-type', file.type.split('/')[1])
                        $('#' + dataID).LoadingOverlay('hide')
                    }
                    fr.readAsDataURL(result)
                },
                error(err) {
                    console.log(err.message);
                },
            });
        }
    </script>
    <script>
        function copy() {
            let str = $('#console-code').val()

            // copy to clipboard

            $('#console-code')[0].select()
            document.execCommand("copy")
            let Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: false
            })
            Toast.fire({
                icon: 'success',
                title: 'คัดลอกสำเร็จ'
            })
            console.groupEnd()
            let starttime = new Date()
            let checkdata = setInterval(() => {
                // if interval more than 10 sec, clear interval
                if (new Date() - starttime > (1000 * 60 * 5)) {
                    clearInterval(checkdata)
                    return
                }
                // read data from clipboard
                if (!document.hasFocus()) return
                navigator.clipboard.readText().then(clipText => {
                    // check if data is json
                    try {
                        let obj = JSON.parse(clipText)
                        if (!obj.page) return
                        clearInterval(checkdata)
                        $('#input-json').val(clipText)
                        $('#input-json-btn').click()
                        // delete data from clipboard
                        navigator.clipboard.writeText('')
                    } catch (error) {
                    }
                })
            }, 1000);
        }

        $('#input-json-btn').click(function () {
            let json_text = $('#input-json').val()
            let obj = JSON.parse(json_text)
            console.log("🚀 !! obj:", obj)
            if (obj.page == 'addupdate') {
                Object.keys(obj).forEach(key => {
                    fillValue(key, obj[key])
                })
                if (obj.imgs) {
                    let imgs = JSON.parse(obj.imgs)
                    if (imgs.length > 0) {
                        $('#imgs_row, #head_imgs_row').remove()
                        let head_row = $('<div>').addClass('row mt-3 g-3').attr('id', 'head_imgs_row')
                        let row = $('<div>').addClass('row mt-2 g-3').attr('id', 'imgs_row')
                        head_row.append($('<div>').addClass('col-12 text-center').append($('<h5>').text('ลากภาพใส่ช่องที่ต้องการ')))
                        imgs.forEach(img => {
                            let col = $('<div>').addClass('col-2')
                            let imgEle = $('<img>').addClass('img-fluid nsmart-img').attr('src', img).attr('loading', 'lazy')
                            col.append(imgEle)
                            row.append(col)
                        })
                        $('#e_name').closest('section').append(head_row).append(row)
                    }
                }
                // fillValue('e_name', obj.name)
                // fillValue('dept', obj.dept)
                // fillValue('e_manufacturer', obj.brand)
                // fillValue('e_date', obj.recieve_date)
                // fillValue('e_hospital_code', obj.hos_id)
                // fillValue('e_brand/model', ['/', obj.brand, obj.model])
                // fillValue('e_brand/distributor', obj.sup_sale)
                // fillValue('e_sn', obj.sn_no)
                // fillValue('e_code', obj.id)
                // fillValue('e_price', obj.price)
                // fillValue('rr_vender', obj.rr_vender)
            } else if (obj.page == 'closejob') {
                fillValue('rr_no', obj.quatation)
                fillValue('rr_price', obj.base_price)
                fillValue('rr_vat', obj.vat)
                fillValue('rr_grand_price', obj.price)
                fillValue('job_id', obj.job_no)
            }

            $('#input-json').val('')
            $('#autoFillOffCanvas').offcanvas('hide')
        })

        function fillValue(id, value) {
            if (Array.isArray(value)) {
                let chain = value.shift()
                value = value.map((v) => {
                    return v ? v : ''
                })
                return fillValue(id, value.join(chain))

            }
            if (!value || value == '') value = 'N/A'
            $('[id="' + id + '"]').val(value).addClass('bg-primary-subtle')
        }

        // "use strict";

        function ThaiNumberToText(Number) {
            Number = Number.replace(/๐/gi, '0');
            Number = Number.replace(/๑/gi, '1');
            Number = Number.replace(/๒/gi, '2');
            Number = Number.replace(/๓/gi, '3');
            Number = Number.replace(/๔/gi, '4');
            Number = Number.replace(/๕/gi, '5');
            Number = Number.replace(/๖/gi, '6');
            Number = Number.replace(/๗/gi, '7');
            Number = Number.replace(/๘/gi, '8');
            Number = Number.replace(/๙/gi, '9');
            return ArabicNumberToText(Number);
        }

        function ArabicNumberToText(Number) {
            console.log("🚀 !! Number:", Number)
            if (typeof Number == 'string') Number = parseFloat(Number.replace(/,/g, ''))
            var Number = CheckNumber(Number);
            var NumberArray = new Array("ศูนย์", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า", "สิบ");
            var DigitArray = new Array("", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน");
            var BahtText = "";
            if (isNaN(Number)) {
                return "ข้อมูลนำเข้าไม่ถูกต้อง";
            } else {
                if ((Number - 0) > 9999999.9999) {
                    return "ข้อมูลนำเข้าเกินขอบเขตที่ตั้งไว้";
                } else {
                    Number = Number.split(".");
                    if (Number[1].length > 0) {
                        Number[1] = Number[1].substring(0, 2);
                    }
                    var NumberLen = Number[0].length - 0;
                    for (var i = 0; i < NumberLen; i++) {
                        var tmp = Number[0].substring(i, i + 1) - 0;
                        if (tmp != 0) {
                            if ((i == (NumberLen - 1)) && (tmp == 1)) {
                                BahtText += "เอ็ด";
                            } else
                                if ((i == (NumberLen - 2)) && (tmp == 2)) {
                                    BahtText += "ยี่";
                                } else
                                    if ((i == (NumberLen - 2)) && (tmp == 1)) {
                                        BahtText += "";
                                    } else {
                                        BahtText += NumberArray[tmp];
                                    }
                            BahtText += DigitArray[NumberLen - i - 1];
                        }
                    }
                    BahtText += "บาท";
                    if ((Number[1] == "0") || (Number[1] == "00")) {
                        BahtText += "ถ้วน";
                    } else {
                        DecimalLen = Number[1].length - 0;
                        for (var i = 0; i < DecimalLen; i++) {
                            var tmp = Number[1].substring(i, i + 1) - 0;
                            if (tmp != 0) {
                                if ((i == (DecimalLen - 1)) && (tmp == 1)) {
                                    BahtText += "เอ็ด";
                                } else
                                    if ((i == (DecimalLen - 2)) && (tmp == 2)) {
                                        BahtText += "ยี่";
                                    } else
                                        if ((i == (DecimalLen - 2)) && (tmp == 1)) {
                                            BahtText += "";
                                        } else {
                                            BahtText += NumberArray[tmp];
                                        }
                                BahtText += DigitArray[DecimalLen - i - 1];
                            }
                        }
                        BahtText += "สตางค์";
                    }
                    console.log("🚀 !! BahtText:", BahtText)
                    return BahtText;
                }
            }
        }

        function CheckNumber(Number) {
            var decimal = false;
            Number = Number.toString();
            Number = Number.replace(/ |,|บาท|฿/gi, '');
            for (var i = 0; i < Number.length; i++) {
                if (Number[i] == '.') {
                    decimal = true;
                }
            }
            if (decimal == false) {
                Number = Number + '.00';
            }
            return Number
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-mask-plugin@1.14.16/dist/jquery.mask.min.js"></script>
</body>

</html>