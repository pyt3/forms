<!DOCTYPE html>
<html lang="th">

<head>
    <!-- no cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- no cache -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบบันทึกการตรวจรับเครื่องมือทางการแพทย์</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
    <script src="https://fastly.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary-color: #10b981;
            --secondary-dark: #059669;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Thai', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }


        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 0;
            border-radius: 20px;
            box-shadow: var(--shadow-xl), 0 0 0 1px rgba(255, 255, 255, 0.1);
            /* overflow: hidden; */
            position: relative;
            z-index: 1;
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            padding: 40px 30px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .form-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .form-header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .form-title {
            text-align: center;
            margin: 0;
            font-weight: 700;
            font-size: 28px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-subtitle {
            text-align: center;
            margin-top: 8px;
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .form-body {
            padding: 40px 30px;
        }

        .info-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        .section-header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .section-header-wrapper .section-title {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
            flex: 1;
        }

        .btn-download-pdf {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            white-space: nowrap;
        }

        .btn-download-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        .btn-download-pdf:active {
            transform: translateY(0);
        }

        .btn-download-pdf i {
            font-size: 16px;
        }

        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--text-dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-group label i {
            font-size: 12px;
            color: var(--primary-color);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            padding-left: 40px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .form-group input:hover {
            border-color: var(--primary-light);
        }

        .form-group {
            position: relative;
        }

        .form-group .input-icon {
            position: absolute;
            left: 14px;
            top: 41px;
            color: var(--text-light);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus+.input-icon {
            color: var(--primary-color);
        }

        /* Search input wrapper with button */
        .input-with-search {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        .input-with-search>div {
            position: relative;
            flex: 1;
        }

        .input-with-search input {
            width: 100%;
            padding-right: 16px;
        }

        .input-with-search .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .input-with-search input:focus+.input-icon {
            color: var(--primary-color);
        }

        .btn-search {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
        }

        .btn-search:active {
            transform: translateY(0);
        }

        .btn-search i {
            font-size: 16px;
        }

        .btn-search:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile: Hide input icons for cleaner look */
        @media (max-width: 768px) {
            .form-group input {
                padding-left: 16px;
            }

            .form-group .input-icon {
                display: none;
            }

            .input-with-search {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .input-with-search>div {
                width: 100%;
            }

            .input-with-search input {
                width: 100%;
                padding-left: 16px;
            }

            .btn-search {
                width: 100%;
                justify-content: center;
            }
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .checklist-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
            background: white;
        }

        .checklist-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .checklist-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            font-size: 13px;
            border-bottom: 2px solid var(--primary-dark);
        }

        .checklist-table th:first-child {
            text-align: center;
            width: 60px;
        }

        .checklist-table th:nth-child(3),
        .checklist-table th:nth-child(4) {
            text-align: center;
            width: 70px;
        }

        .checklist-table th:last-child {
            width: 200px;
        }

        .checklist-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
            font-size: 14px;
        }

        .checklist-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .checklist-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .checklist-table tbody tr:last-child td {
            border-bottom: none;
        }

        .checklist-table tbody tr.mandatory-row {
            position: relative;
        }

        .checklist-table tbody tr.mandatory-row td:first-child {
            color: var(--danger-color);
            font-weight: 600;
        }

        .checklist-table tbody tr.completed {
            background-color: #f0fdf4;
        }

        .checklist-table td:first-child {
            text-align: center;
            font-weight: 700;
            position: relative;
        }

        .checklist-table td:first-child::before {
            content: attr(data-number);
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            min-width: 32px;
            height: 32px;
            line-height: 32px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            padding: 0 8px;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .checklist-table tbody tr.mandatory-row td:first-child::before {
            background: linear-gradient(135deg, var(--danger-color), #fb923c);
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .checklist-table tbody tr.completed td:first-child::before {
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .checklist-table td:nth-child(2) {
            color: var(--text-dark);
        }

        .checklist-table td:nth-child(3),
        .checklist-table td:nth-child(4) {
            text-align: center;
        }

        /* Simple Radio Buttons */
        .radio-wrapper {
            display: inline-block;
        }

        .checklist-table input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--secondary-color);
        }

        .checklist-table td:last-child input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            background: white;
        }

        .checklist-table td:last-child input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: #fafafa;
        }

        .checklist-table td:last-child input::placeholder {
            color: #d1d5db;
        }

        .mandatory {
            color: var(--danger-color);
            font-weight: 600;
            font-size: 14px;
            margin-right: 4px;
        }

        .signature-section {
            margin-top: 50px;
            padding: 40px;
            background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
            border-radius: 12px;
        }

        .signature-section h5 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            color: var(--text-dark);
            font-size: 20px;
        }

        .signature-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 30px;
        }

        .signature-box {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .signature-box:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .signature-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .signature-label {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
            margin-bottom: 15px;
            display: block;
        }

        .signature-canvas-wrapper {
            position: relative;
            margin: 15px 0;
        }

        .signature-canvas {
            width: 100%;
            height: 150px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-canvas.signed {
            border-color: var(--secondary-color);
            background: #f0fdf4;
        }

        .signature-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
        }

        .signature-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .signature-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .signature-btn.clear {
            color: var(--danger-color);
        }

        .signature-btn.clear:hover {
            background: #fef2f2;
            border-color: var(--danger-color);
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-light);
            font-size: 13px;
            pointer-events: none;
            text-align: center;
        }

        .signature-placeholder i {
            display: block;
            font-size: 24px;
            margin-bottom: 5px;
            opacity: 0.5;
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
            color: white;
            padding: 16px 48px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-create-pdf {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 16px 48px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .btn-create-pdf:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-create-pdf:active {
            transform: translateY(0);
        }

        .btn-create-pdf:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .note-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .note-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .note-section p {
            margin: 0;
            color: #92400e;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .note-section i {
            font-size: 20px;
            color: var(--warning-color);
            flex-shrink: 0;
        }

        .stats-bar {
            display: none;
            /* Hidden - replaced with modern progress bar */
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 5px;
        }

        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
            z-index: 9999;
        }

        /* Modern Progress Bar */
        .modern-progress {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            position: sticky;
            top: 10px;
            z-index: 10;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-title i {
            color: var(--primary-color);
            font-size: 16px;
        }

        .progress-percentage {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary-color);
        }

        .progress-bar-container {
            position: relative;
            height: 12px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-light);
        }

        .progress-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .progress-info-item i {
            font-size: 14px;
        }

        .progress-info-item.completed {
            color: var(--secondary-color);
        }

        .progress-info-item.mandatory {
            color: var(--danger-color);
        }

        /* Reminder Section */
        .reminder-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #3b82f6;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .reminder-section:hover {
            box-shadow: var(--shadow-md);
        }

        .reminder-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            position: relative;
        }

        .reminder-header i {
            font-size: 24px;
            color: #3b82f6;
        }

        .reminder-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .reminder-content {
            display: grid;
            gap: 20px;
        }

        .reminder-input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .reminder-input-wrapper {
            flex: 1;
            min-width: 250px;
        }

        .reminder-input-wrapper label {
            display: block;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reminder-input-wrapper label i {
            color: #3b82f6;
            font-size: 12px;
        }

        .reminder-input-wrapper input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #bfdbfe;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .reminder-input-wrapper input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .quick-date-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-date-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .quick-date-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .quick-date-btn.clear-btn {
            color: #dc2626;
        }

        .quick-date-btn.clear-btn:hover {
            background: #dc2626;
            border-color: #dc2626;
            color: white;
        }

        .reminder-note {
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reminder-note i {
            font-size: 16px;
            color: #3b82f6;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            .form-header {
                padding: 30px 20px;
            }

            .form-title {
                font-size: 22px;
            }

            .form-body {
                padding: 30px 20px;
            }

            .info-row {
                grid-template-columns: 1fr;
            }

            .signature-row {
                grid-template-columns: 1fr;
            }

            .checklist-table {
                font-size: 13px;
            }

            /* Mobile-specific table layout */
            .checklist-table thead {
                display: none;
            }

            .checklist-table,
            .checklist-table tbody,
            .checklist-table tr,
            .checklist-table td {
                display: block;
                width: 100%;
            }

            .checklist-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 12px;
                background: white;
            }

            .checklist-table tbody tr:hover {
                background: white;
            }

            .checklist-table td {
                border: none;
                padding: 6px 0;
                text-align: left !important;
            }

            .checklist-table td:first-child {
                padding: 0 0 12px 0;
                text-align: left !important;
                width: 100%;
                display: block;
            }

            .checklist-table td:first-child::before {
                font-size: 12px;
                min-width: 28px;
                height: 28px;
                line-height: 28px;
            }

            .checklist-table td:nth-child(2) {
                padding: 0 0 10px 0;
                font-size: 14px;
                font-weight: 500;
                color: var(--text-dark);
                line-height: 1.5;
            }

            /* Radio buttons container */
            .checklist-table td:nth-child(3),
            .checklist-table td:nth-child(4) {
                width: auto;
                display: inline-block;
                margin-right: 24px;
                padding: 0;
            }

            .checklist-table td:nth-child(3)::before {
                content: 'มี ';
                font-weight: 500;
                color: var(--text-dark);
                margin-right: 6px;
                font-size: 13px;
            }

            .checklist-table td:nth-child(4)::before {
                content: 'ไม่มี ';
                font-weight: 500;
                color: var(--text-dark);
                margin-right: 6px;
                font-size: 13px;
            }

            /* Remark input on new line */
            .checklist-table td:last-child {
                width: 100%;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #f3f4f6;
            }

            .checklist-table td:last-child::before {
                content: 'หมายเหตุ';
                display: block;
                font-weight: 500;
                color: var(--text-light);
                margin-bottom: 6px;
                font-size: 12px;
            }

            .checklist-table td:last-child input {
                width: 100%;
                padding: 10px;
                font-size: 13px;
            }

            .btn-submit {
                width: 100%;
                justify-content: center;
            }

            .btn-create-pdf {
                width: 100%;
                justify-content: center;
            }

            .section-title {
                font-size: 16px;
            }

            .section-header-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .btn-download-pdf {
                width: 100%;
                justify-content: center;
                padding: 12px 20px;
            }

            .note-section p {
                font-size: 13px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
            }

            .stat-item {
                padding: 12px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 11px;
            }

            .signature-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .signature-section {
                padding: 20px 15px;
            }

            .signature-box {
                padding: 15px;
            }

            .signature-canvas {
                height: 120px;
            }

            .signature-controls {
                flex-direction: row;
            }

            /* Mobile reminder section */
            .reminder-section {
                padding: 20px 15px;
            }

            .reminder-header h4 {
                font-size: 16px;
            }

            .reminder-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .reminder-input-wrapper {
                min-width: 100%;
            }

            .quick-date-buttons {
                gap: 6px;
            }

            .quick-date-btn {
                flex: 1;
                min-width: calc(50% - 3px);
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .form-container {
                box-shadow: none;
            }

            .btn-submit,
            .signature-controls,
            .btn-download-pdf,
            .modern-progress,
            .reminder-section,
            .progress-indicator {
                display: none !important;
            }

            .section-header-wrapper {
                border-bottom: 2px solid var(--primary-color);
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            .form-header {
                background: var(--primary-color);
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .signature-canvas {
                border: 1px solid #000;
                background: white !important;
            }

            .signature-placeholder {
                display: none !important;
            }

            .stats-bar {
                display: none;
            }

            .note-section {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .checklist-table {
                page-break-inside: auto;
            }

            .checklist-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }

        /* Loading Animation */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Smooth reveal animation */
        .form-container {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tooltip */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: var(--text-dark);
            color: white;
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: var(--shadow-md);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-dark) transparent transparent transparent;
        }

        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Button loading state */
        .btn-submit.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-submit.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: button-loading-spinner 0.6s linear infinite;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }

            to {
                transform: rotate(1turn);
            }
        }
    </style>
</head>

<body>
    <div class="progress-indicator" id="progressBar"></div>

    <div class="form-container">
        <div class="form-header">
            <h1 class="form-title">
                <i class="fas fa-clipboard-check"></i>
                แบบบันทึกการตรวจรับเครื่องมือทางการแพทย์
            </h1>
            <p class="form-subtitle">Medical Equipment Acceptance Record Form</p>
        </div>

        <div class="form-body">


            <div class="note-section">
                <p>
                    <i class="fas fa-info-circle"></i>
                    <span><strong>หมายเหตุ:</strong> รายการที่มีเครื่องหมาย <span class="mandatory">*</span>
                        เป็นเอกสารที่จำเป็นในการตรวจรับเครื่องมือเบื้องต้น (ลำดับที่ 1, 2, 3, 4, 5, 7, 8)</span>
                </p>
            </div>

            <form id="acceptanceForm">
                <!-- Initial Data Section -->
                <div class="info-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        ข้อมูลทั่วไป
                    </h3>
                    <div class="info-">
                        <div class="form-group">
                            <label for="meCode">
                                <i class="fas fa-tools"></i>
                                รหัสเครื่องมือ
                            </label>
                            <div class="input-with-search">
                                <div style="position: relative; flex: 1;">
                                    <input type="text" id="meCode" name="meCode"
                                        placeholder="ระบุรหัสเครื่องมือ PYT3_xxxxx">
                                    <i class="fas fa-tools input-icon"></i>
                                </div>
                                <button type="button" class="btn-search" onclick="searchPreviousData()">
                                    <i class="fas fa-search"></i>
                                    ค้นหาข้อมูล
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="form-group">
                            <label for="manufacturer">
                                <i class="fas fa-industry"></i>
                                ผู้ผลิต
                            </label>
                            <input type="text" id="manufacturer" name="manufacturer" placeholder="ระบุชื่อผู้ผลิต">
                            <i class="fas fa-industry input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="vendor">
                                <i class="fas fa-store"></i>
                                ผู้ขาย
                            </label>
                            <input type="text" id="vendor" name="vendor" placeholder="ระบุชื่อผู้ขาย">
                            <i class="fas fa-store input-icon"></i>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="form-group">
                            <label for="date">
                                <i class="fas fa-calendar-alt"></i>
                                วันที่
                            </label>
                            <input type="date" id="date" name="date">
                            <i class="fas fa-calendar-alt input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="equipment">
                                <i class="fas fa-heartbeat"></i>
                                เครื่อง
                            </label>
                            <input type="text" id="equipment" name="equipment" placeholder="ระบุชื่อเครื่อง">
                            <i class="fas fa-heartbeat input-icon"></i>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="form-group">
                            <label for="model">
                                <i class="fas fa-tag"></i>
                                รุ่น
                            </label>
                            <input type="text" id="model" name="model" placeholder="ระบุรุ่น">
                            <i class="fas fa-tag input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="serialNumber">
                                <i class="fas fa-barcode"></i>
                                S/N
                            </label>
                            <input type="text" id="serialNumber" name="serialNumber" placeholder="S/N">
                            <i class="fas fa-barcode input-icon"></i>
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="form-group">
                            <label for="quotationNo">
                                <i class="fas fa-file-invoice"></i>
                                ใบเสนอราคา เลขที่
                            </label>
                            <input type="text" id="quotationNo" name="quotationNo" placeholder="ระบุเลขที่ใบเสนอราคา">
                            <i class="fas fa-file-invoice input-icon"></i>
                        </div>
                        <div class="form-group">
                            <label for="invoiceNo">
                                <i class="fas fa-receipt"></i>
                                Invoice เลขที่
                            </label>
                            <input type="text" id="invoiceNo" name="invoiceNo" placeholder="ระบุเลขที่ Invoice">
                            <i class="fas fa-receipt input-icon"></i>
                        </div>
                    </div>
                </div>

                <!-- Checklist Table -->
                <div class="info-section">
                    <div class="section-header-wrapper">
                        <h3 class="section-title">
                            <i class="fas fa-tasks"></i>
                            รายการตรวจสอบเอกสาร
                        </h3>
                        <button type="button" class="btn-download-pdf" onclick="downloadChecklistPDF()">
                            <i class="fas fa-file-pdf"></i>
                            ดาวน์โหลด PDF
                        </button>
                    </div>
                    <!-- Modern Progress Bar -->
                    <div class="modern-progress">
                        <div class="progress-header">
                            <div class="progress-title">
                                <i class="fas fa-tasks"></i>
                                ความคืบหน้าการตรวจสอบ
                            </div>
                            <div class="progress-percentage" id="completionPercent">0%</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-info">
                            <div class="progress-info-item completed">
                                <i class="fas fa-check-circle"></i>
                                <span><span id="completedItems">0</span> / <span id="totalItems">22</span> รายการ</span>
                            </div>
                            <div class="progress-info-item mandatory">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>รายการบังคับ: <span id="mandatoryItems">7</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="checklist-table">
                            <thead>
                                <tr>
                                    <th>ลำดับ</th>
                                    <th>เอกสาร</th>
                                    <th>มี</th>
                                    <th>ไม่มี</th>
                                    <th>หมายเหตุ</th>
                                </tr>
                            </thead>
                            <tbody id="checklistBody">
                                <!-- Rows will be generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reminder Section -->
                <div class="reminder-section">
                    <div class="reminder-header">
                        <i class="fas fa-bell"></i>
                        <h4>ตั้งค่าการแจ้งเตือน</h4>
                    </div>
                    <div class="reminder-content">
                        <div class="reminder-input-group">
                            <div class="reminder-input-wrapper">
                                <label for="reminderDate">
                                    <i class="fas fa-calendar-check"></i>
                                    วันที่ต้องการแจ้งเตือน
                                </label>
                                <input type="date" id="reminderDate" name="reminderDate" placeholder="เลือกวันที่">
                            </div>
                            <div class="reminder-input-wrapper">
                                <label for="reminderNote">
                                    <i class="fas fa-sticky-note"></i>
                                    หมายเหตุการแจ้งเตือน (ถ้ามี)
                                </label>
                                <input type="text" id="reminderNote" name="reminderNote"
                                    placeholder="เช่น ติดตามเอกสาร, ตรวจสอบการติดตั้ง">
                            </div>
                        </div>
                        <div>
                            <label
                                style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-dark); font-size: 13px;">
                                เลือกด่วน:
                            </label>
                            <div class="quick-date-buttons">
                                <button type="button" class="quick-date-btn" onclick="setQuickDate(3)">3 วัน</button>
                                <button type="button" class="quick-date-btn" onclick="setQuickDate(7)">1
                                    สัปดาห์</button>
                                <button type="button" class="quick-date-btn" onclick="setQuickDate(14)">2
                                    สัปดาห์</button>
                                <button type="button" class="quick-date-btn" onclick="setQuickDate(30)">1 เดือน</button>
                                <button type="button" class="quick-date-btn clear-btn"
                                    onclick="clearReminder()">ล้าง</button>
                            </div>
                        </div>
                        <div class="reminder-note">
                            <i class="fas fa-info-circle"></i>
                            <span>ระบบจะแจ้งเตือนในวันที่กำหนดเพื่อติดตามความคืบหน้า</span>
                        </div>
                    </div>
                </div>


                <div
                    style="display: flex; gap: 15px; justify-content: center; align-items: center; flex-wrap: wrap; margin-top: 40px;">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i>
                        ยืนยันและบันทึกข้อมูล
                    </button>
                    <button type="button" class="btn-create-pdf" onclick="createPDFFile()" style="display: none;">
                        <i class="fas fa-file-pdf"></i>
                        สร้างไฟล์ PDF
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="form-container mt-3 d-none" id="downloadFileContainer">
        <div class="form-body">
            <h3 class="section-title">
                <i class="fas fa-download"></i>
                ดาวน์โหลดเอกสาร
            </h3>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; padding: 20px;">
                <button type="button" class="btn-download-pdf"
                    style="background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); padding: 16px 32px; font-size: 18px;">
                    <i class="fas fa-file-download"></i>
                    ดาวน์โหลดไฟล์
                </button>
            </div>
            <iframe id="pdf"
                style="width: 100%; height: calc(100vw *(1.4142)); display: none;  border-radius: 20px;"></iframe>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>


    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9gJp3t1vHLSpGZF7rGDPq9M8xY6eThFJsOvRBStYAVIW4tA3VzgU80awM_22C5P0/exec'

        // Search for previous data by meCode
        async function searchPreviousData() {
            const meCode = document.getElementById('meCode').value.trim();
            console.log('Searching for ME Code:', meCode);
            if (!meCode) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาระบุรหัสเครื่องมือ',
                    text: 'กรุณากรอกรหัสเครื่องมือก่อนค้นหา',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#f59e0b',
                    customClass: { popup: 'rounded-3' }
                });
                return;
            }

            // Show loading
            Swal.fire({
                title: 'กำลังค้นหาข้อมูล...',
                html: `กำลังค้นหาข้อมูลของ <strong>${meCode}</strong>`,
                allowOutsideClick: false,
                customClass: { popup: 'rounded-3' },
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                $.get(SCRIPT_URL, { action: 'searchByMeCode', meCode: meCode }, function (response) {
                    handleSearchResponse(response, meCode);
                });
            } catch (error) {
                console.error('Error initiating search:', error);
                Swal.close();
            }
        }

        // Handle search response
        function handleSearchResponse(response, meCode) {
            console.log('Search response:', response);
            Swal.close();
            if (response.success && response.data) {
                Swal.fire({
                    icon: 'success',
                    title: 'พบข้อมูล',
                    html: `
                        <div style="text-align: left; padding: 15px; background: #f9fafb; border-radius: 8px; margin-top: 10px;">
                            <div style="margin-bottom: 10px;"><strong>รหัส:</strong> ${meCode}</div>
                            <div style="margin-bottom: 10px;"><strong>เครื่อง:</strong> ${response.data.equipment || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>รุ่น:</strong> ${response.data.model || '-'}</div>
                            <div style="margin-bottom: 10px;"><strong>ผู้ขาย:</strong> ${response.data.vendor || '-'}</div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                ต้องการเติมข้อมูลในแบบฟอร์มหรือไม่?
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#10b981',
                    customClass: { popup: 'rounded-3' }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Scroll to form
                        fillFormWithData(response.data);
                        // Show PDF button
                        showPDFButton();
                    }
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'ไม่พบข้อมูล',
                    html: `ไม่พบข้อมูลของ <strong>${meCode}</strong> ในระบบ`,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#3b82f6',
                    customClass: { popup: 'rounded-3' }
                });
            }
        }

        // Fill form with retrieved data
        function fillFormWithData(data) {
            // Store UUID for updates
            if (data.uuid) {
                localStorage.setItem('formUUID', data.uuid);
            }

            if (data.manufacturer) document.getElementById('manufacturer').value = data.manufacturer;
            if (data.vendor) document.getElementById('vendor').value = data.vendor;
            if (data.date) document.getElementById('date').value = data.date;
            if (data.equipment) document.getElementById('equipment').value = data.equipment;
            if (data.model) document.getElementById('model').value = data.model;
            if (data.serialNumber) document.getElementById('serialNumber').value = data.serialNumber;
            if (data.quotationNo) document.getElementById('quotationNo').value = data.quotationNo;
            if (data.invoiceNo) document.getElementById('invoiceNo').value = data.invoiceNo;

            data.checklist_data = JSON.parse(data.checklist_data || '[]');
            console.log(data.checklist_data);
            // Fill checklist if available
            if (data.checklist_data && Array.isArray(data.checklist_data)) {
                data.checklist_data.forEach(item => {
                    const presentRadio = document.getElementById(`present_${item.no}`);
                    const absentRadio = document.getElementById(`absent_${item.no}`);
                    const remarkInput = document.getElementById(`remark_${item.no}`);

                    if (item.status === 'มี' && presentRadio) {
                        presentRadio.checked = true;
                    } else if (item.status === 'ไม่มี' && absentRadio) {
                        absentRadio.checked = true;
                    }

                    if (item.remark && remarkInput) {
                        remarkInput.value = item.remark;
                    }
                });

                // Update stats after filling checklist
                updateStats();
            }

            // Fill reminder if available
            if (data.reminder) {
                if (data.reminder.date) {
                    document.getElementById('reminderDate').value = data.reminder.date;
                    const reminderDateInput = document.getElementById('reminderDate');
                    if (reminderDateInput._flatpickr) {
                        reminderDateInput._flatpickr.setDate(data.reminder.date);
                    }
                }
                if (data.reminder.note) {
                    document.getElementById('reminderNote').value = data.reminder.note;
                }
            }

            // Visual feedback
            const inputs = document.querySelectorAll('input[type="text"], input[type="date"]');
            inputs.forEach(input => {
                if (input.value) {
                    input.style.animation = 'pulse 0.5s ease';
                    setTimeout(() => {
                        input.style.animation = '';
                    }, 500);
                }
            });
        }

        // Checklist items data
        const checklistItems = [
            { no: 1, document: "BME Report (FP-BME-NHS-00-026/2)", mandatory: true },
            { no: 2, document: "Medical Equipment Assessment Form (FP-BME-NHS-00-033/3)", mandatory: true },
            { no: 3, document: "Acceptance Test Reports (FP-BME-NHS-00-026/3)", mandatory: true },
            { no: 4, document: "Certificate & License for Device (ใบตรวจรับรองการสอบเทียบเครื่อง)", mandatory: true },
            { no: 5, document: "สำเนาหนังสือรับรองประกอบการนำเข้าเครื่องมือแพทย์", mandatory: true },
            { no: 6, document: "เอกสารรับรองการควบคุมมาตรฐาน (FDA, อย., มอก.)", mandatory: false },
            { no: 7, document: "Spec รุ่น เครื่องมือและอุปกรณ์ครบถ้วนตามใบเสนอราคา", mandatory: true },
            { no: 8, document: "Invoice เลขที่ (ระบุเลขที่ของใบแจ้งหนี้)", mandatory: true },
            { no: 9, document: "หนังสือแต่งตั้งตัวแทนจำหน่าย", mandatory: false },
            { no: 10, document: "Certificate Engineer (ใบรับรองการอบรมของวิศวกร)", mandatory: false },
            { no: 11, document: "Tester's Certificates (ใบรับรองการสอบเทียบเครื่องมือที่ใช้ในการทดสอบ)", mandatory: false },
            { no: 12, document: "Schedule of maintenance with detail (แผนสอบเทียบและบำรุงรักษาพร้อมรายละเอียด)", mandatory: false },
            { no: 13, document: "Service Manuals (ฉบับภาษาไทย และฉบับภาษาอังกฤษ)", mandatory: false },
            { no: 14, document: "Operating Manuals (ฉบับภาษาไทย และฉบับภาษาอังกฤษ)", mandatory: false },
            { no: 15, document: "Purchasing contract (สัญญาซื้อขาย) (หมายเหตุ: ใช้ในกรณีที่มีมูลค่าสูงกว่า 1 ล้านบาท)", mandatory: false },
            { no: 16, document: "Service contract (สัญญาบริการหลังการขาย)", mandatory: false },
            { no: 17, document: "รายงานกรมวิทย์ (เฉพาะเครื่องมือกลุ่มงานรังสี)", mandatory: false },
            { no: 18, document: "Air waybill/Bill of Loading (เอกสารการขนส่งสินค้า)", mandatory: false },
            { no: 19, document: "เอกสาร Training User (แบบลงทะเบียนเข้ารับการอบรม ฝ่ายแพทย์ FP-BME-NHS-00-026/5 และฝ่ายพยาบาล FP-BME-NHS-00-026/6)", mandatory: false },
            { no: 20, document: "Network Document (เอกสาร Network)", mandatory: false },
            { no: 21, document: "Value Analysis (เอกสารวิเคราะห์คุณค่าของเครื่อง)", mandatory: false },
            { no: 22, document: "เอกสารยินยอมการเก็บรักษาข้อมูล (FP-BME-NHS-00-026/4)", mandatory: false }
        ];

        // Quick date selection functions
        function setQuickDate(days) {
            const today = new Date();
            today.setDate(today.getDate() + days);
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('reminderDate').value = dateString;

            // Trigger flatpickr update if initialized
            const reminderDateInput = document.getElementById('reminderDate');
            if (reminderDateInput._flatpickr) {
                reminderDateInput._flatpickr.setDate(dateString);
            }

            // Visual feedback
            const reminderSection = document.querySelector('.reminder-section');
            reminderSection.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
                reminderSection.style.animation = '';
            }, 500);
        }

        function clearReminder() {
            document.getElementById('reminderDate').value = '';
            document.getElementById('reminderNote').value = '';

            // Clear flatpickr if initialized
            const reminderDateInput = document.getElementById('reminderDate');
            if (reminderDateInput._flatpickr) {
                reminderDateInput._flatpickr.clear();
            }

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'info',
                title: 'ล้างการแจ้งเตือนแล้ว',
                showConfirmButton: false,
                timer: 1500,
                customClass: { popup: 'rounded-3' }
            });
        }

        function formatThaiDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('th-TH', options);
        }

        // Download Checklist as PDF
        function downloadChecklistPDF() {
            NProgress.start();

            let pdf_path = './invent_form.pdf';
            // init downlad
            let a = document.createElement('a');
            a.href = pdf_path;
            a.download = pdf_path.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Generate checklist table rows
        function generateChecklistTable() {
            const tbody = document.getElementById('checklistBody');
            tbody.innerHTML = '';

            checklistItems.forEach((item, index) => {
                const row = document.createElement('tr');
                const mandatoryMark = item.mandatory ? '<span class="mandatory">*</span> ' : '';

                if (item.mandatory) {
                    row.classList.add('mandatory-row');
                }

                row.innerHTML = `
                    <td data-number="${item.no}" class="text-center"></td>
                    <td>${mandatoryMark}${item.document}</td>
                    <td>
                        <div class="radio-wrapper">
                            <input type="radio" name="item_${item.no}" value="present" 
                                   id="present_${item.no}" class="form-check-input" onchange="updateStats()">
                        </div>
                    </td>
                    <td>
                        <div class="radio-wrapper">
                            <input type="radio" name="item_${item.no}" value="absent" 
                                   id="absent_${item.no}" class="form-check-input" onchange="updateStats()">
                        </div>
                    </td>
                    <td>
                        <input type="text" name="remark_${item.no}" 
                               id="remark_${item.no}" class="remark-input" placeholder="เพิ่มหมายเหตุ...">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Validate mandatory items
        function validateMandatoryItems() {
            const errors = [];

            checklistItems.forEach(item => {
                if (item.mandatory) {
                    const presentRadio = document.getElementById(`present_${item.no}`);
                    const absentRadio = document.getElementById(`absent_${item.no}`);

                    if (!presentRadio.checked && !absentRadio.checked) {
                        errors.push(`ลำดับที่ ${item.no}: ${item.document} - กรุณาเลือกสถานะ`);
                    } else if (absentRadio.checked) {
                        errors.push(`ลำดับที่ ${item.no}: ${item.document} - เอกสารบังคับต้องมี`);
                    }
                }
            });

            return errors;
        }

        // Update statistics and progress bar
        function updateStats() {
            let completedCount = 0;

            checklistItems.forEach(item => {
                const presentRadio = document.getElementById(`present_${item.no}`);
                const absentRadio = document.getElementById(`absent_${item.no}`);
                const row = presentRadio?.closest('tr');

                if (presentRadio?.checked || absentRadio?.checked) {
                    completedCount++;
                    row?.classList.add('completed');

                    // Add visual feedback for completed row
                    if (presentRadio?.checked) {
                        row?.classList.remove('completed');
                        row?.classList.add('completed');
                    }
                } else {
                    row?.classList.remove('completed');
                }
            });

            const totalCount = checklistItems.length;
            const percentage = Math.round((completedCount / totalCount) * 100);

            // Update stats display
            document.getElementById('completedItems').textContent = completedCount;
            document.getElementById('completionPercent').textContent = percentage + '%';

            // Update modern progress bar
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = percentage + '%';

                // Change progress bar color based on completion
                if (percentage === 100) {
                    progressBarFill.style.background = 'linear-gradient(90deg, #10b981, #059669)';
                    progressBarFill.style.boxShadow = '0 2px 4px rgba(16, 185, 129, 0.3)';
                } else if (percentage >= 50) {
                    progressBarFill.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
                    progressBarFill.style.boxShadow = '0 2px 4px rgba(245, 158, 11, 0.3)';
                } else {
                    progressBarFill.style.background = 'linear-gradient(90deg, #6366f1, #818cf8)';
                    progressBarFill.style.boxShadow = '0 2px 4px rgba(99, 102, 241, 0.3)';
                }
            }

            // Update top progress indicator
            document.getElementById('progressBar').style.transform = `scaleX(${percentage / 100})`;
            const progressBar = document.getElementById('progressBar');
            if (percentage === 100) {
                progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
            } else if (percentage >= 50) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #6366f1, #10b981)';
            }
        }

        // Form submission handler
        document.getElementById('acceptanceForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const submitBtn = document.querySelector('.btn-submit');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            NProgress.start();

            // Validate mandatory items
            const errors = validateMandatoryItems();

            // if (errors.length > 0) {
            //     NProgress.done();
            //     submitBtn.classList.remove('loading');
            //     submitBtn.disabled = false;

            //     Swal.fire({
            //         icon: 'error',
            //         title: 'ข้อมูลไม่ครบถ้วน',
            //         html: '<div style="text-align: left; max-height: 300px; overflow-y: auto;">' +
            //             errors.map(err => `<div style="margin: 8px 0; padding: 8px; background: #fef2f2; border-radius: 6px;"><i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> ${err}</div>`).join('') +
            //             '</div>',
            //         confirmButtonText: 'ตกลง',
            //         confirmButtonColor: '#ef4444',
            //         width: '600px'
            //     });

            //     // Scroll to first error
            //     const firstError = errors[0];
            //     const errorNo = firstError.match(/ลำดับที่ (\d+)/)?.[1];
            //     if (errorNo) {
            //         const errorRow = document.getElementById(`present_${errorNo}`)?.closest('tr');
            //         errorRow?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            //         errorRow.style.animation = 'shake 0.5s';
            //     }
            //     return;
            // }

            // Generate or retrieve UUID for this form session
            let formUUID = localStorage.getItem('formUUID');

            // Collect form data
            const formData = {
                manufacturer: document.getElementById('manufacturer').value,
                vendor: document.getElementById('vendor').value,
                date: document.getElementById('date').value,
                equipment: document.getElementById('equipment').value,
                model: document.getElementById('model').value,
                serialNumber: document.getElementById('serialNumber').value,
                quotationNo: document.getElementById('quotationNo').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                reminder: {
                    date: document.getElementById('reminderDate').value,
                    note: document.getElementById('reminderNote').value
                },
                checklist: [],
                uuid: formUUID
            };

            // Collect checklist data
            checklistItems.forEach(item => {
                const presentRadio = document.getElementById(`present_${item.no}`);
                const absentRadio = document.getElementById(`absent_${item.no}`);
                const remark = document.getElementById(`remark_${item.no}`).value;

                formData.checklist.push({
                    no: item.no,
                    document: item.document,
                    status: presentRadio.checked ? 'มี' : (absentRadio.checked ? 'ไม่มี' : 'ไม่ระบุ'),
                    remark: remark
                });
            });
            formData.checklist = JSON.stringify(formData.checklist);
            formData.reminder = JSON.stringify(formData.reminder);
            formData.meCode = document.getElementById('meCode').value.trim();
            formData.action = 'submit_form';
            NProgress.start();
            console.log('Submitting form data:', formData);
            Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                html: 'กรุณารอสักครู่ ข้อมูลของคุณกำลังถูกบันทึก',
                allowOutsideClick: false,
                customClass: { popup: 'rounded-3' },
                didOpen: () => {
                    Swal.showLoading();
                }
            })

            // Submit data to Google Apps Script
            $.post(SCRIPT_URL, formData, function (data) {
                console.log(data)
                NProgress.done();
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;

                if (data.status === 'success') {
                    const actionText = data.action === 'updated' ? 'อัปเดตข้อมูลสำเร็จ' : 'บันทึกข้อมูลสำเร็จ';
                    const messageText = data.action === 'updated'
                        ? 'ข้อมูลของคุณได้รับการอัปเดตเรียบร้อยแล้ว'
                        : 'ข้อมูลของคุณได้รับการบันทึกเรียบร้อยแล้ว';

                    Swal.fire({
                        icon: 'success',
                        title: actionText,
                        text: messageText,
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#10b981',
                        customClass: { popup: 'rounded-3' }
                    }).then(() => {
                        // Show PDF button after successful submission
                        showPDFButton();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: data.message || 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: '#ef4444',
                        customClass: { popup: 'rounded-3' }
                    });
                }
            }).fail(function () {
                NProgress.done();
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;

                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาลองใหม่อีกครั้ง',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444',
                    customClass: { popup: 'rounded-3' }
                });
            });
        });

        // Initialize flatpickr for date input


        // Add shake animation CSS
        const shakeKeyframes = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        const style = document.createElement('style');
        style.textContent = shakeKeyframes;
        document.head.appendChild(style);

        // Generate table on page load
        document.addEventListener('DOMContentLoaded', function () {
            generateChecklistTable();

            localStorage.removeItem('formUUID'); // Clear previous UUID on new load
            flatpickr("#date", {
                locale: "th",
                dateFormat: "Y-m-d",
                altFormat: "d F Y",
                altInput: true,
                allowInput: true,
                defaultDate: "today"
            });

            // Initialize flatpickr for reminder date
            flatpickr("#reminderDate", {
                locale: "th",
                dateFormat: "Y-m-d",
                altFormat: "d F Y",
                altInput: true,
                allowInput: true,
                minDate: "today",
                onChange: function (selectedDates, dateStr, instance) {
                    if (dateStr) {
                        // Visual feedback when date is selected
                        const reminderSection = document.querySelector('.reminder-section');
                        reminderSection.style.borderLeftColor = '#3b82f6';
                        reminderSection.style.borderLeftWidth = '5px';

                        setTimeout(() => {
                            reminderSection.style.borderLeftWidth = '4px';
                        }, 300);
                    }
                }
            });

            // Add Enter key listener for meCode search
            const meCodeInput = document.getElementById('meCode');
            if (meCodeInput) {
                meCodeInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchPreviousData();
                    }
                });
            }

            // Add form field animations and validation
            const inputs = document.querySelectorAll('input[type="text"], input[type="date"]');
            inputs.forEach(input => {
                input.addEventListener('focus', function () {
                    this.parentElement.classList.add('focused');
                });
                input.addEventListener('blur', function () {
                    this.parentElement.classList.remove('focused');
                });

                // Auto-save to localStorage
                input.addEventListener('input', _.debounce(function () {
                    localStorage.setItem(this.id, this.value);
                }, 500));

                // Restore from localStorage
                const savedValue = localStorage.getItem(input.id);
                if (savedValue) {
                    input.value = savedValue;
                }
            });

            // Initialize stats
            updateStats();

            // Add keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // Ctrl/Cmd + S to save (prevent default browser save)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('acceptanceForm').dispatchEvent(new Event('submit'));
                }
            });

            // Show tooltip on mandatory asterisk hover
            document.querySelectorAll('.mandatory').forEach(elem => {
                elem.title = 'รายการบังคับ - ต้องมีเอกสารนี้';
            });
        });

        // Show PDF button
        function showPDFButton() {
            const pdfBtn = document.querySelector('.btn-create-pdf');
            if (pdfBtn) {
                pdfBtn.style.display = 'flex';
                // Animate the button appearance
                pdfBtn.style.opacity = '0';
                pdfBtn.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    pdfBtn.style.transition = 'all 0.3s ease';
                    pdfBtn.style.opacity = '1';
                    pdfBtn.style.transform = 'scale(1)';
                }, 10);
            }
        }

        // Create PDF File
        async function createPDFFile() {
            if (!pdfDoc) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถสร้าง PDF ได้',
                    text: 'กรุณารอสักครู่แล้วลองใหม่อีกครั้ง',
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444',
                    customClass: { popup: 'rounded-3' }
                });
                return;
            }

            NProgress.start();

            Swal.fire({
                title: 'กำลังสร้างไฟล์ PDF...',
                html: 'กรุณารอสักครู่ ระบบกำลังสร้างเอกสาร PDF',
                allowOutsideClick: false,
                customClass: { popup: 'rounded-3' },
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                await fillPDFForm();
                NProgress.done();
                Swal.close();

            } catch (error) {
                console.error('Error creating PDF:', error);
                NProgress.done();
                Swal.close();

                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถสร้างไฟล์ PDF ได้: ' + error.message,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#ef4444',
                    customClass: { popup: 'rounded-3' }
                });
            }
        }

        // Fill PDF form with data
        async function fillPDFForm() {
            const pdfDocCopy = await PDFLib.PDFDocument.load(await pdfDoc.save());
            const form = pdfDocCopy.getForm();

            try {
                // Get form data
                const formData = {
                    meCode: document.getElementById('meCode').value.trim(),
                    manufacturer: document.getElementById('manufacturer').value,
                    vendor: document.getElementById('vendor').value,
                    date: document.getElementById('date').value,
                    equipment: document.getElementById('equipment').value,
                    model: document.getElementById('model').value,
                    serialNumber: document.getElementById('serialNumber').value,
                    quotationNo: document.getElementById('quotationNo').value,
                    invoiceNo: document.getElementById('invoiceNo').value
                };

                // Fill PDF fields (adjust field names based on your PDF)
                const fieldMappings = {
                    'meCode': formData.meCode,
                    'manufacturer': formData.manufacturer,
                    'vendor': formData.vendor,
                    'date': formData.date,
                    'equipment': formData.equipment,
                    'model': formData.model,
                    'serialNumber': formData.serialNumber,
                    'quotationNo': formData.quotationNo,
                    'invoiceNo': formData.invoiceNo
                };

                // Try to fill each field
                Object.keys(fieldMappings).forEach(fieldName => {
                    try {
                        const field = form.getTextField(fieldName);
                        if (field && fieldMappings[fieldName]) {
                            field.setText(String(fieldMappings[fieldName]));
                        }
                    } catch (e) {
                        console.warn(`Field ${fieldName} not found or error:`, e.message);
                    }
                });

                // Fill checklist items
                checklistItems.forEach((item, index) => {
                    const presentRadio = document.getElementById(`present_${item.no}`);
                    const absentRadio = document.getElementById(`absent_${item.no}`);
                    const remark = document.getElementById(`remark_${item.no}`).value;

                    // Try to fill checkbox fields (adjust field names based on your PDF)
                    try {
                        if (presentRadio && presentRadio.checked) {
                            const checkBox = form.getCheckBox(`check_${item.no}_present`);
                            if (checkBox) checkBox.check();
                        } else if (absentRadio && absentRadio.checked) {
                            const checkBox = form.getCheckBox(`check_${item.no}_absent`);
                            if (checkBox) checkBox.check();
                        }
                    } catch (e) {
                        console.warn(`Checkbox field for item ${item.no} not found`);
                    }

                    // Try to fill remark field
                    try {
                        if (remark) {
                            const remarkField = form.getTextField(`remark_${item.no}`);
                            if (remarkField) remarkField.setText(remark);
                        }
                    } catch (e) {
                        console.warn(`Remark field for item ${item.no} not found`);
                    }
                });

                // Flatten the form to make it non-editable
                form.flatten();

                // Save and download
                const pdfBytes = await pdfDocCopy.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                // show download button
                $('#downloadFileContainer').removeClass('d-none').find('button').off('click').on('click', function () {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Acceptance_Checklist_${formData.meCode || 'ME'}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });


                // Also show preview in iframe
                const iframe = document.getElementById('pdf');
                iframe.src = url;
                iframe.style.display = 'block';
                setTimeout(() => {
                    $('#downloadFileContainer')[0].scrollIntoView({ behavior: 'smooth' });
                }, 1000);

                // Clean up the URL after a delay
                setTimeout(() => URL.revokeObjectURL(url), 10000);

            } catch (error) {
                console.error('Error filling PDF form:', error);
                throw error;
            }
        }
    </script>
    <script>
        var pdfDoc
        var PDFDocument = PDFLib.PDFDocument;
        var StandardFonts = PDFLib.StandardFonts;
        var pdfFiles = []
        $(document).ready(async function () {
            NProgress.done();
            initPdfLib()
        });

        function initPdfLib() {
            console.log('Initializing PDFLib...');
            // Load the PDF file
            const url = './invent_form.pdf'
            fetch(url).then(res => res.arrayBuffer()).then(async (data) => {
                console.log('PDF file loaded');
                pdfDoc = await PDFDocument.load(data);
                const form = pdfDoc.getForm();

                // Get all fields in the PDF
                const fields = form.getFields();
                fields.forEach(field => {
                    const type = field.constructor.name;
                    const name = field.getName();
                    console.log(`${type}: ${name}`);
                });
            });
        }
    </script>
</body>

</html>