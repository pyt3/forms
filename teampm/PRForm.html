<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <base target="_top">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-orange': '#e3a42e',
                        'brand-orange-dark': '#c28a1f',
                        'brand-orange-light': '#f0c14b',
                    }
                }
            }
        }
    </script>

    <!-- Keep Bootstrap for offcanvas compatibility -->
    <link href="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://fastly.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">
    <!-- icon -->
    <link rel="icon" href="https://img.icons8.com/3d-fluency/94/move-by-trolley.png" type="image/x-icon" />
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="./main const.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        #sticker {
            width: 100%;
            height: 100%;
        }

        .nsmart-img {
            cursor: grab;
        }

        .nsmart-img:active {
            cursor: grabbing;
        }

        /* Smooth transitions */
        input,
        select,
        textarea,
        button {
            transition: all 0.2s ease-in-out;
        }

        input:focus,
        select:focus,
        textarea:focus {
            transform: translateY(-1px);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #e3a42e;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #c28a1f;
        }

        /* Quill Editor Customization */
        .ql-container {
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: 14px;
        }

        .ql-editor {
            min-height: 250px;
            padding: 12px;
            line-height: 1.6;
        }

        .ql-toolbar {
            border: 1px solid #d1d5db;
            background-color: #e0f2fe;
        }

        .ql-toolbar button,
        .ql-toolbar button:hover,
        .ql-toolbar select {
            color: #1f2937;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .ql-toolbar button:hover,
        .ql-toolbar select:focus {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .ql-toolbar button.ql-active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
    <title>PR Form</title>
</head>

<body class="min-h-screen bg-body-tertiary">
    <header class="sticky top-0 z-50 shadow-lg bg-gradient-to-br from-brand-orange to-brand-orange-dark">
        <nav class="bg-brand-orange-dark shadow-md">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img width="35" height="35" src="https://img.icons8.com/3d-fluency/94/move-by-trolley.png"
                            alt="move-by-trolley" class="drop-shadow-lg" />
                        <span class="text-white font-semibold text-lg hidden sm:block">PR Form</span>
                    </div>
                    <form class="flex items-center gap-2 flex-1 max-w-md ml-auto" role="search" id="search-form">
                        <input class="flex-1 px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-white 
                                      text-sm placeholder-gray-400 shadow-sm" type="search"
                            placeholder="กรอกรหัสเพื่อค้นหา" aria-label="Search" id="search-input">
                        <button
                            class="px-4 py-2 bg-white text-brand-orange-dark font-medium rounded-lg 
                                       hover:bg-gray-100 active:scale-95 transition-all shadow-md flex justify-center items-center gap-2"
                            type="submit">
                            <i data-lucide="search"></i>
                            ค้นหา
                        </button>
                    </form>
                </div>
            </div>
        </nav>
    </header>
    <main class="container mx-auto px-4 pb-20 -mt-4">
        <div class="py-8">
            <div class="container mx-auto px-4 flex flex-col items-center justify-center">
                <div class="flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-4 
                            hover:scale-110 transition-transform">
                    <img width="50" src="https://img.icons8.com/3d-fluency/94/move-by-trolley.png"
                        alt="move-by-trolley" />
                </div>
                <h1 class="text-4xl font-bold text-orange drop-shadow-lg tracking-wide">PR Form</h1>
                <p class="text-black/80 mt-2 text-base">ฟอร์มใบขออนุมัติซื้อ</p>
            </div>
        </div>
        <div class="max-w-7xl mx-auto">
            <form id="myForm" class="space-y-6">
                <section class="mt-4 mx-2 rounded-2xl bg-white p-6 shadow-xl">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label for="name" class="block text-sm font-medium text-gray-700">
                                <i data-lucide="user" class="inline-block w-4 h-4 mr-1"></i>
                                ชื่อผู้กรอก</label>
                            <select name="name" id="name"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400 bg-white">
                            </select>
                        </div>
                    </div>
                </section>
                <section class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow mx-2 mt-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div class="hidden">
                            <!-- download btn -->
                            <a class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:scale-95 transition-all shadow-md"
                                id="download-from-search-btn" type="button">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                ดูไฟล์ PDF</a>
                        </div>
                        <div class="ml-auto">
                            <button
                                class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-medium rounded-lg hover:from-blue-700 hover:to-blue-800 active:scale-95 transition-all shadow-md"
                                id="auto-fill" type="button" onclick="autoFillProcess()">
                                <i data-lucide="rocket" class="w-5 h-5"></i>
                                Auto Fill
                            </button>
                        </div>
                    </div>

                    <div class="border-l-4 border-brand-orange pl-4 mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="wrench" class="w-7 h-7 text-brand-orange"></i>
                            <h2 class="text-2xl font-bold text-gray-800">รายละเอียดเครื่องมือ</h2>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label for="job_id" class="block text-sm font-medium text-gray-700">Work Order</label>
                            <input type="text" name="job_id" id="job_id"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_name" class="block text-sm font-medium text-gray-700">ชื่อเครื่องมือ</label>
                            <input type="text" name="e_name" id="e_name"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="dept" class="block text-sm font-medium text-gray-700">แผนก</label>
                            <select name="dept" id="dept"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400 bg-white">
                                <option value="" disabled selected>Select value</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="e_manufacturer" class="block text-sm font-medium text-gray-700">ผู้ผลิต</label>
                            <input type="text" name="e_manufacturer" id="e_manufacturer"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_date" class="block text-sm font-medium text-gray-700">วันที่ซื้อ</label>
                            <input type="text" name="e_date" id="e_date"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_hospital_code"
                                class="block text-sm font-medium text-gray-700">หมายเลขทรัพย์สิน</label>
                            <input type="text" name="e_hospital_code" id="e_hospital_code"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_brand/model"
                                class="block text-sm font-medium text-gray-700">ยี่ห้อ/รุ่น</label>
                            <input type="text" name="e_brand/model" id="e_brand/model"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_sn" class="block text-sm font-medium text-gray-700">เลขเครื่อง (SN)</label>
                            <input type="text" name="e_sn" id="e_sn"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_me_code" class="block text-sm font-medium text-gray-700">หมายเลขเครื่อง (ME
                                Code)</label>
                            <input type="text" name="e_me_code" id="e_me_code"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="e_price" class="block text-sm font-medium text-gray-700">ราคาซื้อ <span
                                    class="text-gray-500 text-xs">(บาท)</span></label>
                            <input type="text" name="e_price" id="e_price"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                    </div>

                    <div class="mt-6 space-y-5">
                        <div class="space-y-2">
                            <label for="pr_failure" class="block text-sm font-medium text-gray-700">อาการเสีย</label>
                            <input type="text" name="pr_failure" id="pr_failure"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_result" class="block text-sm font-medium text-gray-700">ผลการตรวจเช็ค</label>
                            <input type="text" name="pr_result" id="pr_result"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_recommend"
                                class="block text-sm font-medium text-gray-700">การดำเนินการ</label>
                            <input type="text" name="pr_recommend" id="pr_recommend"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                    </div>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="group">
                            <div class="relative rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 p-6 
                                                    border-2 border-dashed border-blue-300 hover:border-blue-500 
                                                    cursor-pointer transition-all hover:shadow-lg active:scale-95"
                                id="e_img_div">
                                <img id="preview-img" alt="preview"
                                    class="absolute top-3 right-3 w-16 h-16 object-cover rounded-lg shadow-lg ring-2 ring-white hidden" />
                                <div class="flex flex-col items-center justify-center space-y-2">
                                    <i data-lucide="image" class="w-12 h-12 text-blue-500 drop-shadow-md"></i>
                                    <span class="text-sm font-medium text-blue-700">รูปภาพเครื่อง</span>
                                    <span class="text-xs text-blue-600">คลิกหรือลากไฟล์มาวาง</span>
                                </div>
                            </div>
                        </div>
                        <div class="group">
                            <div class="relative rounded-xl bg-gradient-to-br from-purple-50 to-purple-100 p-6 
                                                    border-2 border-dashed border-purple-300 hover:border-purple-500 
                                                    cursor-pointer transition-all hover:shadow-lg active:scale-95"
                                id="e_img_code_div">
                                <img id="preview-img-code" alt="preview"
                                    class="absolute top-3 right-3 w-16 h-16 object-cover rounded-lg shadow-lg ring-2 ring-white hidden" />
                                <div class="flex flex-col items-center justify-center space-y-2">
                                    <i data-lucide="barcode" class="w-12 h-12 text-purple-500 drop-shadow-md"></i>
                                    <span class="text-sm font-medium text-purple-700">รูปภาพโค้ด</span>
                                    <span class="text-xs text-purple-600">คลิกหรือลากไฟล์มาวาง</span>
                                </div>
                            </div>
                        </div>
                        <div class="group">
                            <div class="relative rounded-xl bg-gradient-to-br from-green-50 to-green-100 p-6 
                                                    border-2 border-dashed border-green-300 hover:border-green-500 
                                                    cursor-pointer transition-all hover:shadow-lg active:scale-95"
                                id="e_img_nameplate_div">
                                <img id="preview-img-nameplate" alt="preview"
                                    class="absolute top-3 right-3 w-16 h-16 object-cover rounded-lg shadow-lg ring-2 ring-white hidden" />
                                <div class="flex flex-col items-center justify-center space-y-2">
                                    <i data-lucide="tag" class="w-12 h-12 text-green-500 drop-shadow-md"></i>
                                    <span class="text-sm font-medium text-green-700">รูปภาพ Nameplate</span>
                                    <span class="text-xs text-green-600">คลิกหรือลากไฟล์มาวาง</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button type="button"
                            class="px-4 py-2 text-sm font-medium text-red-700 bg-red-50 border border-red-300 rounded-lg hover:bg-red-100 active:scale-95 transition-all"
                            id="img-only-btn">สร้างเฉพาะรูปภาพ</button>
                    </div>
                    <input type="file" name="e_img_file" id="e_img_file" hidden>
                </section>
                <section class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow mx-2 mt-4">
                    <div class="border-l-4 border-brand-orange pl-4 mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="file-text" class="w-7 h-7 text-brand-orange"></i>
                            <h2 class="text-2xl font-bold text-gray-800">รายละเอียดใบเสนอราคา</h2>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label for="pr_vender" class="block text-sm font-medium text-gray-700">Vender</label>
                            <input type="text" name="pr_vender" id="pr_vender"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_no" class="block text-sm font-medium text-gray-700">เลขใบเสนอราคา</label>
                            <input type="text" name="pr_no" id="pr_no"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_price" class="block text-sm font-medium text-gray-700">ราคาสินค้า/บริการ
                                <span class="text-gray-500 text-xs">(บาท)</span></label>
                            <input type="text" name="pr_price" id="pr_price"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_vat" class="block text-sm font-medium text-gray-700">ภาษีมูลค่าเพิ่ม 7% <span
                                    class="text-gray-500 text-xs">(บาท)</span></label>
                            <input type="text" name="pr_vat" id="pr_vat"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_grand_price" class="block text-sm font-medium text-gray-700">ราคาทั้งสิ้น
                                <span class="text-gray-500 text-xs">(บาท)</span></label>
                            <input type="text" name="pr_grand_price" id="pr_grand_price"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_cm_estimated_send"
                                class="block text-sm font-medium text-gray-700">กำหนดส่งของ <span
                                    class="text-gray-500 text-xs">(วัน)</span></label>
                            <input type="text" name="pr_cm_estimated_send" id="pr_cm_estimated_send"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_cm_standing" class="block text-sm font-medium text-gray-700">กำหนดยืนราคา
                                <span class="text-gray-500 text-xs">(วัน)</span></label>
                            <input type="text" name="pr_cm_standing" id="pr_cm_standing"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr_cm_waranty" class="block text-sm font-medium text-gray-700">การรับประกัน
                                <span class="text-gray-500 text-xs">(วัน)</span></label>
                            <input type="text" name="pr_cm_waranty" id="pr_cm_waranty"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                    </div>
                </section>
                <section
                    class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow mx-2 mt-4 has-checkboxes">
                    <div class="border-l-4 border-brand-orange pl-4 mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="dollar-sign" class="w-7 h-7 text-brand-orange"></i>
                            <h2 class="text-2xl font-bold text-gray-800">ประเภทของค่าใช้จ่ายที่นาเสนอให้ดำเนินการ</h2>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label for="pr-cm"
                                class="block text-sm font-medium text-gray-700">เลือกประเภทค่าใช้จ่าย</label>
                            <select name="pr-cm" id="pr-cm"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400 bg-white">
                                <option value="MAINTENANCE" id="pr_cm_maintenance" selected>MAINTENANCE</option>
                                <option value="REPLACEMENT" id="pr_cm_replacement">REPLACEMENT</option>
                                <option value="ส่งซ่อม" id="pr_cm_vender">ส่งซ่อม</option>
                                <option value="Other" id="pr_cm_other">Other</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="pr_cm_maintenance_ea" class="block text-sm font-medium text-gray-700">จำนวน
                                (ea)</label>
                            <input type="text" name="pr_cm_maintenance_ea" id="pr_cm_maintenance_ea"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400"
                                value="1">
                        </div>
                        <div class="space-y-2 hidden">
                            <label for="pr_cm_other_text" class="block text-sm font-medium text-gray-700">ระบุ</label>
                            <input type="text" name="pr_cm_other_text" id="pr_cm_other_text"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                    </div>
                </section>
                <section
                    class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow mx-2 mt-4 has-checkboxes">
                    <div class="border-l-4 border-brand-orange pl-4 mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="settings" class="w-7 h-7 text-brand-orange"></i>
                            <h2 class="text-2xl font-bold text-gray-800">ความเห็นของทางแผนกวิศวกรรมการแพทย์</h2>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div class="space-y-2">
                            <label for="pr-status"
                                class="block text-sm font-medium text-gray-700">สถานะเครื่องมือ</label>
                            <select name="pr-status" id="pr-status"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400 bg-white">
                                <option value="Normal" id="pr_status_normal">ใช้งานได้ปกติ</option>
                                <option value="Waitpart" id="pr_status_waitpart">รออะไหล่</option>
                                <option value="Vender" id="pr_status_vender">ส่งซ่อมบริษัท</option>
                                <option value="Other" id="pr_status_other">อื่นๆ</option>
                            </select>
                        </div>
                        <div class="space-y-2 md:col-span-2 hidden">
                            <label for="pr_status_other_text"
                                class="block text-sm font-medium text-gray-700">ระบุ</label>
                            <input type="text" name="pr_status_other_text" id="pr_status_other_text"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400">
                        </div>
                        <div class="space-y-2">
                            <label for="pr-process" class="block text-sm font-medium text-gray-700">การดำเนินการ</label>
                            <select name="pr-process" id="pr-process"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-brand-orange focus:border-transparent transition-all shadow-sm hover:border-gray-400 bg-white">
                                <option value="" selected></option>
                                <option value="Waranty" id="pr_process_waranty">อยู่ในรับประกัน</option>
                                <option value="Self" id="pr_process_self">ซ่อมเอง</option>
                                <option value="Vender" id="pr_process_vender">ซ่อมบริษัท</option>
                                <option value="Changepart" id="pr_process_changepart">ควรเปลี่ยนอะไหล่</option>
                                <option value="Other" id="pr_process_other">อื่นๆ</option>
                            </select>
                        </div>
                    </div>
                </section>
                <section class="bg-white rounded-2xl shadow-xl p-6 hover:shadow-2xl transition-shadow mx-2 mt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <label for="1-file-nsmart"
                                class="block text-sm font-medium text-gray-700 text-center">ไฟล์ใบงาน
                                NSmart</label>
                            <input type="file" name="1-file-nsmart" accept="application/pdf" id="1-file-nsmart"
                                class="file w-full px-4 py-3 rounded-lg border-2 border-dashed border-gray-300 hover:border-brand-orange focus:border-brand-orange focus:ring-2 focus:ring-brand-orange/20 transition-all cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-orange file:text-white hover:file:bg-brand-orange-dark file:cursor-pointer">
                            <iframe class="mt-2 rounded-lg border border-gray-200 shadow-sm" frameborder="0" notoolbar=1
                                style="display: none; width: 100%; height: calc(100vw *(1.4142/3.45));"></iframe>
                        </div>
                        <div class="space-y-3">
                            <label for="2-file-quatation"
                                class="block text-sm font-medium text-gray-700 text-center">ไฟล์ใบเสนอราคา</label>
                            <input type="file" name="2-file-quatation" id="2-file-quatation" accept="application/pdf"
                                class="file w-full px-4 py-3 rounded-lg border-2 border-dashed border-gray-300 hover:border-brand-orange focus:border-brand-orange focus:ring-2 focus:ring-brand-orange/20 transition-all cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-orange file:text-white hover:file:bg-brand-orange-dark file:cursor-pointer">
                            <iframe class="mt-2 rounded-lg border border-gray-200 shadow-sm" frameborder="0" notoolbar=1
                                style="display: none; width: 100%; height: calc(100vw *(1.4142/3.45));"></iframe>
                        </div>
                    </div>
                </section>
                <div class="flex justify-center mt-8 pt-4 gap-3 items-center flex-wrap">
                    <button type="submit" class="group relative inline-flex items-center gap-3 px-8 py-2 
                                   bg-gradient-to-r from-yellow-400 to-yellow-500 
                                   text-gray-800 font-bold text-lg rounded-xl 
                                   hover:from-yellow-500 hover:to-yellow-600 
                                   active:scale-95 transition-all shadow-2xl 
                                   hover:shadow-yellow-500/50 min-w-[250px] justify-center">
                        <i data-lucide="file-text" class="w-7 h-7 group-hover:scale-110 transition-transform"></i>
                        <span class="group-hover:scale-110 transition-transform">สร้างไฟล์</span>
                    </button>

                    <button type="button" onclick="openEmailModal()" class="group relative inline-flex items-center gap-3 px-8 py-2 
                                   bg-gradient-to-r from-blue-600 to-blue-700 
                                   text-white font-bold text-lg rounded-xl 
                                   hover:from-blue-700 hover:to-blue-800 
                                   active:scale-95 transition-all shadow-2xl 
                                   hover:shadow-blue-500/50 min-w-[250px] justify-center">
                        <i data-lucide="mail" class="w-7 h-7 group-hover:scale-110 transition-transform"></i>
                        <span class="group-hover:scale-110 transition-transform">ส่งอีเมล</span>
                    </button>
                </div>

                <div class="flex justify-center mt-4">
                    <a id="a-download" target="_blank" style="display: none;" class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white 
                              font-semibold rounded-lg hover:bg-green-700 active:scale-95 
                              transition-all shadow-lg">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        ดาวน์โหลด
                    </a>
                </div>
            </form>

            <div class="mt-6">
                <iframe id="pdf" class="w-full rounded-2xl shadow-2xl border-4 border-white"
                    style="height: calc(100vw * 1.4142); display: none;"></iframe>
            </div>
        </div>
    </main>

    <!-- Email Modal -->
    <div id="emailModal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-2 md:p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-auto">
            <!-- Modal Header -->
            <div
                class="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i data-lucide="send" class="w-6 h-6"></i>
                    <h2 class="text-xl font-bold">Send Email with PDF</h2>
                </div>
                <button onclick="closeEmailModal()" class="hover:bg-white/20 rounded-lg p-2 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <form id="emailForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Sender Name -->
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Sender
                            Name</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <select required id="from_name" name="from_name" type="text" placeholder="John Doe"
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"></select>
                        </div>
                    </div>

                    <!-- Receiver Email -->
                    <div class="space-y-1 hidden">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Recipient
                            Email</label>
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input required id="to_email" name="to_email" type="email" placeholder="client@example.com"
                                class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        </div>
                    </div>
                </div>

                <!-- Subject -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Subject</label>
                    <div class="relative">
                        <i data-lucide="type" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input required id="subject" name="subject" type="text" placeholder="PR Form - Purchase Request"
                            class="w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                            readonly>
                    </div>
                </div>

                <!-- Message with Rich Text Editor -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Message</label>
                    <div id="toolbar-container"
                        class="bg-slate-100 border border-slate-200 rounded-t-xl p-2 flex flex-wrap gap-1">
                        <button type="button" class="ql-bold" title="Bold"></button>
                        <button type="button" class="ql-italic" title="Italic"></button>
                        <button type="button" class="ql-underline" title="Underline"></button>
                        <div class="ql-formats">
                            <select class="ql-header" title="Headers">
                                <option selected>Normal</option>
                                <option value="1">Heading 1</option>
                                <option value="2">Heading 2</option>
                                <option value="3">Heading 3</option>
                            </select>
                        </div>
                        <div class="ql-formats">
                            <button type="button" class="ql-list" value="bullet" title="Bullet List"></button>
                            <button type="button" class="ql-list" value="ordered" title="Numbered List"></button>
                        </div>
                        <button type="button" class="ql-link" title="Link"></button>
                        <button type="button" class="ql-clean" title="Remove Formatting"></button>
                    </div>
                    <div id="messageEditor"
                        class="w-full bg-white border border-slate-200 rounded-b-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                        style="height: 250px; border-top: none;"></div>
                    <textarea id="message" name="message" style="display: none;"></textarea>
                </div>

                <!-- Footer / Status -->
                <div class="flex flex-wrap items-center justify-between pt-4 gap-3 w-full sm:w-auto">
                    <div id="statusArea" class="rounded-lg text-sm"></div>
                    <button type="submit"
                        class="flex-1 sm:flex-none px-4 py-2.5 text-white font-semibold bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="external-link"></i>
                        Send Email
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="autoFillOffCanvas"
        aria-labelledby="autoFillOffCanvasLabel">

        <div class="offcanvas-body p-6">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-4">
                <div class="flex items-center gap-3">
                    <div class="flex-1">
                        <input name="console-code" id="console-code"
                            class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            readonly>
                    </div>
                    <div>
                        <button
                            class="px-4 py-2 bg-yellow-500 text-gray-800 font-medium rounded-lg hover:bg-yellow-600 active:scale-95 transition-all shadow-md flex items-center gap-2"
                            onclick="copy()">
                            <span id="copy-icon"><img width="20" src="https://img.icons8.com/cotton/64/documents.png"
                                    alt="documents" /></span>
                            Copy
                        </button>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <textarea name="input-json" id="input-json"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                        rows="10" placeholder="ข้อมูลจากหน้า Add Update"></textarea>
                </div>
                <div>
                    <button
                        class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 active:scale-95 transition-all shadow-md flex items-center justify-center gap-2"
                        id="input-json-btn">
                        <img width="30" src="https://img.icons8.com/color/48/task--v1.png" alt="task--v1" />
                        กรอกฟอร์ม
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="extraOffCanvas"
        aria-labelledby="extraOffCanvasLabel">
        <div class="offcanvas-body p-6 bg-gray-900 text-white">
            <form id="merge-prmemo-pdf" class="space-y-4 p-4 border border-gray-600 rounded-lg needs-validation"
                novalidate>
                <div class="text-center">
                    <h5 class="text-xl font-bold">รวมไฟล์ MEMO + PR</h5>
                </div>
                <div class="space-y-2">
                    <label for="pr" class="block text-sm font-medium">เลือกไฟล์ PR</label>
                    <input type="file" name="pr" id="pr"
                        class="w-full px-3 py-2 text-sm rounded-lg border border-gray-600 bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:bg-blue-600 file:text-white hover:file:bg-blue-700"
                        accept="application/pdf" required>
                    <div class="invalid-feedback text-red-400">กรุณาเลือกไฟล์ PR</div>
                </div>
                <div class="space-y-2">
                    <label for="memo" class="block text-sm font-medium">เลือกไฟล์ Memo</label>
                    <input type="file" name="memo" id="memo"
                        class="w-full px-3 py-2 text-sm rounded-lg border border-gray-600 bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:bg-blue-600 file:text-white hover:file:bg-blue-700"
                        accept="application/pdf" required>
                    <div class="invalid-feedback text-red-400">กรุณาเลือกไฟล์ Memo</div>
                </div>
                <div>
                    <button type="submit"
                        class="w-full px-4 py-2 bg-yellow-500 text-gray-800 font-semibold rounded-lg hover:bg-yellow-600 active:scale-95 transition-all shadow-md flex items-center justify-center gap-2">
                        <img height="20" src="https://img.icons8.com/3d-fluency/94/pdf.png" alt="pdf" />
                        สร้างไฟล์
                    </button>
                    <div id="merge-download" class="mt-4"></div>
                </div>
            </form>
        </div>
    </div>
    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwnb57VU-CveziAzWMWtFfbnXiX_mZIWJERI_XLLnNEILEgapodymzeFcWcxMry86EA5Q/exec'
        var form_pdf_bytes, font_bytes, signature_bytes, e_img_bytes, e_img_code_bytes, e_img_nameplate_bytes
        $(document).ready(async function () {
            form_pdf_bytes = await fetch('./formPR.pdf').then(res => res.arrayBuffer())
            font_bytes = await fetch('./THSarabun.ttf').then(res => res.arrayBuffer())
            let text = await fetch('./console.js').then(res => res.text())
            $('#console-code').val(text)

            $('#dept').append(depts_array.sort().map(dept => {
                return `<option value="${dept}">${dept}</option>`
            }).join())
            $('#name, #from_name')
                .empty()
                .append($('<option>', { text: 'เลือกชื่อผู้กรอก', value: '', disabled: true, selected: true }))
                .append(staff_name_array.sort().map(name => {
                    let opt = $('<option>', { text: name, value: name })
                    return $(opt).prop('outerHTML')
                }).join(' '))
        })

        $('#search-form').submit(function () {
            event.preventDefault()
            let search = $('#search-input').val()
            if (search == '') {
                return
            } else if (search == 'mdrp') {
                $('#extra-menu-btn').removeClass('d-none')
                $('#search-input').val('')
                return
            }
            Swal.fire({
                icon: 'info',
                title: 'กำลังค้นหา',
                text: 'กรุณารอสักครู่',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            $.getJSON(scriptUrl + '?action=search&search=' + search, function (data) {
                console.log(data);
                if (data.status != 'success') {
                    Swal.fire({
                        icon: 'error',
                        title: 'ไม่พบข้อมูล',
                        text: 'กรุณาตรวจสอบรหัสอีกครั้ง',
                        confirmButtonText: 'ตกลง',
                    })
                    return
                }
                Swal.fire({
                    icon: 'success',
                    title: 'พบข้อมูล',
                    timer: 1000,
                })
                Object.keys(data.data).forEach(key => {
                    let element = $('[name="' + key + '"]')
                    if (element.attr('type') == 'checkbox') {
                        if (data.data[key] == '✓') {
                            element.prop('checked', true)
                        } else {
                            element.prop('checked', false)
                        }
                    } else {
                        fillValue(key, data.data[key])
                    }
                })
                // show pdf in new tab
                let base64 = data.pdf.base64
                let type = data.pdf.type
                let dataurl = 'data:' + type + ';base64,' + base64
                let blob = base64ToBlob(base64, type)
                let blobUrl = URL.createObjectURL(blob) + '#toolbar=1&view=fit'
                $('#download-from-search-btn').attr('href', blobUrl).attr('target', '_blank').parent().removeClass('d-none')

            })
        })

        function base64ToBlob(base64, type) {
            {
                let binary = atob(base64)
                let array = []
                for (let i = 0; i < binary.length; i++) {
                    array.push(binary.charCodeAt(i))
                }
                return new Blob([new Uint8Array(array)], { type: type })
            }
        }


        $('#dept option').not(':disabled').each(function () {
            $(this).val($(this).text());
        });
        $('#input-json').on('keyup', function () {
            // detect enter key
            if (event.keyCode == 13) {
                $('#input-json-btn').click()
            }
        })
        $('#name').change(async function () {
            let name = $(this).val()
            signature_bytes = await fetch('../img_sign/' + name.replace(/ /g, '_') + '.png').then(res => res.arrayBuffer())


        })

        $('#img-only-btn').click(async function () {
            const embedImage = async function (bytes, key) {
                let preview, e_img
                switch (key) {
                    case 'e_img_file':
                        preview = $('#preview-img')
                        break;
                    case 'e_img_code_file':
                        preview = $('#preview-img-code')
                        break;
                    case 'e_img_nameplate_file':
                        preview = $('#preview-img-nameplate')
                        break;
                    default:
                        break;
                }
                if (preview.attr('data-type') == 'png') {
                    e_img = await pdfDoc.embedPng(bytes)
                } else if (preview.attr('data-type') == 'jpg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                } else if (preview.attr('data-type') == 'jpeg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                }
                return e_img
            }
            $.LoadingOverlay("show");
            event.preventDefault()

            if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
            var form = pdfDoc.getForm()
            let imgs_obj = {}
            if (e_img_bytes) {
                imgs_obj['e_img'] = await embedImage(e_img_bytes, 'e_img_file')
            }
            if (e_img_code_bytes) {
                imgs_obj['e_img_code'] = await embedImage(e_img_code_bytes, 'e_img_code_file')
            }
            if (e_img_nameplate_bytes) {
                imgs_obj['e_img_nameplate'] = await embedImage(e_img_nameplate_bytes, 'e_img_nameplate_file')
            }
            if (imgs_obj['e_img']) form.getTextField('e_img').setImage(imgs_obj['e_img'])
            if (imgs_obj['e_img_code']) form.getTextField('e_img_code').setImage(imgs_obj['e_img_code'])
            if (imgs_obj['e_img_nameplate']) form.getTextField('e_img_nameplate').setImage(imgs_obj['e_img_nameplate'])
            form.flatten()
            // remove first page
            pdfDoc.removePage(0)
            var pdfBytes = await pdfDoc.save()
            var pdfdatauri = await pdfDoc.saveAsBase64({ dataUri: true })
            $.LoadingOverlay("hide");
            Swal.fire({
                icon: 'success',
                title: 'สร้างไฟล์เสร็จสิ้น',
                timer: 2000,
                showConfirmButton: false,
            }).then(async () => {
                var iframe = document.getElementById('pdf')
                // open pdf in new small window
                var blob = new Blob([pdfBytes], { type: 'application/pdf' })
                var url = URL.createObjectURL(blob)
                iframe.src = url + '#toolbar=1&view=fitH'
                let e_code = $('#e_me_code').val() ? $('#e_me_code').val() : 'no_code'
                let e_name = $('#e_name').val() ? $('#e_name').val() : 'no_name'
                let dept = $('#dept').val() ? $('#dept').val() : 'no_department'
                let name = 'IMAGE-ONLY-' + e_code + '-' + e_name + '-' + dept + '.pdf'
                $(iframe).show(200)
                $('#a-download').attr('href', url)
                $('#a-download').attr('download', name).show()
                // scroll to pdf
                $('html, body').animate({
                    scrollTop: $(iframe).offset().top
                }, 500);
                pdfDoc = await PDFDocument.load(form_pdf_bytes)
                $('#1-file-nsmart, #2-file-quatation').change()

            })

        })

        $('#pr-cm').change(function () {
            let data_id = $(this).find('option:selected').attr('id')
            $(this).attr('data-id', data_id)
            if (data_id == 'pr_cm_maintenance') {
                $('#pr_cm_maintenance_ea').val('1').parent().show()
            } else {
                $('#pr_cm_maintenance_ea').val('').parent().hide()
            }
            if (data_id == 'pr_cm_other') {
                showOtherFieldInput('pr_cm_other_text')
            } else {
                $('#pr_cm_other_text').val('').parent().hide()
            }

        })
        $('#pr-status').change(function () {
            let data_id = $(this).find('option:selected').attr('id')
            $(this).attr('data-id', data_id)
            if (data_id == 'pr_status_other') {
                showOtherFieldInput('pr_status_other_text')
            } else {
                $('#pr_status_other_text').val('').parent().hide()
            }
        })
        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('click', function () {
            $('#e_img_file').attr('data-id', $(this).attr('id')).click()
        })

        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('dragover', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('bg-info-subtle').addClass('text-bg-info')
        })
        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('dragleave', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('text-bg-info').addClass('bg-info-subtle')
        })

        $('#e_img_div, #e_img_code_div, #e_img_nameplate_div').on('drop', function (e) {
            e.preventDefault()
            e.stopPropagation()
            let dataID = $(this).attr('id')
            $('#e_img_file').attr('data-id', dataID)

            let preview = $('#' + dataID + ' img')
            $('#' + dataID).LoadingOverlay('show')
            // check if file is url
            if (e.originalEvent.dataTransfer.getData('text/uri-list')) {
                // $('#' + dataID).LoadingOverlay('hide')
                // Swal.fire({
                //     icon: 'warning',
                //     title: 'ผิดพลาด',
                //     text: 'เนื่องจาก NSmart ป้องกันการดึงภาพโดยตรง กรุณาบันทึกภาพลงคอมพิวเตอร์ และเลือกจากคอมพิวเตอร์เท่านั้น',
                //     confirmButtonText: 'ตกลง',
                // })
                // return


                preview.attr('src', e.originalEvent.dataTransfer.getData('text/uri-list'))
                preview.removeClass('hidden') // Show the preview image
                // check if src is base64
                if (preview.attr('src').includes('base64')) {
                    let base64 = preview.attr('src').split(',')[1]
                    let type = preview.attr('src').split(';')[0].split(':')[1]
                    let file = new File([base64ToArrayBuffer(base64)], 'filename.' + preview.attr('src').split(',')[0].split('/')[1].split(';')[0], {
                        type: type,
                        lastModified: Date.now()
                    })
                    compressImage(file, dataID, preview)
                    return
                }
            }
            let file = e.originalEvent.dataTransfer.files[0]
            // convert file to src
            preview.attr('src', URL.createObjectURL(file))
            preview.removeClass('hidden') // Show the preview image
            if (!file) {
                return
            }
            compressImage(file, dataID, preview)
        })

        $('#e_img_file').change(function () {
            let dataID = $('#e_img_file').attr('data-id')
            let preview = $('#' + dataID + ' img')
            $('#' + dataID).LoadingOverlay('show')
            let file = $(this)[0].files[0]
            let quality = getCompressionQuality(file)
            new Compressor(file, {
                quality: quality,

                // The compression process is asynchronous,
                // which means you have to access the `result` in the `success` hook function.
                success(result) {
                    let reader = new FileReader()

                    reader.onloadend = function (e) {
                        preview.attr('src', e.target.result).attr('data-type', file.type.split('/')[1])
                        preview.removeClass('hidden') // Show the preview image
                        setImageBytes(dataID, e.target.result)
                        $('#' + dataID).LoadingOverlay('hide')

                    }
                    reader.readAsDataURL(result)
                },
                error(err) {
                    console.log(err.message);
                },
            });
        })
        // $('#autoFillOffCanvas').offcanvas('show')

        $('#pr_price').on('keyup', function () {
            let price = $(this).val()
            let vat = price * 0.07
            let total = price * 1.07
            if (isNaN(price)) return
            if (isNaN(vat)) return
            if (isNaN(total)) return
            $('#pr_vat').val(vat.toFixed(2))
            $('#pr_grand_price').val(total.toFixed(2))
        })
        $('#pr_vat').on('keyup', function () {
            let vat = $(this).val()
            let total = Number($('#pr_price').val()) + Number(vat)
            if (isNaN(vat)) return
            if (isNaN(total)) return
            $('#pr_grand_price').val(total.toFixed(2))
        })

        function showOtherFieldInput(key) {
            Swal.fire({
                title: 'ระบุ อื่นๆ',
                input: 'text',
                inputLabel: 'ระบุ',
                inputPlaceholder: 'ระบุ',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) {
                        return 'กรุณากรอกข้อมูล'
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#' + key).val(result.value).parent().show()
                }
            })
        }

        function base64ToArrayBuffer(base64) {
            var binaryString = atob(base64);
            var bytes = new Uint8Array(binaryString.length);
            for (var i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            return bytes.buffer;
        }

        function getCompressionQuality(file) {
            let quality = 0.3
            switch (true) {
                case file.size / 1024 <= 200:
                    quality = 0.8
                    break;

                case file.size / 1024 <= 600:
                    quality = 0.6
                    break;

                case file.size / 1024 <= 2000:
                    quality = 0.4
                    break;
                default:
                    quality = 0.3
                    break;
            }
            return quality
        }

        function setImageBytes(dataID, file) {
            if (typeof file == 'string') file = base64ToArrayBuffer(file.split(',')[1])
            switch (dataID) {
                case 'e_img_div':
                    e_img_bytes = file
                    break;
                case 'e_img_code_div':
                    e_img_code_bytes = file
                    break;
                case 'e_img_nameplate_div':
                    e_img_nameplate_bytes = file
                    break;
                default:
                    break;
            }
        }
    </script>
    <script>
        var pdfDoc
        var PDFDocument = PDFLib.PDFDocument;
        var StandardFonts = PDFLib.StandardFonts;
        var pdfFiles = []
        $('#1-file-nsmart, #2-file-quatation').on('dragover', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).addClass('text-bg-info')
        })
        $('#1-file-nsmart, #2-file-quatation').on('dragleave', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('text-bg-info')
        })
        $('#1-file-nsmart, #2-file-quatation').on('drop', function (e) {
            e.preventDefault()
            e.stopPropagation()
            $(this).removeClass('from-control-lg')
            let files = e.originalEvent.dataTransfer.files
            let file = files[0]
            if (!file) return;
            // set files to $(this)
            $(this).prop('files', files)
            renderNsmartFile(file, $(this))
        })

        $('#1-file-nsmart, #2-file-quatation').on('change', function (e) {
            let files = e.target.files
            let file = files[0]
            if (!file) return;
            renderNsmartFile(file, $(this))
        })

        function renderNsmartFile(file, ele) {
            if (file.type != 'application/pdf') {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกไฟล์ PDF',
                    text: 'ไฟล์ที่เลือกไม่ใช่ PDF',
                })
                return
            }
            if (file.size > 10000000) {
                Swal.fire({
                    icon: 'error',
                    title: 'ไฟล์มีขนาดใหญ่เกินไป',
                    text: 'ไฟล์มีขนาดใหญ่เกิน 10 MB',
                })
                return
            }
            let obj = $(ele)
            let id = obj.attr('id')
            let reader = new FileReader()
            reader.onloadend = async function (e) {
                if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
                pdfFiles[id] = e.target.result
                // load pdf
                let pdf = await PDFDocument.load(e.target.result)
                let pages = pdf.getPages().length
                for (var i = 0; i < pages; i++) {
                    let [page] = await pdfDoc.copyPages(pdf, [i])
                    // pdfDoc.insertPage(1, page)
                    // insert at the end
                    pdfDoc.addPage(page)
                }
                pdf = await pdf.save()
                let iframe = $(obj).parent().find('iframe')[0]
                var blob = new Blob([pdf], {
                    type: 'application/pdf'
                })
                var url = URL.createObjectURL(blob)
                iframe.src = url + '#toolbar=1&view=fitH'

                $(iframe).show()

            }
            reader.readAsArrayBuffer(file);
        }

        $('#myForm').submit(async function () {
            const { form_obj, pdfBytes, form_pdf_bytes } = await createPDF()
            $.ajax({
                url: scriptUrl,
                type: 'POST',
                data: {
                    opt: 'save',
                    form_obj: JSON.stringify(form_obj)
                }
            })
            $.LoadingOverlay("hide");
            Swal.fire({
                icon: 'success',
                title: 'สร้างไฟล์เสร็จสิ้น',
                timer: 1000,
                showConfirmButton: false,
            }).then(async () => {
                var iframe = document.getElementById('pdf')
                // open pdf in new small window
                var blob = new Blob([pdfBytes], { type: 'application/pdf' })
                var url = URL.createObjectURL(blob)
                iframe.src = url + '#toolbar=1&view=fitH'
                let e_code = $('#e_me_code').val() ? $('#e_me_code').val() : 'no_code'
                let e_name = $('#e_name').val() ? $('#e_name').val() : 'no_name'
                let dept = $('#dept').val() ? $('#dept').val() : 'no_department'
                let name = 'PR-' + e_code + '-' + e_name + '-' + dept + '.pdf'
                $(iframe).show(200)
                $('#a-download').attr('href', url)
                $('#a-download').attr('download', name).show()
                // scroll to pdf
                $('html, body').animate({
                    scrollTop: $(iframe).offset().top
                }, 500);
                pdfDoc = await PDFDocument.load(form_pdf_bytes)
                $('#1-file-nsmart, #2-file-quatation').change()

            })
            // $('#a-download').attr('href', pdfDataUri)
            // $('#a-download').attr('download', name).show()
        })

        async function createPDF() {
            const embedImage = async function (bytes, key) {
                let preview, e_img
                switch (key) {
                    case 'e_img_file':
                        preview = $('#preview-img')
                        break;
                    case 'e_img_code_file':
                        preview = $('#preview-img-code')
                        break;
                    case 'e_img_nameplate_file':
                        preview = $('#preview-img-nameplate')
                        break;
                    default:
                        break;
                }
                if (preview.attr('data-type') == 'png') {
                    e_img = await pdfDoc.embedPng(bytes)
                } else if (preview.attr('data-type') == 'jpg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                } else if (preview.attr('data-type') == 'jpeg') {
                    e_img = await pdfDoc.embedJpg(bytes)
                }
                return e_img
            }
            $.LoadingOverlay("show");
            event.preventDefault()

            if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
            var form = pdfDoc.getForm()
            pdfDoc.registerFontkit(fontkit);
            const sarabun = await pdfDoc.embedFont(font_bytes, { subset: true })
            const symbol = await pdfDoc.embedFont(StandardFonts.ZapfDingbats, { subset: true })
            var signature, e_img
            if (signature_bytes) {
                signature = await pdfDoc.embedPng(signature_bytes)
            }
            let imgs_obj = {}
            if (e_img_bytes) {
                imgs_obj['e_img'] = await embedImage(e_img_bytes, 'e_img_file')
            }
            if (e_img_code_bytes) {
                imgs_obj['e_img_code'] = await embedImage(e_img_code_bytes, 'e_img_code_file')
            }
            if (e_img_nameplate_bytes) {
                imgs_obj['e_img_nameplate'] = await embedImage(e_img_nameplate_bytes, 'e_img_nameplate_file')
            }
            const setText = (inputId, pdfElementId) => {
                let val = $('#' + inputId).val()
                if (val == '' || val == null || val == undefined) return
                let pdfElement = form.getTextField(pdfElementId)
                if (val.length >= 45) pdfElement.setFontSize(10)
                else if (val.length >= 35) pdfElement.setFontSize(11)
                else if (val.length >= 29) pdfElement.setFontSize(12)
                pdfElement.setText(val)
            }

            form.getTextField('pwarm').setText('คุณภูครินทร์ ทองเกลี้ยง')
            form.getTextField('BME').setText('แผนกวิศวกรรมการแพทย์ โรงพยาบาลพญาไท 3')
            form.getTextField('pr_date').setText((new Date().toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }).toLocaleUpperCase()))
            form.getTextField('pr_date_short').setText((new Date().toLocaleDateString('en-GB', { year: 'numeric', month: 'numeric', day: 'numeric' })))
            $('form#myForm input').not('input[type="search"]').each(function () {
                let _this = $(this)
                if (_this.val() == '') return
                if (['e_manufacturer', 'e_sn', 'e_img_file', '1-file-nsmart', '2-file-quatation'].includes(_this.prop('id'))) return
                if (['pr_price', 'pr_vat', 'pr_grand_price', 'pr_cm_vender'].includes(_this.prop('id'))) {
                    let value = Number(_this.val())
                    if (value != NaN) {
                        value = value.toFixed(2).split('.')

                        value[0] = Number(value[0]).toLocaleString()

                        form.getTextField(_this.prop('id')).setText(value.join('.'))
                    }
                    return
                }
                if (_this.prop('id') == 'e_brand/model') {
                    let val = _this.val().split('/')
                    form.getTextField('e_brand').setText(val[0])
                    form.getTextField('e_model').setText(val[1])
                    return
                }

                if (_this.prop('id') == 'e_name') {
                    setText('e_name', 'e_name')
                    return
                }
                form.getTextField(_this.prop('id')).setText(_this.val())
            })
            $('.has-checkboxes option:checked').each(function () {
                if ($(this).prop('id') == '') {
                    return
                }
                let parent_id = $(this).parent().prop('id')
                if (parent_id == 'pr-cm') {
                    let val = $(this).text()
                    if (val == 'ส่งซ่อม') {
                        form.getTextField('pr_cm_other_text').setText('ส่งซ่อม')
                    }
                }
                let id = $(this).prop('id')
                if (id == 'pr_cm_vender') id = 'pr_cm_other'
                let textField = form.getTextField(id)
                textField.setText('✓')
                textField.updateAppearances(symbol)
            })
            // if (signature && $('#name').val() == 'DARANPHOP YIMYAM') form.getTextField('bme_sign').setImage(signature)
            if (signature) form.getTextField('bme_sign').setImage(signature)
            if (imgs_obj['e_img']) form.getTextField('e_img').setImage(imgs_obj['e_img'])
            if (imgs_obj['e_img_code']) form.getTextField('e_img_code').setImage(imgs_obj['e_img_code'])
            if (imgs_obj['e_img_nameplate']) form.getTextField('e_img_nameplate').setImage(imgs_obj['e_img_nameplate'])
            form.updateFieldAppearances(sarabun);
            form.flatten()
            if (!e_img_bytes && !e_img_code_bytes && !e_img_nameplate_bytes) {
                // remove last page
                pdfDoc.removePage(pdfDoc.getPages().length - 1)
            }
            var pdfBytes = await pdfDoc.save()
            var pdfdatauri = await pdfDoc.saveAsBase64({ dataUri: true })
            let form_obj = {}
            $('#myForm input:not([type="file"]), select').each(function () {
                form_obj[$(this).attr('name')] = $(this).val()
            })
            form_obj['pdfFile'] = pdfdatauri
            return { form_obj, pdfBytes, form_pdf_bytes }
        }

        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }

        function compressImage(file, dataID, preview) {
            let quality = getCompressionQuality(file)
            new Compressor(file, {
                quality: quality,
                success(result) {
                    let fr = new FileReader()
                    fr.onload = function (e) {
                        setImageBytes(dataID, e.target.result)
                        preview.attr('data-type', file.type.split('/')[1])
                        $('#' + dataID).LoadingOverlay('hide')
                    }
                    fr.readAsDataURL(result)
                },
                error(err) {
                    console.log(err.message);
                },
            });
        }
    </script>
    <script>
        let autoFillCheckInterval = null;

        // New streamlined auto fill process
        async function autoFillProcess() {
            // Auto copy the code using modern clipboard API
            let str = $('#console-code').val()

            try {
                await navigator.clipboard.writeText(str)

                let Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: false
                })
                Toast.fire({
                    icon: 'success',
                    title: 'Copied!'
                })
            } catch (err) {
                // Fallback to old method if clipboard API fails
                $('#console-code')[0].select()
                document.execCommand("copy")

                let Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: false
                })
                Toast.fire({
                    icon: 'success',
                    title: 'Copied!'
                })
            }

            // Check if document is blurred
            $(document).one('visibilitychange', function () {
                if (document.visibilityState !== 'visible') {
                    console.log('Document is hidden, waiting for focus to start monitoring...');
                    startAutoFillMonitoring();
                }
            });

            // Start monitoring for pasted data
            // startAutoFillMonitoring();
        }

        // Monitor clipboard for pasted data
        function startAutoFillMonitoring() {
            // Clear any existing interval
            if (autoFillCheckInterval) {
                clearInterval(autoFillCheckInterval)
            }
            autoFillCheckInterval = setInterval(async () => {
                isDocumentFocused = document.hasFocus();
                if (!isDocumentFocused) {
                    return; // Skip checking if document is not focused
                }
                try {
                    let clipboardText = await navigator.clipboard.readText()
                    if (clipboardText && clipboardText.startsWith('{') && clipboardText.endsWith('}')) {
                        clearInterval(autoFillCheckInterval)
                        $('#input-json').val(clipboardText)
                        $('#input-json-btn').click()
                    }
                } catch (err) {
                    console.error('Failed to read clipboard contents: ', err);
                }
            }, 1000)
        }

        // Keep the old copy function for the manual copy button
        function copy() {
            $('#console-code')[0].select()
            document.execCommand("copy")
            let Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: false
            })
            Toast.fire({
                icon: 'success',
                title: 'คัดลอกสำเร็จ'
            })
        }

        $('#input-json-btn').click(function () {
            let json_text = $('#input-json').val()
            let obj = JSON.parse(json_text)
            if (obj.page == 'addupdate') {
                fillValue('e_name', obj.name)
                fillValue('dept', obj.dept)
                fillValue('e_manufacturer', obj.brand)
                fillValue('e_date', obj.recieve_date)
                fillValue('e_hospital_code', obj.hos_id)
                fillValue('e_brand/model', ['/', obj.brand, obj.model])
                fillValue('e_brand/distributor', obj.sup_sale)
                fillValue('e_sn', obj.sn_no)
                fillValue('e_me_code', obj.id)
                fillValue('e_price', obj.price)
                fillValue('pr_vender', obj.pr_vender)
                if (obj.imgs) {
                    let imgs = JSON.parse(obj.imgs)
                    if (imgs.length > 0) {
                        $('#imgs_row, #head_imgs_row').remove()
                        let head_row = $('<div>').addClass('grid grid-cols-12 mt-3 gap-3').attr('id', 'head_imgs_row')
                        let row = $('<div>').addClass('grid grid-cols-12 mt-2 gap-3').attr('id', 'imgs_row')
                        head_row.append($('<div>').addClass('col-span-12 text-center').append($('<h5>').text('ลากภาพใส่ช่องที่ต้องการ')))
                        imgs.forEach(img => {
                            let col = $('<div>').addClass('col-span-2')
                            let imgEle = $('<img>').addClass('w-full h-auto nsmart-img').attr('src', img).attr('loading', 'lazy')
                            col.append(imgEle)
                            row.append(col)
                        })
                        $('#e_name').closest('section').append(head_row).append(row)
                    }
                }
            } else if (obj.page == 'closejob') {
                fillValue('pr_no', obj.quatation)
                fillValue('pr_price', obj.base_price)
                fillValue('pr_vat', obj.vat)
                fillValue('pr_grand_price', obj.price)
                fillValue('job_id', obj.job_no)
            }

            $('#input-json').val('')
            $('#autoFillOffCanvas').offcanvas('hide')
        })

        function fillValue(id, value) {
            if (Array.isArray(value)) {
                let chain = value.shift()
                value = value.map((v) => {
                    return v ? v : ''
                })
                return fillValue(id, value.join(chain))
            }
            if (!value || value == '') value = 'N/A'
            if($('#' + $.escapeSelector(id)).is('select')) {
                $('#' + $.escapeSelector(id)).trigger('change')
            }
            $('[id="' + id + '"]').val(value).removeClass('bg-white').addClass('bg-blue-50')
        }

        async function mergePRMrmo() {
            let pr, memo
            event.preventDefault()
            let pr_file = await new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => {
                    pr = $('#pr').prop('files')[0].name
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer($('#pr').prop('files')[0])
            })
            let memo_file = await new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => {
                    memo = $('#memo').prop('files')[0].name
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer($('#memo').prop('files')[0])
            })

            // merge pdf
            let PDFDocument = PDFLib.PDFDocument;

            const pdf1 = await PDFDocument.load(memo_file);
            const pdf2 = await PDFDocument.load(pr_file);
            const pdfDoc = await PDFDocument.create();
            const copiedPagesA = await pdfDoc.copyPages(pdf1, pdf1.getPageIndices());
            copiedPagesA.forEach((page) => pdfDoc.addPage(page));
            const copiedPagesB = await pdfDoc.copyPages(pdf2, pdf2.getPageIndices());
            copiedPagesB.forEach((page) => pdfDoc.addPage(page));

            const mergedPdfFile = await pdfDoc.save();
            var blob = new Blob([mergedPdfFile], { type: 'application/pdf' })
            var url = URL.createObjectURL(blob)
            console.log(memo.split('_').slice(0, -1).join('_'));
            let a = $('<a>', { href: url, download: `[อนุมัติ PR][${memo.split('_').slice(0, -1).join('_')}] ${pr.split('.')[0]}.pdf`, class: 'btn btn-success btn-sm w-100', text: 'ดาวน์โหลดไฟล์' })
            $('#merge-download').html('').append(a)

        }
    </script>
    <script>
        (() => {
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            const forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    event.preventDefault()
                    if (!form.checkValidity()) {
                        event.stopPropagation()
                        form.classList.add('was-validated')
                        $(form).find(":invalid").first().focus();
                    } else {
                        if ($(form).attr('id') == 'merge-prmemo-pdf') {
                            mergePRMrmo()
                            return
                        }
                        $(form).submit()
                    }

                }, false)
            })
        })()
    </script>
    <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="//fastly.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://fastly.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // Email Modal Functions
        var quillEditor = null;

        function openEmailModal() {
            const modal = $('#emailModal');
            modal.removeClass('hidden').addClass('flex');

            const jobId = $('#job_id').val() || 'N/A';
            $('#subject').val("ขออนุมัติ PR - " + jobId);

            // Initialize Quill editor on first open
            if (!quillEditor) {
                quillEditor = new Quill('#messageEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: '#toolbar-container'
                    },
                    placeholder: 'Type your message here...'
                });
                quillEditor.root.style.fontSize = '16px';
            }

            $('#from_name').on('change', function () {
                if (quillEditor) {
                    const delta = quillEditor.getContents();
                    const ops = delta.ops;
                    ops[ops.length - 1] = { insert: `\n${$('#from_name').val()}\n` }
                    quillEditor.setContents(delta);
                }
            });

            // Clear previous content and set default message
            quillEditor.setContents([
                { insert: 'เรียน หัวหน้าแผนกเครื่องมือแพทย์ คุณ' + supervisor_name + '\n\n', attributes: { bold: true } },
                { insert: ' ' },
                { insert: 'ตามที่ข้าพเจ้าได้ดำเนินการตรวจสอบเครื่องมือแพทย์และจัดทำใบขออนุมัติซื้อ (PR) สำหรับเครื่องมือแพทย์ดังกล่าว โดยมีรายละเอียดดังนี้:\n\n' },
                { insert: `ชื่อเครื่องมือแพทย์: ${$('#e_name').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `รหัสเครื่องมือแพทย์: ${$('#e_me_code').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `แผนกที่ใช้งาน: ${$('#dept').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `อาการเสีย: ${$('#pr_failure').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `ผลการตรวจเช็ค: ${$('#pr_result').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `การดำเนินการ: ${$('#pr_recommend').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `Vender: ${$('#pr_vender').val() || "-"}\n`, attributes: { list: 'bullet' } },
                { insert: `ราคาสินค้า/บริการ: ${$('#pr_grand_price').val() || "-"} บาท\n`, attributes: { list: 'bullet' } },
                { insert: '\nรายละเอียดเพิ่มเติมและไฟล์แนบ PR อยู่ในเอกสารที่แนบมานี้ กรุณาตรวจสอบและอนุมัติการซื้อตามความเหมาะสม\n\n' },
                { insert: 'ขอแสดงความนับถือ\n', attributes: { italic: true } },
                { insert: `${$('#from_name').val()}\n` }
            ]);

            // Re-initialize lucide icons for modal content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function closeEmailModal() {
            const modal = $('#emailModal');
            modal.addClass('hidden').removeClass('flex');
        }

        // Handle email form submission
        $('#emailForm').on('submit', async function (e) {
            e.preventDefault();

            const statusArea = $('#statusArea');

            try {
                const from_name = $('#from_name').val();
                const to_email = $('#to_email').val();
                const subject = $('#subject').val();
                const message = quillEditor ? quillEditor.root.innerHTML : $('#message').val();

                if (!from_name || !subject || !message) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Fields',
                        text: 'Please fill all required fields',
                        customClass: {
                            popup: 'rounded-xl'
                        }
                    });
                    return;
                }

                statusArea.html('<p class="text-sm text-blue-600 font-semibold flex items-center gap-2"><i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Sending email...</p>');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                const { form_obj, pdfBytes, form_pdf_bytes } = await createPDF();
                const code = $('#e_me_code').val() ? $('#e_me_code').val() : 'no_code';
                const name = $('#e_name').val() ? $('#e_name').val() : 'no_name';
                const dept = $('#dept').val() ? $('#dept').val() : 'no_department';
                const jobId = $('#job_id').val() || 'PR';
                const fileName = `PR_\${jobId}_\${name}, \${dept}.pdf`;
                const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });

                // Get form data
                const formData = {
                    from_name: $('#from_name').val(),
                    subject: $('#subject').val(),
                    message: quillEditor ? quillEditor.root.innerHTML : $('#message').val(),
                    pdf_data: pdfDataUri || null,
                    pdf_name: fileName
                };

                // Send email via Google Apps Script
                await Promise.all([
                    $.ajax({
                        url: scriptUrl,
                        type: 'POST',
                        data: {
                            opt: 'save',
                            form_obj: JSON.stringify(form_obj)
                        }
                    }),
                    $.ajax({
                        url: scriptUrl,
                        type: 'POST',
                        data: {
                            opt: 'sendEmail',
                            ...formData,
                        }
                    })
                ]);

                // Show success message
                statusArea.html('<p class="text-sm text-green-600 font-semibold flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Email sent successfully!</p>');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Reset form after 2 seconds
                setTimeout(() => {
                    emailForm[0].reset();
                    closeEmailModal();
                }, 2000);

            } catch (error) {
                console.error('Email send error:', error);
                statusArea.html('<p class="text-sm text-red-600 font-semibold flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i> Failed to send email</p>');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } finally {
                // Re-enable submit button
                $('#emailForm button[type="submit"]').prop('disabled', false);
            }
        });

        // Initialize lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Close modal on outside click
        const emailModal = $('#emailModal');
        if (emailModal.length) {
            emailModal.on('click', function (e) {
                if (e.target === this) {
                    closeEmailModal();
                }
            });
        }

        // Populate sender name dropdown from name select
        $(document).ready(function () {
            const nameOptions = $('#name option').clone();
            $('#from_name').append(nameOptions);

            // Sync name field with from_name
            $('#name').on('change', function () {
                $('#from_name').val($(this).val());
            });

            // Store sender name in localStorage
            $('#from_name').on('change', function () {
                localStorage.setItem('pr_email_sender_name', $(this).val());
            });

            if (localStorage.getItem('pr_email_sender_name')) {
                $('#from_name').val(localStorage.getItem('pr_email_sender_name'));
            }
        });
    </script>
</body>

</html>