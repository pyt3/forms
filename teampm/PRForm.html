<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/pdf-lib@1.4.0/dist/pdf-lib.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <!-- icon -->
    <link rel="icon" href="https://img.icons8.com/3d-fluency/94/move-by-trolley.png" type="image/x-icon" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: 'Prompt', sans-serif;
            background-color: #e9b33b;
            /* background-color: #D3D3D3; */
        }

        #sticker {
            width: 100%;
            height: 100%;
        }
    </style>
    <title>PR Form</title>
</head>

<body>
    <header>
        <div class="container-fluid d-flex flex-column align-items-center justify-content-center w-100 mt-4">
            <div class="col-auto">
                <img width="80" src="https://img.icons8.com/3d-fluency/94/move-by-trolley.png" alt="move-by-trolley"/>
            </div>

            <div class="col text-center">
                <h4 class="h1 fw-bold text-light">PR Form</h4>
            </div>
        </div>
    </header>
    <main>
        <div class="container-fluid">
            <form id="myForm" class="mt-3 mb-5">
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow">
                    <div class="row justify-content-end">
                        <div class="col-md-3 text-end">
                            <button class="btn btn-primary" id="auto-fill" type="button" data-bs-toggle="offcanvas"
                                data-bs-target="#autoFillOffCanvas" aria-controls="autoFillOffCanvas">Auto Fill</button>
                        </div>
                    </div>
                    <div class="row justify-content-start">
                        <div class="col-md-4 mt-3">
                            <label for="e_name">ชื่อเครื่องมือ</label>
                            <input type="text" name="e_name" id="e_name" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="dept">แผนก</label>
                            <select name="dept" id="dept" class="form-select">
                                <option value="" disabled selected>Select value</option>
                                <option>ANESTHESIA (วิสัญญี)</option>
                                <option>ART-LAB (ศูนย์ผู้มีบุตรยาก)</option>
                                <option>BME-PYT3</option>
                                <option>CATH-LAB</option>
                                <option>CHECK-UP (ตรวจสุขภาพ)</option>
                                <option>CORPORATE CUSTOMER SERVICE</option>
                                <option>CSSD (จ่ายกลาง)</option>
                                <option>DENTAL (ทันตกรรม)</option>
                                <option>DIABETIC&amp;METABOLIC(เบาหวาน)</option>
                                <option>EENT( หูตาคอจมูก)</option>
                                <option>EMERGENCY( ฉุกเฉิน)</option>
                                <option>GASTROINTESTINAL LABORATORY(GI)</option>
                                <option>HEMODIALYSIS (ไตเทียม)</option>
                                <option>HOPD CENTER (ศุนย์มะเร็ง)</option>
                                <option>INFECTION CONTROL ( IC)</option>
                                <option>INTENSIVE CARE UNIT(ผู้ป่วยหนัก)</option>
                                <option>LABOR ROOM(ห้องคลอด)</option>
                                <option>LABORATORY</option>
                                <option>MAID</option>
                                <option>MARKETING</option>
                                <option>NURSERY(เด็กอ่อน)</option>
                                <option>NURSING DEPARTMENT</option>
                                <option>OBSERVE(สังเกตอาการ)</option>
                                <option>OPD CARDIO(ศูนย์หัวใจ)</option>
                                <option>OPD COUNTER NURSE (CN คัดกรอง)</option>
                                <option>OPD HEAD NECK BREAST(ศุนย์เต้านม)</option>
                                <option>OPD MEDICINE(อายุกรรม)</option>
                                <option>OPD NEURO (ศูนย์สมอง)</option>
                                <option>OPD OB/GYN(ศุนย์สุขภาพหญิง)</option>
                                <option>OPD PEDIATRIC( แผนกเด็ก)</option>
                                <option>OPD SURGERY(ศัลยกรรม)</option>
                                <option>OPD UROLOGY (ทางเดินปัสสาวะ)</option>
                                <option>OPERATING ROOM(ห้องผ่าตัด)</option>
                                <option>PHARMARCY(เภสัชกรรม ห้องยา)</option>
                                <option>PHYATHAI BEAUTY CENTER (PBC ความงาม)</option>
                                <option>PHYSICAL THERAPY( กายภาพ)</option>
                                <option>PICU</option>
                                <option>PWA LIFE CENTER</option>
                                <option>PWA ชะลอวัย</option>
                                <option>WARD 10</option>
                                <option>WARD 11</option>
                                <option>WARD 12</option>
                                <option>WARD 14</option>
                                <option>WARD 15</option>
                                <option>WARD 17</option>
                                <option>WARD 7</option>
                                <option>WARD 8</option>
                                <option>WARD 9</option>
                                <option>X-RAY</option>
                                <option>รับส่ง</option>
                                <option>ห้องเก็บของชั้น 19</option>
                            </select>
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_manufacturer">ผู้ผลิต</label>
                            <input type="text" name="e_manufacturer" id="e_manufacturer" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_date">วันที่ซื้อ</label>
                            <input type="text" name="e_date" id="e_date" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_hospital_code">หมายเลขทรัพย์สิน</label>
                            <input type="text" name="e_hospital_code" id="e_hospital_code" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_brand/model">ยี่ห้อ/รุ่น</label>
                            <input type="text" name="e_brand/model" id="e_brand/model" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_sn">เลขเครื่อง (SN)</label>
                            <input type="text" name="e_sn" id="e_sn" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_me_code">หมายเลขเครื่อง (ME Code)</label>
                            <input type="text" name="e_me_code" id="e_me_code" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_brand/distributor">ตัวแทนจำหน่าย</label>
                            <input type="text" name="e_brand/distributor" id="e_brand/distributor" class="form-control">
                        </div>
                        <div class="col-md-4 mt-3">
                            <label for="e_price">ราคาซื้อ</label>
                            <input type="text" name="e_price" id="e_price" class="form-control">
                        </div>
                    </div>
                </section>
                <section class="m-2 mt-4 rounded-2 bg-light p-4 shadow">
                    <div class="row justify-content-center align-items-start">
                        <div class="col-md-4 mt-3 text-center">
                            <label for="1-file-nsmart">ไฟล์ใบงาน NSmart</label>
                            <input type="file" name="1-file-nsmart" accept="application/pdf" id="1-file-nsmart"
                                class="form-control file">
                        </div>
                        <div class="col">
                            <iframe src="" frameborder="0" class="w-100" style="height: 500px; display: none;"></iframe>
                        </div>
                    </div>
                </section>
                <div class="row justify-content-center">
                    <div class="col-md-4 mt-3 text-center">
                        <button type="submit" class="btn btn-warning btn-lg shadow" style="min-width: 200px;"><img width="40" src="https://img.icons8.com/3d-fluency/94/pdf.png" alt="pdf"/> สร้างไฟล์</button>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-4 mt-3 mb-4 text-center">
                        <a id="a-download" target="_blank" style="display: none;" class="fw-bold">ดาวน์โหลด</a>
                    </div>
                </div>
            </form>
            <iframe id="pdf" style="width: 100%; height: calc(100vw *(1.4142)); display: none;"></iframe>
        </div>
    </main>

    <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="autoFillOffCanvas"
        aria-labelledby="autoFillOffCanvasLabel">

        <div class="offcanvas-body container-fluid">
            <div class="alert alert-info" role="alert">
                <div class="row">
                    <div class="col m-0">
                        <input name="console-code" id="console-code" class="form-control" value='console.clear(),console.group("START");const getselectOpt=e=>e.options[e.selectedIndex].innerText,copy=e=>{console.log("Copying to clipboard...");let t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),console.log("END"),console.groupEnd()};console.log("Getting data...");let obj={id:document.getElementsByName("sap_code")[0].value,name:(e=>e.options[e.selectedIndex].innerText)(document.getElementsByName("catagory")[0]),brand:document.getElementsByName("brand")[0].value,model:document.getElementsByName("model")[0].value,sn_no:document.getElementsByName("serial_no")[0].value,dept:(e=>e.options[e.selectedIndex].innerText)(document.getElementsByName("sub_dept")[0]),recieve_date:document.getElementsByName("receive_date")[0].value,warranty_end:document.getElementsByName("w_finish_date_repair_part")[0].value,price:document.getElementsByName("price")[0].value,hos_id:document.getElementsByName("code_equip")[0].value,sup_sale:(e=>e.options[e.selectedIndex].innerText)(document.getElementsByName("sup_sale")[0])},str=JSON.stringify(obj);copy(str);'
                            readonly>
                    </div>
                    <div class="col-auto m-0">
                        <button class="btn btn-primary"
                            onclick="copy()"><span id="copy-icon"><img
                                    width="20" src="https://img.icons8.com/cotton/64/documents.png"
                                    alt="documents" /></span>&nbsp;Copy</button>
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-12">
                    <textarea name="input-json" id="input-json" class="form-control" rows="10"
                        placeholder="ข้อมูลจากหน้า Add Update"></textarea>
                </div>
                <div class="col-12">
                    <button class="btn btn-warning w-100" id="input-json-btn"><img width="30"
                            src="https://img.icons8.com/color/48/task--v1.png" alt="task--v1" /> กรอกฟอร์ม</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            $('#dept option').not(':disabled').each(function () {
                $(this).val($(this).text());
            });
            // $('#autoFillOffCanvas').offcanvas('show')
        })
    </script>
    <script>
        var pdfDoc
        var PDFDocument = PDFLib.PDFDocument;
        $('#myForm').submit(async function () {
            pdfDoc = await PDFDocument.create();
            event.preventDefault()
            let formData = $(this).serializeArray()
            let obj = {}
            formData.forEach(function (e) {
                if (e.value == '') e.value = '-'
                obj[e.name] = e.value
            })
            $('input[type=checkbox]').each(function () {
                if ($(this).is(':checked')) {
                    obj[$(this).attr('name')] = '✓'
                } else {
                    obj[$(this).attr('name')] = ''
                }
            })
            if (sticker.data) obj.e_sticker = JSON.stringify(sticker)
            obj['e_me_code'] = obj['e_me_code'].toUpperCase().indexOf('PYT') > -1 ? obj['e_me_code'].toUpperCase() : ('PYT3_' + ('00000' + obj['e_me_code']).slice(-5))
            obj['e_decom_by'] = obj['e_decom_by'].toUpperCase()
            obj['e_name'] = toTitleCase(obj['e_name'])
            Swal.fire({
                icon: 'info',
                title: 'กำลังสร้างไฟล์...',
                allowOutsideClick: false,
            })
            Swal.showLoading(Swal.getConfirmButton())
            Object.keys(pdfFiles).forEach(async key => {
                let pdf = await PDFDocument.load(pdfFiles[key])
                let pages = pdf.getPages().length
                for (var i = 0; i < pages; i++) {
                    let [page] = await pdfDoc.copyPages(pdf, [i])
                    pdfDoc.insertPage(0, page)
                }
            })
            let scripturl = 'https://script.google.com/macros/s/AKfycbwdHWd3KFg6GMJsNKmVp69oyRAhpzWRjiWxUYFU8QBXoLHkNYM07qUEbR0s5roYpAnHag/exec?opt=save'
            $.ajax({
                url: scripturl,
                type: 'POST',
                data: obj,
                success: function (data) {
                    copyPages(data[0], data[1], data[2])
                }
            })
        })
        var sticker = {}
        $('#e_sticker').change(function () {
            sticker = {}
            var file = this.files[0]
            var reader = new FileReader()
            reader.onload = function (e) {
                sticker.data = e.target.result
                sticker.name = file.name
                $('.img-fluid').attr('src', e.target.result)
                $('.img-fluid').closest('.col-md-4').show()
            }
            reader.readAsDataURL(file)
        })
        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }
    </script>
    <script>
        async function copyPages(url, res, name) {
            var binary_string = window.atob(res);
            var len = binary_string.length;
            var bytes = new Uint8Array(len);
            for (var i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            const firstPDFBytes = bytes.buffer
            const firstPDFDoc = await PDFDocument.load(firstPDFBytes)
            const [firstPDFPage] = await pdfDoc.copyPages(firstPDFDoc, [0])
            pdfDoc.insertPage(0, firstPDFPage)
            const pdfBytes = await pdfDoc.save()
            const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
            Swal.fire({
                icon: 'success',
                title: 'สร้างไฟล์เสร็จสิ้น',
                timer: 2000,
                showConfirmButton: false,
            })
            $('#a-download').attr('href', pdfDataUri)
            $('#a-download').attr('download', name).show()
            var iframe = document.getElementById('pdf')
            iframe.src = pdfDataUri
            $(iframe).slideDown(100)
        }
        let pdfFiles = []
        $('.file').change(function () {
            let files = this.files
            for (var i = 0; i < files.length; i++) {
                let obj = this
                let id = $(this).attr('id')
                let file = files[i]
                let reader = new FileReader();
                let reader2 = new FileReader();
                reader.onloadend = function (e) {
                    pdfFiles[id] = e.target.result
                    console.log("🚀 ~ pdfFiles", pdfFiles)
                }
                reader.readAsArrayBuffer(file);
                reader2.onloadend = function (e) {
                    $(obj).parent().parent().find('iframe').attr('src', e.target.result + '#navpanes=0&scrollbar=0').slideDown(100)
                }
                reader2.readAsDataURL(file);
            }
        })
    </script>
    <script>
    </script>
    <script>
        function copy() {
            let str = $('#console-code').val()
            console.log("🚀 ~ str:", str)
            // copy to clipboard
            
            $('#console-code')[0].select()
            document.execCommand("copy")
            let Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: false
            })
            Toast.fire({
                icon: 'success',
                title: 'คัดลอกสำเร็จ'
            })
            console.groupEnd()
        }

        $('#input-json-btn').click(function () {
            let json_text = $('#input-json').val()
            let obj = JSON.parse(json_text)
            fillValue('e_name', obj.name)
            fillValue('dept', obj.dept)
            fillValue('e_dec_location', obj.dept)
            fillValue('e_manufacturer', obj.brand)
            fillValue('e_date', obj.recieve_date)
            fillValue('e_hospital_code', obj.hos_id)
            fillValue('e_brand/model', obj.brand + '/' + obj.model)
            fillValue('e_brand/distributor', obj.sup_sale)
            fillValue('e_sn', obj.sn_no)
            fillValue('e_me_code', obj.id)
            fillValue('e_price', obj.price)

            $('#input-json').val('')
            $('#autoFillOffCanvas').offcanvas('hide')
        })

        function fillValue(id,value){
            if(!value || value == '') return
            $('[id="'+id+'"]').val(value).addClass('bg-primary-subtle')
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>