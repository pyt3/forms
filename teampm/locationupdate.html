<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equip="Cache-control" content="no-cache , no-store, must-revalidate">
    <meta http-equip="Pragma" content="no-cache">
    <meta http-equip="Expires" content="0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
        integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src='https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', sans-serif;
        }

        img#profile {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <nav class="navbar bg-light">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://www.appdisqus.com/wp-content/uploads/2015/02/despicable_me_2_minions-1920x1080.jpg"
                    alt="profile" id="profile" class="rounded-circle border d-inline-block align-text-top">
                &nbsp; <div>
                    <span id="displayName">Team PM</span>
                </div>
            </a>
        </div>
    </nav>
    <div class="container">
        <div class="row justify-contain-center py-3 g-3">
            <div class="col-12 text-center">
                <label for="team" class="h3 fw-bold text-primary">TEAM</label>
                <select name="team" id="team" class="form-select text-center">
                    <option value="" selected disabled>เลือกทีม</option>
                    <option value="team PM">team PM</option>
                    <option value="team CAL">team CAL</option>
                    <option value="VENDER">VENDER</option>
                    <option value="ทรัพย์สิน">ทรัพย์สิน</option>
                </select>
            </div>
            <div class="col-12 text-center">
                <label for="dept" class="h3 fw-bold text-success">แผนก</label>
                <select type="text" class="form-select text-center" id="dept">
                    <option class="pyt3" value="" selected disabled>เลือกแผนก</option>
                    <option class="pyt3" value="" selected disabled>เลือกแผนก</option>
                    <option class="pyt3" value="AMBULANCE (รถพยาบาล)">AMBULANCE (รถพยาบาล)</option>
                    <option class="pyt3" value="ANESTHESIA (วิสัญญี)">ANESTHESIA (วิสัญญี)</option>
                    <option class="pyt3" value="ART-LAB (ศูนย์ผู้มีบุตรยาก)">ART-LAB (ศูนย์ผู้มีบุตรยาก)</option>
                    <option class="pyt3" value="Biomolecular Laboratory">Biomolecular Laboratory</option>
                    <option class="pyt3" value="BME-PYT3">BME-PYT3</option>
                    <option class="pyt3" value="CATH-LAB">CATH-LAB</option>
                    <option class="pyt3" value="CHECK-UP (ตรวจสุขภาพ)">CHECK-UP (ตรวจสุขภาพ)</option>
                    <option class="pyt3" value="CORPORATE CUSTOMER SERVICE">CORPORATE CUSTOMER SERVICE</option>
                    <option class="pyt3" value="CSSD (จ่ายกลาง)">CSSD (จ่ายกลาง)</option>
                    <option class="pyt3" value="DENTAL (ทันตกรรม)">DENTAL (ทันตกรรม)</option>
                    <option class="pyt3" value="DIABETIC&amp;METABOLIC(เบาหวาน)">DIABETIC&amp;METABOLIC(เบาหวาน)
                    </option>
                    <option class="pyt3" value="EENT( หูตาคอจมูก)">EENT( หูตาคอจมูก)</option>
                    <option class="pyt3" value="EMERGENCY( ฉุกเฉิน)">EMERGENCY( ฉุกเฉิน)</option>
                    <option class="pyt3" value="GASTROINTESTINAL LABORATORY(GI)">GASTROINTESTINAL LABORATORY(GI)
                    </option>
                    <option class="pyt3" value="HEMODIALYSIS (ไตเทียม)">HEMODIALYSIS (ไตเทียม)</option>
                    <option class="pyt3" value="HOPD CENTER (ศุนย์มะเร็ง)">HOPD CENTER (ศุนย์มะเร็ง)</option>
                    <option class="pyt3" value="INFECTION CONTROL ( IC)">INFECTION CONTROL ( IC)</option>
                    <option class="pyt3" value="INTENSIVE CARE UNIT(ผู้ป่วยหนัก)">INTENSIVE CARE UNIT(ผู้ป่วยหนัก)
                    </option>
                    <option class="pyt3" value="LABOR ROOM(ห้องคลอด)">LABOR ROOM(ห้องคลอด)</option>
                    <option class="pyt3" value="LABORATORY">LABORATORY</option>
                    <option class="pyt3" value="MAID">MAID</option>
                    <option class="pyt3" value="MARKETING">MARKETING</option>
                    <option class="pyt3" value="NURSERY(เด็กอ่อน)">NURSERY(เด็กอ่อน)</option>
                    <option class="pyt3" value="NURSING DEPARTMENT">NURSING DEPARTMENT</option>
                    <option class="pyt3" value="OBSERVE(สังเกตอาการ)">OBSERVE(สังเกตอาการ)</option>
                    <option class="pyt3" value="OPD CARDIO(ศูนย์หัวใจ)">OPD CARDIO(ศูนย์หัวใจ)</option>
                    <option class="pyt3" value="OPD COUNTER NURSE (CN คัดกรอง)">OPD COUNTER NURSE (CN คัดกรอง)
                    </option>
                    <option class="pyt3" value="OPD HEAD NECK BREAST(ศุนย์เต้านม)">OPD HEAD NECK BREAST(ศุนย์เต้านม)
                    </option>
                    <option class="pyt3" value="OPD MEDICINE(อายุกรรม)">OPD MEDICINE(อายุกรรม)</option>
                    <option class="pyt3" value="OPD NEURO (ศูนย์สมอง)">OPD NEURO (ศูนย์สมอง)</option>
                    <option class="pyt3" value="OPD OB/GYN(ศุนย์สุขภาพหญิง)">OPD OB/GYN(ศุนย์สุขภาพหญิง)</option>
                    <option class="pyt3" value="OPD PEDIATRIC( แผนกเด็ก)">OPD PEDIATRIC( แผนกเด็ก)</option>
                    <option class="pyt3" value="OPD SURGERY(ศัลยกรรม)">OPD SURGERY(ศัลยกรรม)</option>
                    <option class="pyt3" value="OPD UROLOGY (ทางเดินปัสสาวะ)">OPD UROLOGY (ทางเดินปัสสาวะ)</option>
                    <option class="pyt3" value="OPERATING ROOM(ห้องผ่าตัด)">OPERATING ROOM(ห้องผ่าตัด)</option>
                    <option class="pyt3" value="PHARMARCY(เภสัชกรรม ห้องยา)">PHARMARCY(เภสัชกรรม ห้องยา)</option>
                    <option class="pyt3" value="PHYATHAI BEAUTY CENTER (PBC ความงาม)">PHYATHAI BEAUTY CENTER (PBC
                        ความงาม)</option>
                    <option class="pyt3" value="PHYSICAL THERAPY( กายภาพ)">PHYSICAL THERAPY( กายภาพ)</option>
                    <option class="pyt3" value="PICU">PICU</option>
                    <option class="pyt3" value="PWA LIFE CENTER">PWA LIFE CENTER</option>
                    <option class="pyt3" value="PWA ชะลอวัย">PWA ชะลอวัย</option>
                    <option class="pyt3" value="VEHICLE">VEHICLE</option>
                    <option class="pyt3" value="WARD 7">WARD 7</option>
                    <option class="pyt3" value="WARD 8">WARD 8</option>
                    <option class="pyt3" value="WARD 9">WARD 9</option>
                    <option class="pyt3" value="WARD 10">WARD 10</option>
                    <option class="pyt3" value="WARD 11">WARD 11</option>
                    <option class="pyt3" value="WARD 12">WARD 12</option>
                    <option class="pyt3" value="WARD 14">WARD 14</option>
                    <option class="pyt3" value="WARD 15">WARD 15</option>
                    <option class="pyt3" value="WARD 17">WARD 17</option>
                    <option class="pyt3" value="FLOOR 19">FLOOR 19</option>
                    <option class="pyt3" value="FLOOR 20">FLOOR 20</option>
                    <option class="pyt3" value="WAREHOUSE">WAREHOUSE</option>
                    <option class="pyt3" value="X-RAY">X-RAY</option>
                    <option class="pyt3" value="รับส่ง">รับส่ง</option>
                    <option value="Select value" class="pyt2">Select value</option>
                    <option value="AMBULANCE" class="pyt2">AMBULANCE</option>
                    <option value="ANESTHESIA" class="pyt2">ANESTHESIA</option>
                    <option value="ARC CENTER" class="pyt2">ARC CENTER</option>
                    <option value="ARI (MED)" class="pyt2">ARI (MED)</option>
                    <option value="ARI (PED)" class="pyt2">ARI (PED)</option>
                    <option value="BME-PYT2" class="pyt2">BME-PYT2</option>
                    <option value="BMT" class="pyt2">BMT</option>
                    <option value="BREAST CARE CENTER" class="pyt2">BREAST CARE CENTER</option>
                    <option value="CATH LAB" class="pyt2">CATH LAB</option>
                    <option value="CENTRAL SUPPLY" class="pyt2">CENTRAL SUPPLY</option>
                    <option value="CORONARY CARE UNIT" class="pyt2">CORONARY CARE UNIT</option>
                    <option value="DENTAL" class="pyt2">DENTAL</option>
                    <option value="Diabetes &amp; Metabolic Center" class="pyt2">Diabetes &amp; Metabolic Center
                    </option>
                    <option value="EMERGENCY ROOM" class="pyt2">EMERGENCY ROOM</option>
                    <option value="Gastro Internal &amp; Endoscopy" class="pyt2">Gastro Internal &amp; Endoscopy
                    </option>
                    <option value="Geographical Indication" class="pyt2">Geographical Indication</option>
                    <option value="GI SCOPE CENTER" class="pyt2">GI SCOPE CENTER</option>
                    <option value="HEMATOLOGY ONCOLOGY" class="pyt2">HEMATOLOGY ONCOLOGY</option>
                    <option value="HEMODIALYSIS" class="pyt2">HEMODIALYSIS</option>
                    <option value="Hospitel" class="pyt2">Hospitel</option>
                    <option value="INTENSIVE CARE UNIT 1" class="pyt2">INTENSIVE CARE UNIT 1</option>
                    <option value="INTENSIVE CARE UNIT 2" class="pyt2">INTENSIVE CARE UNIT 2</option>
                    <option value="INTENSIVE CARE UNIT 3" class="pyt2">INTENSIVE CARE UNIT 3</option>
                    <option value="IT" class="pyt2">IT</option>
                    <option value="IVF" class="pyt2">IVF</option>
                    <option value="LABOR ROOM" class="pyt2">LABOR ROOM</option>
                    <option value="LABORATORY" class="pyt2">LABORATORY</option>
                    <option value="MOLECULAR-LABORATORY" class="pyt2">MOLECULAR-LABORATORY</option>
                    <option value="MUSCULO-SKELETAL CENTER" class="pyt2">MUSCULO-SKELETAL CENTER</option>
                    <option value="NURSERY" class="pyt2">NURSERY</option>
                    <option value="OPD CHECK UP" class="pyt2">OPD CHECK UP</option>
                    <option value="OPD DERMATOLOGY" class="pyt2">OPD DERMATOLOGY</option>
                    <option value="OPD ENT" class="pyt2">OPD ENT</option>
                    <option value="OPD EYE" class="pyt2">OPD EYE</option>
                    <option value="OPD MEDICINE" class="pyt2">OPD MEDICINE</option>
                    <option value="OPD NEURO" class="pyt2">OPD NEURO</option>
                    <option value="OPD OB/GYN" class="pyt2">OPD OB/GYN</option>
                    <option value="OPD ORTHOPEDIC" class="pyt2">OPD ORTHOPEDIC</option>
                    <option value="OPD PEDIATRIC" class="pyt2">OPD PEDIATRIC</option>
                    <option value="OPD Pharmacy" class="pyt2">OPD Pharmacy</option>
                    <option value="OPD PHYA THAI HEART CENTER" class="pyt2">OPD PHYA THAI HEART CENTER</option>
                    <option value="OPD SURGERY" class="pyt2">OPD SURGERY</option>
                    <option value="OPERATING ROOM" class="pyt2">OPERATING ROOM</option>
                    <option value="OR PHYA THAI HEART CENTER" class="pyt2">OR PHYA THAI HEART CENTER</option>
                    <option value="PATHOLOGY-LABORATORY" class="pyt2">PATHOLOGY-LABORATORY</option>
                    <option value="PATIENT ESCORT" class="pyt2">PATIENT ESCORT</option>
                    <option value="PEDIATRIC INTENSIVE CARE UNIT" class="pyt2">PEDIATRIC INTENSIVE CARE UNIT</option>
                    <option value="PHARMACY" class="pyt2">PHARMACY</option>
                    <option value="PHYATHAI BEAUTY CENTER" class="pyt2">PHYATHAI BEAUTY CENTER</option>
                    <option value="PHYATHAI FERILITY CENTER" class="pyt2">PHYATHAI FERILITY CENTER</option>
                    <option value="PHYCHIATRY CLINIC" class="pyt2">PHYCHIATRY CLINIC</option>
                    <option value="PHYSICAL THERAPY" class="pyt2">PHYSICAL THERAPY</option>
                    <option value="PLATINUM" class="pyt2">PLATINUM</option>
                    <option value="POSTMORTEM ROOM" class="pyt2">POSTMORTEM ROOM</option>
                    <option value="PREMIUM WARD" class="pyt2">PREMIUM WARD</option>
                    <option value="SPECIAL CLINIC" class="pyt2">SPECIAL CLINIC</option>
                    <option value="STAFF CLINIC" class="pyt2">STAFF CLINIC</option>
                    <option value="TRIAGE" class="pyt2">TRIAGE</option>
                    <option value="WARD 10/A" class="pyt2">WARD 10/A</option>
                    <option value="WARD 10/B" class="pyt2">WARD 10/B</option>
                    <option value="WARD 11/A" class="pyt2">WARD 11/A</option>
                    <option value="WARD 11/B" class="pyt2">WARD 11/B</option>
                    <option value="WARD 12/A" class="pyt2">WARD 12/A</option>
                    <option value="WARD 12/B" class="pyt2">WARD 12/B</option>
                    <option value="WARD 14/A" class="pyt2">WARD 14/A</option>
                    <option value="WARD 14/B" class="pyt2">WARD 14/B</option>
                    <option value="WARD 15/A" class="pyt2">WARD 15/A</option>
                    <option value="WARD 15/B" class="pyt2">WARD 15/B</option>
                    <option value="WARD 17/B" class="pyt2">WARD 17/B</option>
                    <option value="WARD 18/B" class="pyt2">WARD 18/B</option>
                    <option value="WARD 21/B" class="pyt2">WARD 21/B</option>
                    <option value="WARD 21-22/B" class="pyt2">WARD 21-22/B</option>
                    <option value="WARD 22/B" class="pyt2">WARD 22/B</option>
                    <option value="WARD 8/A" class="pyt2">WARD 8/A</option>
                    <option value="WARD 9/A" class="pyt2">WARD 9/A</option>
                    <option value="X-RAY" class="pyt2">X-RAY</option>
                    <option value="คลังยาและเวชภัณฑ์" class="pyt2">คลังยาและเวชภัณฑ์</option>
                    <option value="คลีนิคฝังเข็ม" class="pyt2">คลีนิคฝังเข็ม</option>
                    <option value="ฝ่ายการพยาบาล" class="pyt2">ฝ่ายการพยาบาล</option>
                </select>
            </div>
            <div class="col-12 mt-3">
                <input type="text" id="remark" class="form-control"
                    placeholder="หมายเหตุ ชื่อห้อง/เลขห้อง/ตำแหน่ง/อื่นๆ" autocomplete="on">
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-12 flex-fill mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="isDemo">
                    <label class="form-check-label" for="isDemo">
                        Demo
                    </label>
                </div>
            </div>
            <div class="col-auto flex-fill mb-2 pe-0">
                <input type="text" id="add-id" name="add-id"
                    class="form-control text-center text-bg-warning shadow-none" placeholder="กรอกรหัส">
            </div>
            <div class="col-auto text-center mb-2">
                <button class="btn btn-info" id="ocr-btn"><i class="bi bi-upc-scan"></i>&nbsp;OCR</button>
            </div>
            <div class="col-auto text-center mb-2">
                <button class="btn btn-primary" style="min-width: 100px;" id="add-btn">เพิ่มรหัส</button>
            </div>

        </div>
        <section id="id-sec">

        </section>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">OCR Code</h1>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
                <div class="modal-body">
                    <div>
                        <video id="video" class="img-fluid rounded" width="100%" autoplay></video>
                        <div class="row justift-centent-center">
                            <div class="col text-center">
                                <button id="snap" class="btn btn-lg btn-info"><i class="bi bi-camera"></i>&nbsp;
                                    อ่านภาพ</button>
                            </div>
                        </div>
                        <canvas id="canvas" hidden></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        //var vConsole = new window.VConsole();
    </script>
    <script>
        var arr = []
        var Toast, profile, client
        $(document).ready(() => {
            $.LoadingOverlay("show")
            liff.init({
                // liffId: '1655873446-3xe866Ql', // test id
                liffId: '1657539607-EPzqza2K', // prod id
                withLoginOnExternalBrowser: true
            })
            liff.ready.then(async () => {
                $('#dept').select2({
                    theme: 'bootstrap-5'
                });
                const defaultProject = firebase.initializeApp(await $.getJSON('./service-account.json'));
                firestore = defaultProject.firestore();
                auth = defaultProject.auth();
                if (!auth.currentUser) {
                    // await getAuth()
                    await getAuth(await liff.getDecodedIDToken().sub)
                }
                $.LoadingOverlay("hide", true)
                var options = {
                    onComplete: function (cep) {
                        if (arr.includes(cep)) {
                            return Toast.fire({
                                icon: 'warning',
                                title: 'เพิ่มรหัสนี้ไปแล้ว'
                            })
                        }
                        appendPill(cep)
                    },
                };
                if (!await checkClient()) {
                    Swal.fire({
                        icon: 'info',
                        title: 'กรุณาเลือก Site ของท่าน',
                        html: `<div class="container-fluid">
                                    <div class="row">
                                        <div class="col-12">
                                            <select class="form-select" id="client">
                                                <option value="" selected disabled>เลือก Site</option>
                                                <option value="PYT1">PHYATHAI 1</option>
                                                <option value="PYT2">PHYATHAI 2</option>
                                                <option value="PYT3">PHYATHAI 3</option>    
                                                <option value="PTN">PHYATHAI NAWAMIN</option>    
                                            </select>    
                                        </div>
                                    </div>
                                </div>`,
                        preConfirm: () => {
                            if ($('#client').val() == '' || !$('#client').val()) {
                                Swal.showValidationMessage('กรุณาเลือก Site')
                            }
                            return $('#client').val()
                        },
                        allowOutsideClick: false,
                        showCancelButton: false,
                        confirmButtonText: 'ตกลง',
                    }).then(res => {
                        if (res.isConfirmed) {
                            cl = res.value
                            firestore.collection('users').doc(liff.getDecodedIDToken().sub).set({
                                client: cl
                            }).then(() => {
                                if (client.toLowerCase() != 'PYT3') $('#ocr-btn').parent().remove()
                                client = cl
                                $('#add-id').mask(client.toLowerCase() == "pyt3" ? 'PYT3_00000' : 'PYT2_00000', options);
                                $('#dept option').not('.' + client.toLowerCase()).remove()
                                return Swal.fire({
                                    icon: 'success',
                                    title: 'สำเร็จ',
                                    text: 'เพิ่มข้อมูล Site เรียบร้อยแล้ว',
                                    showConfirmButton: false,
                                    timer: 1500,
                                })
                            })
                        }
                    })
                }

                profile = await liff.getProfile()
                $('#profile').attr('src', profile.pictureUrl)
                $('#displayName').text(profile.displayName)
                Toast = Swal.mixin({
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                })

                if (client) {
                    if (client.toLowerCase() != 'PYT3') $('#ocr-btn').parent().remove()
                    $('#add-id').mask(client.toLowerCase() == "pyt3" ? 'PYT3_00000' : 'PYT2_00000', options);
                }
                $('#isDemo').change(function () {
                    $('#add-id').unmask();
                    $('#add-id').val('');
                    $('#add-id').focus();
                    if ($(this).is(':checked')) {
                        $('#add-id').mask('DEMO_000000', options);
                    } else {
                        $('#add-id').mask(client.toLowerCase() == "pyt3" ? 'PYT3_00000' : 'PYT2_00000', options);
                    }

                })
            })

            $('#ocr-btn').click(function () {
                $('#staticBackdrop').modal('show')
            })

        })
        async function checkClient() {
            let user = await firestore.collection('users').doc(liff.getDecodedIDToken().sub).get()
            console.log("🚀 !! user:", user.data())
            if (user.exists) {
                client = user.data().client
                $('#dept option').not('.' + client.toLowerCase()).remove()
                return true
            } else {
                return false
            }
        }

        $('#staticBackdrop').on('show.bs.modal', function () {
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    zoom: 2,
                    width: { ideal: 720, max: 1280 },
                    height: { ideal: 720, max: 1280 },
                    focusMode: 'continuous',
                    exposureMode: 'continuous',
                    whiteBalanceMode: 'continuous',
                    frameRate: { ideal: 30, max: 60 }

                },
                audio: false
            })
                .then(function (stream) {
                    video.srcObject = stream;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                })
                .catch(function (error) {
                    console.error('Oops. Something is broken.', error);
                });

        })

        $('#staticBackdrop').on('hide.bs.modal', function () {
            // close video
            let stream = video.srcObject;
            let tracks = stream.getTracks();

            for (let i = 0; i < tracks.length; i++) {
                let track = tracks[i];
                track.stop();
            }
        })

        $('#add-btn').click(function () {
            if ($('#dept').val() == '' || !$('#dept').val()) {
                return Toast.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกแผนก'
                })
            }

            if ($('#team').val() == '' || !$('#team').val()) {
                return Toast.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกทีม'
                })
            }

            Swal.fire({
                icon: 'info',
                title: 'กำลังบันทึก',
                allowOutsideClick: false
            })
            Swal.showLoading(Swal.getConfirmButton())
            arr.forEach(async id => {
                let obj = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    dept: $('#dept').val(),
                    team: $('#team').val(),
                    code: id,
                    uid: profile.userId,
                    line: profile.displayName,
                    remark: $('#remark').val()
                }
                await firestore.collection(`${client}/${id}/location`).add(obj).then(res => {
                    console.log("🚀 ~ res", res)
                })
            })
            objforflex = {
                dept: $('#dept').val(),
                team: $('#team').val(),
                arr: JSON.stringify(arr),
                uid: profile.userId,
                displayName: profile.displayName,
                remark: $('#remark').val()
            }
            sendLiffMessage(objforflex)

        })

        function sendLiffMessage(obj) {
            let flex = {
                type: 'flex',
                altText: 'Flex',
                contents: {
                    "type": "bubble",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [
                                    {
                                        "type": "text",
                                        "text": "Brown Cafe",
                                        "weight": "bold",
                                        "size": "xl",
                                        "adjustMode": "shrink-to-fit",
                                        "color": "#ffffff"
                                    },
                                    {
                                        "type": "text",
                                        "text": "hello, world",
                                        "color": "#ffffff"
                                    }
                                ],
                                "backgroundColor": "#57acdc",
                                "paddingAll": "md"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "contents": [],
                                "spacing": "md"
                            }
                        ],
                        "spacing": "lg",
                        "offsetTop": "none",
                        "paddingAll": "none"
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": "hello, world",
                                "align": "end",
                                "size": "xs"
                            }
                        ]
                    },
                    "styles": {
                        "header": {
                            "separator": false
                        },
                        "footer": {
                            "separator": true
                        }
                    }
                }
            }

            flex.contents.body.contents[0].contents[0].text = obj.dept
            if (obj.remark == "") {
                flex.contents.body.contents[0].contents.pop()
            } else {
                flex.contents.body.contents[0].contents[1].text = obj.remark
            }
            let count_text = {
                type: 'text',
                size: 'xxs',
                align: "end",
                text: `วันที่ ${new Date().toLocaleDateString('th', { year: 'numeric', month: 'numeric', day: 'numeric' })}`,
            }
            flex.contents.footer.contents[0] = count_text
            arr.forEach((id, i) => {
                flex.contents.body.contents.push({
                    type: 'text',
                    text: id,
                    align: "center"
                })
                if (i == arr.length - 1) {
                    console.log(flex)
                    liff.sendMessages([flex]).catch((err) => {
                        console.log("error", err);
                    });
                }
            })

            arr = []

            Swal.fire({
                icon: 'success',
                title: 'สำเร็จ',
                text: 'เพิ่มข้อมูลเรียบร้อยแล้ว',
                confirmButtonText: 'ตกลง',
                timer: 3000,
                allowOutsideClick: false
            }).then(() => {
                // location.reload()
                $('#id-sec').html('')
                $('#remark').val('')
                arr = []
            })
        }

        function appendPill(cep) {
            let pill = $(`<span class="badge badged text-bg-success p-2 m-1" style="cursor: pointer">${cep}</span>`)
            $(pill).click(function () {
                let ele = $(this)
                Swal.fire({
                    icon: 'question',
                    title: `ลบรหัส ${cep}`,
                    showCancelButton: true,
                    confirmButtonText: 'ตกลง',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        arr = arr.filter(a => a != cep)
                        $(ele).remove()
                        console.log("🚀 ~ arr", arr)
                    }
                })
            })
            $('#id-sec').append(pill)
            $('#isDemo').change()
            arr.push(cep)
        }
    </script>
    <script>
        var script_url = 'https://script.google.com/macros/s/AKfycbx_g-xZYndPu9IzaYITUdHQ5ckjxX8dGxkB6qkhVfQxMrmAN7PfN9X7ENbVhXCgEWxCEg/exec'
    </script>
    <script>
        function formsubmit() {
            let form = $('#mainform')
            let data = form.serializeArray()
            let obj = {}
            data.forEach(a => obj[a.name] = a.value)
            obj.files = files
            $.ajax({
                url: script_url + '?opt=submit',
                type: 'POST',
                dataType: 'json',
                data: obj,
                success: function (res) {
                    $.LoadingOverlay("hide")
                    console.log(res)
                    if (res.status == 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'สำเร็จ',
                            text: 'เพิ่มข้อมูลเรียบร้อยแล้ว',
                            showConfirmButton: false,
                            timer: 1500
                        })
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ผิดพลาด',
                            text: 'เพิ่มข้อมูลไม่สำเร็จ',
                            allowOutsideClick: false,
                            showCancelButton: false,
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'ตกลง'
                        })
                    }
                }
            })
        }
    </script>
    <script>

        // Get references to the video and canvas elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById('snap');
        var worker
        (async () => {
            worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            await worker.setParameters({
                tessedit_char_whitelist: '_PYTBDEM0123456789',
                // tessedit_ocr_engine_mode: 'OEM_TESSERACT_LSTM_COMBINED',
            });
            console.log("worker ready")
        })();

        // Get access to the camera



        // Add a listener to the snap button
        snap.addEventListener("click", function () {
            console.log("snap")
            // focus video before take picture
            // get imageData form video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            // var imageData = canvas.toDataURL('image/png');
            findText()

        });

        function findText() {
            video.pause();
            Swal.fire({
                title: 'กำลังค้นหารหัส',
                allowOutsideClick: false,
            })
            Swal.showLoading(Swal.getConfirmButton());
            worker.recognize(canvas)
                .then(function (result) {
                    let text = result.data.text.replace(/\s/g, '')
                    console.log("🚀 ~ text", text)
                    // extract only text in format PYT3_00000
                    let regex = /(BMEPYT3_\d{3}|PYT(3|3D)_\d{5})/g;
                    let match = text.match(regex);
                    console.log(match);
                    // pause video
                    // show alert
                    Swal.hideLoading();
                    if (match == null) {
                        Swal.fire({
                            title: 'ไม่พบรหัส',
                            text: 'กรุณาถ่ายรูปใหม่',
                            icon: 'error',
                            confirmButtonText: 'ตกลง',
                            allowOutsideClick: false,
                            showConfirmButton: true,
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // resume video
                                video.play();
                            }
                        })
                        return;
                    }
                    Swal.fire({
                        title: match[0],
                        text: 'กรุณายืนยันรหัส',
                        icon: 'question',
                        confirmButtonText: 'ตกลง',
                        denyButtonText: 'ถ่ายรูปใหม่',
                        showDenyButton: true,
                        allowOutsideClick: false,
                        showConfirmButton: true,
                    }).then((result) => {
                        if (result.isConfirmed) {
                            if (arr.includes(match[0])) {
                                return Swal.fire({
                                    icon: 'warning',
                                    title: 'เพิ่มรหัสนี้ไปแล้ว',
                                    showConfirmButton: false,
                                    timer: 1000,
                                }).then(() => {
                                    $('#add-id').val('')
                                    video.play()
                                })
                            }
                            appendPill(match[0])
                            Swal.fire({
                                title: 'สำเร็จ',
                                text: 'เพิ่มรหัสเรียบร้อยแล้ว',
                                icon: 'success',
                                showConfirmButton: false,
                                timer: 1000,
                                showDenyButton: false,
                            })
                        }
                        video.play();
                    })
                })
                .catch(function (error) {
                    console.error('Oops. Something is broken.', error);
                });
        }

        // setInterval(function () {
        //     snap.click()
        //     }, 100);
    </script>
    <script>
        var firestore, auth
        async function getAuth(uid = 'test') {
            let email = uid + '@minion-location.com'
            let password = 'minion-location'
            await auth.signInWithEmailAndPassword(email, password).then(function (user) {
                console.log('sign in successful')
            }).catch(async function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                var credential = error.credential;
                console.log(errorCode)
                console.log(errorMessage)
                console.log(credential)
                await auth.createUserWithEmailAndPassword(email, password).then(function (user) {
                    console.log('sign up successful')
                }).catch(function (error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    // ...
                    console.log(errorCode)
                    console.log(errorMessage)
                    console.log(email)
                    console.log(credential)
                });
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"
        integrity="sha512-pHVGpX7F/27yZ0ISY+VVjyULApbDlD0/X0rgGbTqCE7WFW5MezNTWG/dnhtbBuICzsd0WQPgpE4REBLv+UqChw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    

</body>

</html>