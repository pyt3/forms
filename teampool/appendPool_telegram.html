<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</title>
    <script src="https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Cedarville+Cursive&family=Mitr&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://fastly.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="../teampm/main const.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #FF8604;
            width: 100vw;
            font-family: 'Abril Fatface', cursive;
            font-family: 'Cedarville Cursive', cursive;
            font-family: 'Mitr', sans-serif;
        }

        img#profile {
            width: 30px;
            height: 30px;
            object-fit: cover;
        }

        .loader {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
        }

        .wrapper {
            width: 180px;
            height: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .text {
            z-index: 3;
            font-family: Whitney, -apple-system, Helvetica;
            letter-spacing: 1px;
            font-weight: 700;
            font-size: 20px;
            color: white;
            filter: drop-shadow(2px 2px 0px #ff9e02);
        }

        .box {
            width: 100%;
            height: 100%;
            background-color: #ef5d2e;
            position: absolute;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: loading ease-in-out 0.9s infinite alternate-reverse;
        }

        @keyframes loading {
            0% {
                transform: translateX(-20px);
            }

            100% {
                transform: translateX(20px);
            }
        }

        .box::before {
            content: "";
            width: 20px;
            height: 170%;
            background-color: #ff9d0089;
            position: absolute;
            z-index: 1;
            animation: loading2 ease-in-out 0.9s infinite alternate-reverse;
        }

        @keyframes loading2 {
            0% {
                transform: translateX(-50px);
            }

            100% {
                transform: translateX(50px);
            }
        }
    </style>
</head>

<body>
    <div class="fixed-top">
        <div class="loader bg-light">
            <div class="wrapper">
                <div class="text">LOADING</div>
                <div class="box"></div>
            </div>
        </div>

    </div>
    <nav class="navbar">
        <div class="container-fluid" style="display: none">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <!-- <img src="https://www.appdisqus.com/wp-content/uploads/2015/02/despicable_me_2_minions-1920x1080.jpg"
                    alt="profile" id="profile" class="rounded-circle border d-inline-block align-text-top"> -->
                &nbsp; <div>
                    <span id="displayName">Team PM</span>
                </div>
            </a>
        </div>
    </nav>
    <div class="container-fluid h-100 d-flex justify-content-center align-items-center">
        <div class="px-4 pb-4 pt-1">
            <div class="row justify-content-center">
                <div class="col h4 fw-bold text-center text-dark">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢
                </div>
            </div>
            <div class="row g-3 justify-content-center">
                <div class="col-md-6">
                    <label for="code">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                    <input type="text" class="form-control text-center" id="code" name="code">
                </div>
                <div class="col-md-12">
                    <div class="d-flex gap-2">
                        <span class="badge text-bg-primary btn" id="scope">Scope</span>
                        <span class="badge text-bg-primary btn" id="ups">UPS</span>

                    </div>
                </div>
                <div class="col-md-6" id="div-start">
                    <label for="start">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
                    <select name="start" id="start" class="form-select">
                        <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</option>
                    </select>
                </div>
                <div class="col-12 text-center mt-3" style="display:none"><i
                        class="bi bi-arrow-down-up text-light fs-2 btn btn-success rounded-circle"></i></div>
                <div class="col-md-6" id="div-end">
                    <label for="end">‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                    <select name="end" id="end" class="form-select">
                        <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="files">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                    <!-- accept only image and video -->
                    <input type="file" class="form-control" name="telegram-files" id="telegram-files" multiple
                        accept="image/*">
                </div>
                <div class="col-md-6 text-center">
                    <button class="btn btn-warning w-50" id="submit-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        var vConsole = new window.VConsole();
    </script>
    <script>
        var script_url = 'https://script.google.com/macros/s/AKfycbzDtTiaRWBRWbtArS2Y9Lk5tzWOfBL5sRY8VOqYyBCySbvqobvsiqbN0NuLVcSndm0CzQ/exec'
        var profile
        var history_code = {}
        const tg = window.Telegram.WebApp
        $(document).on('select2:open', () => {
            document.querySelector('.select2-search__field').focus();
        });
        $(document).ready(function () {
            profile = tg.initDataUnsafe.user
            $('#end').append($('#start option').not(':first-child').clone())
            $('#ups').click(function () {
                Swal.fire({
                    input: 'number',
                    title: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UPS',
                    inputPlaceholder: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UPS',
                    customClass: {
                        input: 'text-center'
                    },
                    showCancelButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    preConfirm: (ups) => {
                        return ups
                    }
                }).then(res => {
                    if (res.isConfirmed) {
                        if (res.value == '' || res.value == null) $('#code').val('UPS')
                        else $('#code').val('UPS ' + ('00' + res.value).slice(-2))
                    }
                })
            })

            $('#scope').click(function () {
                $('#code').val('SCOPE')
            })

            // $.LoadingOverlay('show')
            $.getJSON(script_url, function (data) {
                history_code = data
                console.log("üöÄ ~ history_code:", history_code)
            })
            // liff.init({
            //     liffId: '1660749495-G5e9Av6r',
            //     // liffId: '1660749495-A2gmPQNb',
            //     withLoginOnExternalBrowser: true
            // })
            if (profile.id) {
                checkRegist()
                if (profile.userId == 'U5c0c8ed83945a138718d146af61636db' || profile.userId == 'U6664113cf382c2c6b77b94e8deb7b7ea') {
                    Swal.fire({
                        title: '‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Line ' + profile.displayName + ' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                        html: '<div container-fluid><div class="row"><div class="col-12"><select id="name-onc" class="form-select">' +
                            '<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</option>' +
                            '<option value="CHAIWAT SALAIWONG">CHAIWAT SALAIWONG</option>' +
                            '<option value="PASSAWAN TOANUN">PASSAWAN TOANUN</option>' +
                            '<option value="PANALEE UEASUNTHONNOP">PANALEE UEASUNTHONNOP</option>' +
                            '<option value="SERMKEAT HADJANG">SERMKEAT HADJANG</option>' +
                            '<option value="CHANCHAI SAE-LEE">CHANCHAI SAE-LEE</option>' +
                            '<option value="SARAN THAMMATHORN">SARAN THAMMATHORN</option>' +
                            '<option value="PUKARIN TONGKLIANG">PUKARIN TONGKLIANG</option>' +
                            '<option value="ANUPHAB CHANTO">ANUPHAB CHANTO</option>' +
                            '<option value="NARUECHA CHAIYAPHAN">NARUECHA CHAIYAPHAN</option>' +
                            '<option value="ITTIPAT IEMDEE">ITTIPAT IEMDEE</option>' +
                            '<option value="SASIMAPORN KHANTHAHOME">SASIMAPORN KHANTHAHOME</option>' +
                            '<option value="DARANPHOP YIMYAM">DARANPHOP YIMYAM</option>' +
                            '<option value="CHATVIPA KAEWPRESERT">CHATVIPA KAEWPRESERT</option>' +
                            '<option value="RAPIPHAN KHAMSUWAN">RAPIPHAN KHAMSUWAN</option>' +
                            '<option value="SOM KONKAEW">SOM KONKAEW</option>' +
                            '<option value="PATCHARAPORN JORNSAMER">PATCHARAPORN JORNSAMER</option>' +
                            '<option value="RATCHATA PIRIYAKITSAKUL">RATCHATA PIRIYAKITSAKUL</option>' +
                            '<option value="ILADA BUAPRALAT">ILADA BUAPRALAT</option>' +
                            '<option value="JIRASSAYA CHUENYOO">JIRASSAYA CHUENYOO</option>' +
                            '</div></div></div>',
                        customClass: {
                            input: 'form-select'
                        },
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        allowOutsideClick: false,
                        preConfirm: () => {
                            let name = $('#name-onc').val()
                            if (name == '' || name == null) {
                                Swal.showValidationMessage(
                                    `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`
                                )
                            }
                            return name
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            profile.displayName = result.value + ' (' + profile.displayName + ')'
                            $('#profile').attr('src', profile.pictureUrl)
                            $('#displayName').text(profile.displayName).attr('data-name', result.value.toUpperCase())
                            $('.navbar .container-fluid').show(400)
                            Swal.fire({
                                title: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ' + result.value,
                                text: '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö',
                                showConfirmButton: false,
                                icon: 'success',
                                timer: 1000
                            })
                        }
                    })
                }
            
                $('.navbar .container-fluid').show(400)
            }
            $('select option').each(function () {
                $(this).val($(this).text().trim())
            })
            $('select').select2({
                theme: 'bootstrap-5'
            })
            initHistory_code()
            $('#start, #end').append(depts_array.sort().map(dept => {
                return `<option value="${dept}">${dept}</option>`
            }).join(''))

        })
        function initHistory_code() {
            //setup before functions
            var typingTimer;                //timer identifier
            var doneTypingInterval = 500;  //time in ms, 0.5 seconds for example
            var $input = $('#code');
            //on keyup, start the countdown
            $input.on('keyup', function () {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(doneTyping, doneTypingInterval);
            });
            //on keydown, clear the countdown 
            $input.on('keydown', function () {
                clearTimeout(typingTimer);
            });
            //user is "finished typing," do something
            function doneTyping() {
                let code = $('#code').val().toUpperCase()
                let his = _.pickBy(history_code, (v, k) => {
                    return k.includes(code)
                })
                console.log(his);
                if (_.size(his) > 0) {
                    his = _.values(his)[0]
                    $('#start').val(his.start).change()
                    $('#end').val(his.end).change()
                    $('.bi-arrow-down-up').parent().show(200)
                } else {
                    $('.bi-arrow-down-up').parent().hide(200)
                    $('#start').val('').change()
                    $('#end').val('').change()
                }
            }
            $('.bi-arrow-down-up').click(function () {
                // $(this).removeClass('animate__animated animate__bounceIn')
                $('#div-start').addClass('animate__animated animate__backOutRight animate__faster')
                $('#div-end').addClass('animate__animated animate__backOutLeft animate__faster')
                setTimeout(() => {
                    let start = $('#start').val()
                    let end = $('#end').val()
                    $('#start').val(end).change()
                    $('#end').val(start).change()
                    $('#div-start').removeClass('animate__animated animate__backOutRight')
                    $('#div-end').removeClass('animate__animated animate__backOutLeft')
                    $('#div-start').addClass('animate__animated animate__backInLeft animate__faster')
                    $('#div-end').addClass('animate__animated animate__backInRight animate__faster')
                }, 500);
                // rotate element 360 degrees in 1 second
                $(this).animate({ borderSpacing: -360 }, {
                    step: function (now, fx) {
                        $(this).css('-webkit-transform', 'rotate(' + now + 'deg)');
                        $(this).css('-moz-transform', 'rotate(' + now + 'deg)');
                        $(this).css('transform', 'rotate(' + now + 'deg)');
                    },
                    duration: 'slow'
                }, 'linear');
            })
        }
        function checkRegist() {
            let uid = profile.id
            let regist = localStorage.getItem('regist')
            if (regist != null) {
                try {
                    regist = JSON.parse(regist)
                } catch (e) {
                    regist = {
                        uid: null
                    }
                }
            }
            console.log("üöÄ ~ regist:", regist)
            if (regist?.uid == uid && regist?.name != null && regist?.name != '') {
                // $.LoadingOverlay('hide')
                $('.loader').fadeOut(500)
                $('#displayName').attr('data-name', regist.name.toUpperCase()).text(regist.telegram_name)
                
            }
            $.ajax({
                method: 'POST',
                url: script_url,
                data: {
                    opt: 'checkRegist',
                    uid: uid,
                    telegram: true
                },
                success: function (res) {
                    console.log("üöÄ ~ res:", res)
                    // $.LoadingOverlay('hide')
                    $('.loader').fadeOut(500)
                    if (!res) {
                        Swal.fire({
                            icon: 'error',
                            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                            allowOutsideClick: false,
                            confirmButtonText: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
                            input: 'select',
                            inputOptions: {
                                '': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                                'ANUPHAB CHANTO': 'ANUPHAB CHANTO',
                                'NARUECHA CHAIYAPHAN': 'NARUECHA CHAIYAPHAN',
                                'DARANPHOP YIMYAM': 'DARANPHOP YIMYAM',
                                'CHATVIPA KAEWPRESERT': 'CHATVIPA KAEWPRESERT',
                                'SASIMAPORN KHANTHAHOME': 'SASIMAPORN KHANTHAHOME',
                                'PHIMRAPEEPORN PHRASOPOL': 'PHIMRAPEEPORN PHRASOPOL',
                                'SERMKEAT HADJANG': 'SERMKEAT HADJANG',
                                'RAPIPHAN KHAMSUWAN': 'RAPIPHAN KHAMSUWAN',
                                'CHANCHAI SAE-LEE': 'CHANCHAI SAE-LEE',
                                'SARAN THAMMATHORN': 'SARAN THAMMATHORN',
                                'SOM KONKAEW': 'SOM KONKAEW',
                                'ITTIPAT IEMDEE': 'ITTIPAT IEMDEE',
                                'RATCHATA PIRIYAKITSAKUL': 'RATCHATA PIRIYAKITSAKUL',
                                'PATCHARAPORN JORNSAMER': 'PATCHARAPORN JORNSAMER',
                                'JIRASSAYA CHUENYOO': 'JIRASSAYA CHUENYOO',
                                'ILADA BUAPRALAT': 'ILADA BUAPRALAT'
                            },
                            preConfirm: () => {
                                let name = $('#swal2-select').val()
                                if (name == '' || name == null) {
                                    Swal.showValidationMessage(
                                        `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`
                                    )
                                }
                                return name
                            }
                        }).then((res) => {
                            if(res.isConfirmed){
                                Swal.fire({
                                    icon: 'info',
                                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
                                    allowOutsideClick: false,
                                    didOpen: () => {
                                        Swal.showLoading()
                                    }
                                })
                                let post_data = {
                                    opt: 'regist_telegram',
                                    uid: uid,
                                    name: res.value,
                                    telegram_name: profile.username
                                }
                                $.ajax({
                                    method: 'POST',
                                    url: script_url,
                                    data: post_data,
                                    success: function (res) {
                                        console.log("üöÄ ~ checkRegist ~ res:", res)
                                        if(res.status == 'success'){
                                            res = res.data
                                            localStorage.setItem('regist', JSON.stringify({
                                                uid: uid,
                                                name: post_data.name,
                                                telegram_name: profile.username,
                                                image: profile.photo_url
                                            }))
                                            Swal.fire({
                                                icon: 'success',
                                                title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                                                showConfirmButton: false,
                                                allowOutsideClick: false,
                                            })
                                            location.reload()
                                        }else{
                                            Swal.fire({
                                                icon: 'error',
                                                title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                                                showConfirmButton: false,
                                                allowOutsideClick: false,
                                            })
                                        }
                                        // refresh telegram webapp
                                    }
                                })
                            }
                        })
                    } else {
                        localStorage.setItem('regist', JSON.stringify(res))
                        $('#displayName').attr('data-name', res.name.toUpperCase()).text(res.telegram_name)
                        $('#profile').attr('src', profile.photo_url).css('display', profile.photo_url ? 'block' : 'none')
                    }
                }
            })
        }
        $('#submit-btn').click(function () {
            var code = $('#code').val()
            var start = $('#start').val()
            var end = $('#end').val()
            if (code == '' && checkcode(code)) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            if (start == '' || start == null) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            if (end == '' || end == null) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            let data = {
                opt: 'add',
                code: convertCode(code),
                start: start,
                end: end,
                name: $('#displayName').attr('data-name'),
                // uid: 'test',
                // displayName: 'yeah'
                uid: liff.getDecodedIDToken().sub,
                displayName: profile.displayName
            }
            if (start == end) {
                return Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                    html: `<div class="container-fluid"><div class="row"><div class="col-12"><label for="start-room">‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input id="start-room" class="form-control"></div><div class="col-12"><label for="end-room">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label><input id="end-room" class="form-control"></div></div></div>`,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    preConfirm: () => {
                        let start_room = $('#start-room').val()
                        let end_room = $('#end-room').val()
                        if (start_room == '' || end_room == '') {
                            Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á`)
                        }
                        return { start_room, end_room }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        data['start-room'] = result.value.start_room
                        data['end-room'] = end_room = result.value.end_room
                        sendPost(data)
                    }
                })
            } else if (start.toLowerCase().indexOf('ward') > -1 || end.toLowerCase().indexOf('ward') > -1 || start == '‡∏ä‡∏±‡πâ‡∏ô 20' || end == '‡∏ä‡∏±‡πâ‡∏ô 20') {
                let start_room_html = `<div class="col-12"><label for="start-room">‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ${start}</label><input id="start-room" class="form-control"></div>`
                let end_room_html = `<div class="col-12"><label for="end-room">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ${end}</label><input id="end-room" class="form-control"></div>`
                let div = $('<div>', { class: 'container-fluid' }).append($('<div>', { class: 'row g-2' }))
                let title = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏'
                div.find('.row').append($('<div>', { class: 'col-12 h5' }).html(`<i class="bi bi-door-open-fill"></i><span id="room-swal-title">${title}</span>`))
                div.find('.row').append($('<div>', { class: 'col-12 alert alert-warning p-1' }).html(`<i class="bi bi-exclamation-triangle-fill"></i> <u>‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ</u>`))
                if (start.toLowerCase().indexOf('ward') > -1 || start == '‡∏ä‡∏±‡πâ‡∏ô 20') {
                    title += '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á'
                    div.find('.row').append($(start_room_html))
                }
                if (end.toLowerCase().indexOf('ward') > -1 || end == '‡∏ä‡∏±‡πâ‡∏ô 20') {
                    title += ' ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
                    div.find('.row').append($(end_room_html))
                }
                return Swal.fire({
                    html: div[0].outerHTML,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    preConfirm: () => {
                        let start_room = $('#start-room').val()
                        let end_room = $('#end-room').val()
                        return { start_room, end_room }
                    },
                    didOpen: () => {
                        $('#room-swal-title').text(title)
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (result.value.start_room != '') data['start-room'] = result.value.start_room
                        if (result.value.end_room != '') data['end-room'] = end_room = result.value.end_room
                        sendPost(data)
                    }
                })
            }
            else {
                sendPost(data)
            }
        })
        function getCompressionQuality(file) {
            let quality = 0.3
            switch (true) {
                case file.size / 1024 <= 200:
                    quality = 0.8
                    break;

                case file.size / 1024 <= 600:
                    quality = 0.6
                    break;

                case file.size / 1024 <= 2000:
                    quality = 0.4
                    break;
                default:
                    quality = 0.2
                    break;
            }
            return quality
        }

        $('#telegram-files').change(function () {
            if (this.files.length == 0) return
            // compress file
            Swal.fire({
                icon: 'info',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            let dataTransfer = new DataTransfer();
            const files = this.files;
            let length = files.length
            Array.from(files).map(file => {
                const quality = getCompressionQuality(file)
                new Compressor(file, {
                    quality: quality,
                    success(result) {
                        console.log("üöÄ ~ file:", result)
                        let f = new File([result], file.name, {
                            type: file.type,
                            lastModified: Date.now()
                        });
                        dataTransfer.items.add(f);
                        if (dataTransfer.items.length == length) {
                            $('#telegram-files')[0].files = dataTransfer.files;
                            Swal.close()
                        }
                    },
                    error(err) {
                        console.log(err.message);
                    },
                });
            })

            // const reader = new FileReader();
            // reader.onload = function (e) {
            //     const img = new Image();
            //     img.src = e.target.result;
            //     img.onload = function () {
            //         const elem = document.createElement('canvas');
            //         const width = 800;
            //         const scaleFactor = width / img.width;
            //         elem.width = width;
            //         elem.height = img.height * scaleFactor;
            //         const ctx = elem.getContext('2d');
            //         ctx.drawImage(img, 0, 0, width, img.height * scaleFactor);
            //         ctx.canvas.toBlob((blob) => {
            //             const file = new File([blob], 'image', {
            //                 type: 'image/jpeg',
            //                 lastModified: Date.now()
            //             });
            //             console.log("üöÄ ~ file:", file)
            //         }, 'image/jpeg', 1);
            //     }
            // }
            // reader.readAsDataURL(file);
        })
        async function sendPost(data) {
            // $.LoadingOverlay('show')
            // $.when(
            //     $.ajax({
            //         url: script_url,
            //         type: 'POST',
            //         data: data,
            //     }),
            //     $.ajax({
            //         url: script_url,
            //         type: 'POST',
            //         data: {
            //             opt: 'setHistory', data: JSON.stringify({
            //                 code: data.code,
            //                 start: data.start,
            //                 end: data.end
            //             })
            //         }
            //     })
            // ).done((res1, res2) => {
            //     $.LoadingOverlay('hide', true)
            //     if (res1[0].status == 'success') {
            //         liff.sendMessages([{
            //             type: 'text',
            //             text: `‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${data.code}\n‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å\nüëâ${data.start}\n‡πÑ‡∏õ‡∏¢‡∏±‡∏á\nüëâ${data.end}\n‡πÇ‡∏î‡∏¢ @${data.displayName}`
            //         }])
            //         Swal.fire({
            //             icon: 'success',
            //             title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
            //             confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            //         }).then(() => {
            //             history_code[data.code] = {
            //                 start: data.start,
            //                 end: data.end
            //             }
            //             localStorage.setItem('history_code', JSON.stringify(history_code))
            //             liff.closeWindow()
            //         })
            //     } else {
            //         console.log(res);
            //     }
            // })
            Swal.fire({
                icon: 'info',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                html: '<div class="container-fluid"><div class="row">' +
                    '<div class="col-12 text-center text-muted" id="status-history"><i class="bi bi-hourglass-split"></i></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>' +
                    '</div></div>' +
                    '<div class="col-12 text-center text-muted" id="status-gsheet"><i class="bi bi-hourglass-split"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet</div>' +
                    '<div class="col-12 text-center text-muted" id="status-nsmart"><i class="bi bi-hourglass-split"></i></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Job Consult</div>' +
                    '<div class="col-12 text-center text-muted" id="status-telegram"><i class="bi bi-hourglass-split"></i></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram</div>',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            console.time('sendPost')
            Promise.all([
                new Promise((resolve, reject) => {
                    console.log("save to gsheet");
                    $.post(script_url, data, (res) => {
                        if (res.status == 'success') {
                            let data = res
                            $('#status-gsheet').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet').removeClass('text-muted').addClass('text-success')
                            const chatId = data.chatId
                            const sendMessageUrl = `https://api.telegram.org/bot${data.token}/sendMessage`;
                            const sendMediaUrl = `https://api.telegram.org/bot${data.token}/sendMediaGroup`;
                            let files = $('#telegram-files')[0].files;
                            let msg = `
<b>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${data.e_name}</b>

‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å

üëâ <i>${data.start}</i>

‡πÑ‡∏õ‡∏¢‡∏±‡∏á

üëâ <i>${data.end}</i>

‡πÇ‡∏î‡∏¢ ${data.name}`
                            $.ajax({
                                url: sendMessageUrl,
                                type: 'POST',
                                data: {
                                    chat_id: chatId,
                                    text: msg,
                                    parse_mode: "HTML",
                                    reply_markup: JSON.stringify({
                                        inline_keyboard: [
                                            [{
                                                text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°",
                                                url: `https://lin.ee/9Ganv2I`
                                            }]
                                        ]
                                    })
                                },
                                success: function (response) {
                                    if (response.ok) {
                                        console.log("Message sent successfully!");

                                        // Step 2: Send the images after the message is sent
                                        if (files.length > 0) {
                                            const media = [];
                                            const formData = new FormData();

                                            Array.from(files).forEach((file) => {
                                                media.push({
                                                    type: "photo",  // Set the type of media
                                                    media: `attach://${file.name}` // Use 'attach://' for file attachment
                                                });
                                                formData.append(file.name, file); // Attach the file to the FormData
                                            });

                                            // Attach media to FormData
                                            formData.append("chat_id", chatId);
                                            formData.append("media", JSON.stringify(media)); // Add media array
                                            formData.append("reply_parameters", JSON.stringify({ message_id: response.result.message_id })); // Add reply_parameters

                                            // Send images as a media group
                                            $.ajax({
                                                url: sendMediaUrl,
                                                type: 'POST',
                                                data: formData,
                                                contentType: false,
                                                processData: false,
                                                success: function (mediaResponse) {
                                                    if (mediaResponse.ok) {
                                                        $('#status-telegram').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram').removeClass('text-muted').addClass('text-success')
                                                        console.log("Media sent successfully!");
                                                        resolve(mediaResponse)
                                                    } else {
                                                        alert("Error sending images: " + mediaResponse.description);
                                                    }
                                                },
                                                error: function (jqXHR, textStatus, errorThrown) {
                                                    console.error("Error sending images:", errorThrown);

                                                }
                                            });
                                        } else {
                                            $('#status-telegram').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram').removeClass('text-muted').addClass('text-success')
                                            resolve(response)
                                        }
                                    } else {
                                        alert("Error sending message: " + response.description);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("Error:", error);
                                    alert("Error sending message.");
                                }
                            });
                        } else {
                            $('#status-gsheet').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet')
                            reject()
                        }
                    })
                }),
                new Promise((resolve, reject) => {
                    console.log("save to history");
                    $.post(script_url, {
                        opt: 'setHistory',
                        code: data.code,
                        start: data.start,
                        end: data.end
                    }, (res) => {
                        if (res.status == 'success') {
                            $('#status-history').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥').removeClass('text-muted').addClass('text-success')
                            resolve(res)
                        } else {
                            $('#status-history').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥')
                            reject()
                        }
                    })
                }),
                new Promise((resolve, reject) => {
                    console.log("save to job consult");
                    $.post(script_url, {
                        opt: 'savejobconsult',
                        code: data.code,
                        start: data.start,
                        end: data.end,
                        name: $('#displayName').attr('data-name'),
                        ['start-room']: data['start-room'],
                        ['end-room']: data['end-room']
                    }, (res) => {
                        if (res.status == 'success') {
                            $('#status-nsmart').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Job Consult').removeClass('text-muted').addClass('text-success')
                            resolve(res)
                        } else {
                            $('#status-nsmart').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Job Consult')
                            reject()
                        }
                    })
                })
            ]).then((save_res) => {
                console.log("üöÄ save_res:", save_res)
                console.timeEnd('sendPost')
                setTimeout(() => {
                    liff.sendMessages([{
                        type: 'text',
                        text: `‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${data.code}\n‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å\nüëâ${data.start}\n‡πÑ‡∏õ‡∏¢‡∏±‡∏á\nüëâ${data.end}\n‡πÇ‡∏î‡∏¢ @${data.displayName}`
                    }])
                    sendTelegram(save_res[0])
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    }).then(() => {
                        history_code[data.code] = {
                            start: data.start,
                            end: data.end
                        }
                        localStorage.setItem('history_code', JSON.stringify(history_code))
                        liff.closeWindow()
                    })
                }, 500);
            })
        }
        function checkcode(code) {
            code = code.toLowerCase().replace('pyt3_', '').replace('demo_', '')
            if (!Number(code) == NaN && (code.length < 4 || code.length > 11)) {
                return false
            }
            return true
        }
        function convertCode(code) {
            code = code.toLowerCase().replace('pyt3_', '').replace('demo_', '')
            if (isNaN(code)) {
                return code
            }
            if (code.length >= 4 || code.length <= 5) {
                code = ('00000' + code).slice(-5)
                code = 'PYT3_' + code
            } else if (code.length == 6) {
                code = ('000000' + code).slice(-6)
                code = 'DEMO_' + code
            }
            return code
        }

        function sendTelegram(data) {
        }
    </script>
    <script src="https://fastly.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://fastly.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
</body>

</html>