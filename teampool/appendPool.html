<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกข้อมูลการขนย้าย</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Cedarville+Cursive&family=Mitr&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #FF8604;
            width: 100vw;
            font-family: 'Abril Fatface', cursive;
            font-family: 'Cedarville Cursive', cursive;
            font-family: 'Mitr', sans-serif;
        }

        img#profile {
            width: 30px;
            height: 30px;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container-fluid" style="display: none">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://www.appdisqus.com/wp-content/uploads/2015/02/despicable_me_2_minions-1920x1080.jpg" alt="profile" id="profile" class="rounded-circle border d-inline-block align-text-top">
                &nbsp; <div>
                    <span id="displayName">Team PM</span>
                </div>
            </a>
        </div>
    </nav>
    <div class="container-fluid h-100 d-flex justify-content-center align-items-center">
        <div class="px-4 pb-4 pt-1">
            <div class="row justify-content-center">
                <div class="col h4 fw-bold text-center text-dark">
                    บันทึกข้อมูลการขนย้าย
                </div>
            </div>
            <div class="row g-2 justify-content-center">
                <div class="col-md-6">
                    <label for="code">รหัสเครื่อง</label>
                    <input type="text" class="form-control text-center" id="code" name="code">
                </div>
                <div class="col-md-6">
                    <label for="start">แผนกต้นทาง</label>
                    <select name="start" id="start" class="form-select">
                        <option value="" selected disabled>เลือกแผนกต้นทาง</option>
                        <option>ANESTHESIA (วิสัญญี)</option>
                        <option>ART-LAB (ศูนย์ผู้มีบุตรยาก)</option>
                        <option>BME-PYT3</option>
                        <option>CATH-LAB</option>
                        <option>CHECK-UP (ตรวจสุขภาพ)</option>
                        <option>CORPORATE CUSTOMER SERVICE</option>
                        <option>CSSD (จ่ายกลาง)</option>
                        <option>DENTAL (ทันตกรรม)</option>
                        <option>DIABETIC&amp;METABOLIC(เบาหวาน)</option>
                        <option>EENT( หูตาคอจมูก)</option>
                        <option>EMERGENCY( ฉุกเฉิน)</option>
                        <option>GASTROINTESTINAL LABORATORY(GI)</option>
                        <option>HEMODIALYSIS (ไตเทียม)</option>
                        <option>HOPD CENTER (ศุนย์มะเร็ง)</option>
                        <option>INFECTION CONTROL ( IC)</option>
                        <option>INTENSIVE CARE UNIT(ผู้ป่วยหนัก)</option>
                        <option>LABOR ROOM(ห้องคลอด)</option>
                        <option>LABORATORY</option>
                        <option>MAID</option>
                        <option>MARKETING</option>
                        <option>NURSERY(เด็กอ่อน) FL.6</option>
                        <option>NURSERY(เด็กอ่อน) FL.7</option>
                        <option>NURSING DEPARTMENT</option>
                        <option>OBSERVE(สังเกตอาการ)</option>
                        <option>OPD CARDIO(ศูนย์หัวใจ)</option>
                        <option>OPD COUNTER NURSE (CN คัดกรอง)</option>
                        <option>OPD HEAD NECK BREAST(ศุนย์เต้านม)</option>
                        <option>OPD Lasik (ศูนย์เลสิก)</option>
                        <option>OPD MEDICINE(อายุกรรม)</option>
                        <option>OPD NEURO (ศูนย์สมอง)</option>
                        <option>OPD OB/GYN(ศุนย์สุขภาพหญิง)</option>
                        <option>OPD PEDIATRIC( แผนกเด็ก)</option>
                        <option>OPD SURGERY(ศัลยกรรม)</option>
                        <option>OPD UROLOGY (ทางเดินปัสสาวะ)</option>
                        <option>OPERATING ROOM(ห้องผ่าตัด)</option>
                        <option>PHARMARCY(เภสัชกรรม ห้องยา)</option>
                        <option>PHYATHAI BEAUTY CENTER (PBC ความงาม)</option>
                        <option>PHYSICAL THERAPY( กายภาพ)</option>
                        <option>PICU</option>
                        <option>PWA LIFE CENTER</option>
                        <option>PWA ชะลอวัย</option>
                        <option>VEHICLE</option>
                        <option>WARD 10</option>
                        <option>WARD 11</option>
                        <option>WARD 12</option>
                        <option>WARD 14</option>
                        <option>WARD 15</option>
                        <option>WARD 17</option>
                        <option>WARD 7</option>
                        <option>WARD 8</option>
                        <option>WARD 9</option>
                        <option>WAREHOUSE</option>
                        <option>X-RAY</option>
                        <option>รับส่ง</option>
                    </select>

                </div>
                <div class="col-12 text-center mt-3" style="display: none"><i class="bi bi-arrow-down-up text-light fs-2 btn btn-success rounded-circle"></i></div>
                <div class="col-md-6">
                    <label for="end">แผนกปลายทาง</label>
                    <select name="end" id="end" class="form-select">
                        <option value="" selected disabled>เลือกแผนกปลายทาง</option>
                        <option>ANESTHESIA (วิสัญญี)</option>
                        <option>ART-LAB (ศูนย์ผู้มีบุตรยาก)</option>
                        <option>BME-PYT3</option>
                        <option>CATH-LAB</option>
                        <option>CHECK-UP (ตรวจสุขภาพ)</option>
                        <option>CORPORATE CUSTOMER SERVICE</option>
                        <option>CSSD (จ่ายกลาง)</option>
                        <option>DENTAL (ทันตกรรม)</option>
                        <option>DIABETIC&amp;METABOLIC(เบาหวาน)</option>
                        <option>EENT( หูตาคอจมูก)</option>
                        <option>EMERGENCY( ฉุกเฉิน)</option>
                        <option>GASTROINTESTINAL LABORATORY(GI)</option>
                        <option>HEMODIALYSIS (ไตเทียม)</option>
                        <option>HOPD CENTER (ศุนย์มะเร็ง)</option>
                        <option>INFECTION CONTROL ( IC)</option>
                        <option>INTENSIVE CARE UNIT(ผู้ป่วยหนัก)</option>
                        <option>LABOR ROOM(ห้องคลอด)</option>
                        <option>LABORATORY</option>
                        <option>MAID</option>
                        <option>MARKETING</option>
                        <option>NURSERY(เด็กอ่อน) FL.6</option>
                        <option>NURSERY(เด็กอ่อน) FL.7</option>
                        <option>NURSING DEPARTMENT</option>
                        <option>OBSERVE(สังเกตอาการ)</option>
                        <option>OPD CARDIO(ศูนย์หัวใจ)</option>
                        <option>OPD COUNTER NURSE (CN คัดกรอง)</option>
                        <option>OPD HEAD NECK BREAST(ศุนย์เต้านม)</option>
                        <option>OPD Lasik (ศูนย์เลสิก)</option>
                        <option>OPD MEDICINE(อายุกรรม)</option>
                        <option>OPD NEURO (ศูนย์สมอง)</option>
                        <option>OPD OB/GYN(ศุนย์สุขภาพหญิง)</option>
                        <option>OPD PEDIATRIC( แผนกเด็ก)</option>
                        <option>OPD SURGERY(ศัลยกรรม)</option>
                        <option>OPD UROLOGY (ทางเดินปัสสาวะ)</option>
                        <option>OPERATING ROOM(ห้องผ่าตัด)</option>
                        <option>PHARMARCY(เภสัชกรรม ห้องยา)</option>
                        <option>PHYATHAI BEAUTY CENTER (PBC ความงาม)</option>
                        <option>PHYSICAL THERAPY( กายภาพ)</option>
                        <option>PICU</option>
                        <option>PWA LIFE CENTER</option>
                        <option>PWA ชะลอวัย</option>
                        <option>VEHICLE</option>
                        <option>WARD 10</option>
                        <option>WARD 11</option>
                        <option>WARD 12</option>
                        <option>WARD 14</option>
                        <option>WARD 15</option>
                        <option>WARD 17</option>
                        <option>WARD 7</option>
                        <option>WARD 8</option>
                        <option>WARD 9</option>
                        <option>WAREHOUSE</option>
                        <option>X-RAY</option>
                        <option>รับส่ง</option>
                    </select>
                </div>
                <div class="col-md-6 text-center">
                    <button class="btn btn-warning w-50" id="submit-btn">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    <!--     <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        var vConsole = new window.VConsole();
    </script> -->
    <script>
        var script_url = 'https://script.google.com/macros/s/AKfycbzDtTiaRWBRWbtArS2Y9Lk5tzWOfBL5sRY8VOqYyBCySbvqobvsiqbN0NuLVcSndm0CzQ/exec'
        var profile
        var history_code = {}
        $(document).ready(function () {
            $.LoadingOverlay('show')
            $.getJSON(script_url, function (data) {
                history_code = data
                console.log("🚀 ~ history_code:", history_code)
            })

            liff.init({
                liffId: '1660749495-G5e9Av6r',
                withLoginOnExternalBrowser: true
            })
            liff.ready.then(async () => {
                checkRegist()
                profile = await liff.getProfile()
                if (profile.userId == 'U5c0c8ed83945a138718d146af61636db') {
                    Swal.fire({
                        title: 'เนื่องจากเป็น Line On Call กรุณาระบุชื่อของคุณ',
                        input: 'text',
                        inputAttributes: {
                            autocapitalize: 'off'
                        },
                        confirmButtonText: 'ยืนยัน',
                        allowOutsideClick: false,
                        preConfirm: (name) => {
                            if (name == '') {
                                Swal.showValidationMessage(
                                    `กรุณาระบุชื่อของคุณ`
                                )
                            }
                            return name
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            profile.displayName = result.value + ' (Line On Call)'
                            $('#profile').attr('src', profile.pictureUrl)
                            $('#displayName').text(profile.displayName)
                            $('.navbar .container-fluid').show(400)
                            Swal.fire({
                                title: 'สวัสดีคุณ ' + result.value,
                                text: 'ทำรายการต่อได้ครับ',
                                icon: 'success',
                                timer: 1000
                            })
                        }
                    })
                }
                $('#profile').attr('src', profile.pictureUrl)
                $('#displayName').text(profile.displayName)
                $('.navbar .container-fluid').show(400)
            })
            $('select option').each(function () {
                $(this).val($(this).text().trim())
            })
            $('select').select2({
                theme: 'bootstrap-5'
            })

            initHistory_code()
        })

        function initHistory_code() {
            //setup before functions
            var typingTimer;                //timer identifier
            var doneTypingInterval = 500;  //time in ms, 0.5 seconds for example
            var $input = $('#code');

            //on keyup, start the countdown
            $input.on('keyup', function () {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(doneTyping, doneTypingInterval);
            });

            //on keydown, clear the countdown 
            $input.on('keydown', function () {
                clearTimeout(typingTimer);
            });

            //user is "finished typing," do something
            function doneTyping() {
                let code = $('#code').val().toUpperCase()
                let his = _.pickBy(history_code, (v, k) => {
                    return k.includes(code)
                })
                if (_.size(his) > 0) {
                    his = _.values(his)[0]
                    $('#start').val(his.start).change()
                    $('#end').val(his.end).change()
                    $('.bi-arrow-down-up').parent().show(200)
                } else {
                    $('.bi-arrow-down-up').parent().hide(200)
                    $('#start').val('').change()
                    $('#end').val('').change()
                }
            }

            $('.bi-arrow-down-up').click(function () {
                // rotate element 360 degrees in 1 second
                $(this).animate({ borderSpacing: -360 }, {
                    step: function (now, fx) {
                        $(this).css('-webkit-transform', 'rotate(' + now + 'deg)');
                        $(this).css('-moz-transform', 'rotate(' + now + 'deg)');
                        $(this).css('transform', 'rotate(' + now + 'deg)');
                    },
                    duration: 'slow'
                }, 'linear');

                let start = $('#start').val()
                let end = $('#end').val()
                $('#start').val(end).change()
                $('#end').val(start).change()

            })


        }

        function checkRegist() {

            let uid = liff.getDecodedIDToken().sub
            let regist = localStorage.getItem('regist')
            console.log("🚀 ~ regist:", regist)
            if (regist == uid) {
                $.LoadingOverlay('hide')
                return
            }
            $.ajax({
                method: 'POST',
                url: script_url,
                data: {
                    opt: 'checkRegist',
                    uid: uid
                },
                success: function (res) {
                    console.log("🚀 ~ res:", res)

                    $.LoadingOverlay('hide')
                    if (!res) {

                        Swal.fire({
                            icon: 'error',
                            title: 'กรุณาลงทะเบียนก่อนใช้งาน',
                            allowOutsideClick: false,
                            confirmButtonText: 'ตกลง'
                        }).then(() => {
                            liff.closeWindow()
                        })
                    } else {
                        localStorage.setItem('regist', uid)
                    }
                }
            })
        }

        $('#submit-btn').click(function () {
            var code = $('#code').val()
            var start = $('#start').val()
            var end = $('#end').val()
            if (code == '' && checkcode(code)) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณากรอกรหัสเครื่อง',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            if (start == '' || start == null) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกแผนกต้นทาง',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }

            if (end == '' || end == null) {
                Swal.fire({
                    icon: 'error',
                    title: 'กรุณาเลือกแผนกปลายทาง',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }

            let data = {
                opt: 'add',
                code: convertCode(code),
                start: start,
                end: end,
                // uid: 'test',
                // displayName: 'yeah'
                uid: liff.getDecodedIDToken().sub,
                displayName: profile.displayName
            }

            if (start == end) {
                return Swal.fire({
                    title: 'กรุณาระบุห้องต้นทาง และปลายทาง',
                    html: `<div class="container-fluid"><div class="row"><div class="col-12"><label for="start-room">ห้องต้นทาง</label><input id="start-room" class="form-control"></div><div class="col-12"><label for="end-room">ห้องปลายทาง</label><input id="end-room" class="form-control"></div></div></div>`,
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก',
                    preConfirm: () => {
                        let start_room = $('#start-room').val()
                        let end_room = $('#end-room').val()
                        if (start_room == '' || end_room == '') {
                            Swal.showValidationMessage(`กรุณากรอกห้องต้นทาง และปลายทาง`)
                        }
                        return { start_room, end_room }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        data['start-room'] = result.value.start_room
                        data['end-room'] = end_room = result.value.end_room
                        sendPost(data)
                    }
                })
            } else {
                sendPost(data)
            }
        })

        function sendPost(data) {

            $.LoadingOverlay('show')
            $.ajax({
                url: script_url,
                type: 'POST',
                data: data,

                success: function (res) {
                    $.LoadingOverlay('hide')
                    if (res.status == 'success') {
                        console.log(res)
                    } else {
                        console.log(res);
                    }
                }
            })
            setTimeout(() => {
                $.LoadingOverlay('hide')
                liff.sendMessages([{
                    type: 'text',
                    text: `เครื่อง ${data.code}\nได้ถูกย้ายจาก\n👉${data.start}\nไปยัง\n👉${data.end}\nโดย @${data.displayName}`
                }])
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกข้อมูลสำเร็จ',
                    confirmButtonText: 'ตกลง',
                }).then(() => {
                    history_code[data.code] = {
                        start: data.start,
                        end: data.end
                    }
                    localStorage.setItem('history_code', JSON.stringify(history_code))
                    liff.closeWindow()
                })
            }, 1500)
        }

        function checkcode(code) {
            code = code.toLowerCase().replace('pyt3_', '').replace('demo_', '')
            if (!Number(code) == NaN && (code.length < 4 || code.length > 11)) {
                return false
            }

            return true
        }

        function convertCode(code) {
            code = code.toLowerCase().replace('pyt3_', '').replace('demo_', '')
            if (isNaN(code)) {
                return code
            }
            if (code.length >= 4 || code.length <= 5) {
                code = ('00000' + code).slice(-5)
                code = 'PYT3_' + code
            } else if (code.length == 6) {
                code = ('000000' + code).slice(-6)
                code = 'DEMO_' + code
            }
            return code
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

</body>

</html>