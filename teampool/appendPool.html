<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</title>
    <script src="https://fastly.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <link href="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Cedarville+Cursive&family=Mitr&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://fastly.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css">
    <script src="../teampm/main const.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #FF8604 0%, #ff9e3d 100%);
            min-height: 100vh;
            width: 100vw;
            font-family: 'Mitr', sans-serif;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        img#profile {
            width: 30px;
            height: 30px;
            object-fit: cover;
        }

        .loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #FF8604 0%, #ff6b00 50%, #ff9e3d 100%);
            position: relative;
            overflow: hidden;
        }

        .loader::before {
            content: "";
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: moveGrid 20s linear infinite;
            opacity: 0.3;
        }

        @keyframes moveGrid {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(30px, 30px);
            }
        }

        .loader::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, transparent 0%, rgba(255, 134, 4, 0.3) 100%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .wrapper {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .text {
            font-family: 'Mitr', sans-serif;
            letter-spacing: 3px;
            font-weight: 600;
            font-size: 24px;
            background: linear-gradient(135deg, #FF8604 0%, #ff6b00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 20px 0;
        }

        .spinner-loader {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #FF8604;
            border-right-color: #ff9e3d;
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .spinner-loader:nth-child(2) {
            border-color: transparent;
            border-top-color: #ff6b00;
            border-bottom-color: #ffb366;
            animation-delay: -0.4s;
        }

        .spinner-loader:nth-child(3) {
            border-color: transparent;
            border-top-color: #ff9e3d;
            border-left-color: #FF8604;
            animation-delay: -0.8s;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .box {
            display: none;
        }

        .img-grid-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 4px;
        }

        .img-grid-col {
            flex: 33.33%;
            max-width: 33.33%;
            padding: 0 4px;
        }

        .img-grid-col img {
            margin-top: 8px;
            vertical-align: middle;
            width: 100%;
        }

        .loading-progress {
            margin-top: 30px;
            width: 100%;
            max-width: 350px;
            background: rgba(255, 255, 255, 0.5);
            padding: 20px;
            border-radius: 16px;
            backdrop-filter: blur(5px);
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .progress-item i {
            font-size: 18px;
            width: 24px;
            transition: all 0.3s ease;
        }

        .progress-item.loading {
            background: linear-gradient(135deg, #fff 0%, #fff5ec 100%);
            box-shadow: 0 2px 8px rgba(255, 134, 4, 0.2);
        }

        .progress-item.loading i {
            color: #FF8604;
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .progress-item.success {
            background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
        }

        .progress-item.success i {
            color: #22c55e;
            animation: scaleIn 0.4s ease;
        }

        @keyframes scaleIn {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .progress-item.error {
            background: linear-gradient(135deg, #fff 0%, #fef2f2 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .progress-item.error i {
            color: #ef4444;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }

        .progress-item span {
            font-weight: 500;
            flex: 1;
        }

        /* Main Container Styles */
        .container-fluid.h-100 {
            position: relative;
            z-index: 1;
            padding: 20px;
        }

        .container-fluid > div {
            background: white;
            border-radius: 24px;
            padding: 40px;
            /* box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); */
            animation: fadeInUp 0.6s ease;
        }

        /* Header Title */
        .col.h4 {
            background: linear-gradient(135deg, #FF8604 0%, #ff6b00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 30px;
        }

        /* Form Labels */
        label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        /* Modern Input & Select Styles */
        .form-control,
        .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f9fafb;
            font-family: 'Mitr', sans-serif;
        }

        .form-control:focus,
        .form-select:focus {
            outline: none;
            border-color: #FF8604;
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 134, 4, 0.1);
            transform: translateY(-2px);
        }

        .form-control:hover,
        .form-select:hover {
            border-color: #ff9e3d;
            background: white;
        }

        /* Badge Buttons */
        .badge {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .badge.text-bg-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .badge.text-bg-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .badge.text-bg-primary:active {
            transform: translateY(0);
        }

        /* Swap Button */
        .btn-success.rounded-circle {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
            border: none;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            transition: all 0.3s ease;
        }

        .btn-success.rounded-circle:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        /* File Input */
        input[type="file"].form-control {
            padding: 14px;
            cursor: pointer;
        }

        input[type="file"].form-control::file-selector-button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #FF8604 0%, #ff6b00 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        input[type="file"].form-control::file-selector-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 134, 4, 0.3);
        }

        /* Submit Button */
        .btn-warning {
            background: linear-gradient(135deg, #FF8604 0%, #ff6b00 100%) !important;
            border: none;
            color: white !important;
            font-weight: 600;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 134, 4, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 134, 4, 0.4);
        }

        .btn-warning:active {
            transform: translateY(0);
        }

        /* Image Grid */
        .img-grid-col img {
            margin-top: 8px;
            vertical-align: middle;
            width: 100%;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .img-grid-col img:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        /* Navbar Styles */
        .navbar {
            background: transparent;
            padding: 20px;
        }

        .navbar .container-fluid {
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            color: #333;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .navbar-brand:hover {
            color: #FF8604;
        }

        img#profile {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        img#profile:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 134, 4, 0.3);
        }

        /* Select2 Custom Styles */
        .select2-container--bootstrap-5 .select2-selection {
            border: 2px solid #e5e7eb !important;
            border-radius: 12px !important;
            background: #f9fafb !important;
            min-height: 46px !important;
        }

        .select2-container--bootstrap-5.select2-container--focus .select2-selection,
        .select2-container--bootstrap-5.select2-container--open .select2-selection {
            border-color: #FF8604 !important;
            box-shadow: 0 0 0 4px rgba(255, 134, 4, 0.1) !important;
        }

        .select2-container--bootstrap-5 .select2-dropdown {
            border: 2px solid #FF8604 !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
        }

        .select2-container--bootstrap-5 .select2-results__option--highlighted {
            background-color: #FF8604 !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container-fluid > div {
                padding: 24px;
                border-radius: 16px;
            }

            .col.h4 {
                font-size: 24px;
            }

            .btn-warning {
                width: 100% !important;
            }
        }

        /* Animation for row items */
        .row.g-3 > div {
            animation: slideInUp 0.6s ease;
            animation-fill-mode: both;
        }

        .row.g-3 > div:nth-child(1) { animation-delay: 0.1s; }
        .row.g-3 > div:nth-child(2) { animation-delay: 0.2s; }
        .row.g-3 > div:nth-child(3) { animation-delay: 0.3s; }
        .row.g-3 > div:nth-child(4) { animation-delay: 0.4s; }
        .row.g-3 > div:nth-child(5) { animation-delay: 0.5s; }
        .row.g-3 > div:nth-child(6) { animation-delay: 0.6s; }
        .row.g-3 > div:nth-child(7) { animation-delay: 0.7s; }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="fixed-top">
        <div class="loader">
            <div class="wrapper">
                <div class="text">LOADING</div>
                <div class="spinner-container">
                    <div class="spinner-loader"></div>
                    <div class="spinner-loader"></div>
                    <div class="spinner-loader"></div>
                </div>
                <div class="loading-progress">
                    <div class="progress-item" id="progress-history">
                        <i class="bi bi-hourglass-split"></i>
                        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</span>
                    </div>
                    <div class="progress-item" id="progress-regist">
                        <i class="bi bi-hourglass-split"></i>
                        <span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...</span>
                    </div>
                    <div class="progress-item" id="progress-telegram">
                        <i class="bi bi-hourglass-split"></i>
                        <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Telegram...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar">
        <div class="container-fluid" style="display: none">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://www.appdisqus.com/wp-content/uploads/2015/02/despicable_me_2_minions-1920x1080.jpg"
                    alt="profile" id="profile" class="rounded-circle border d-inline-block align-text-top">
                &nbsp; <div>
                    <span id="displayName">Team PM</span>
                </div>
            </a>
        </div>
    </nav>
    <div class="container-fluid h-100 d-flex justify-content-center align-items-center">
        <div class="px-4 py-4">
            <div class="row justify-content-center">
                <div class="col h4 fw-bold text-center text-dark">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢
                </div>
            </div>
            <div class="row g-3 justify-content-center">
                <div class="col-md-6">
                    <label for="code">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                    <input type="text" class="form-control text-center" id="code" name="code">
                </div>
                <div class="col-md-12">
                    <div class="d-flex gap-2">
                        <span class="badge text-bg-primary btn" id="scope">Scope</span>
                        <span class="badge text-bg-primary btn" id="ups">UPS</span>

                    </div>
                </div>
                <div class="col-md-6" id="div-start">
                    <label for="start">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
                    <select name="start" id="start" class="form-select">
                        <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</option>
                    </select>
                </div>
                <div class="mt-3 d-flex justify-content-center w-100" style="display:none"><i
                        class="bi bi-arrow-down-up text-light fs-2 btn btn-success rounded-circle"></i></div>
                <div class="col-md-6" id="div-end">
                    <label for="end">‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                    <select name="end" id="end" class="form-select">
                        <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
                    </select>
                </div>
                <div class="col-12">
                    <label for="files">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
                    <!-- accept only image and video -->
                    <input type="file" class="form-control" name="telegram-files" id="telegram-files" multiple
                        accept="image/*">
                </div>

                <div class="col-md-6 text-center">
                    <button class="btn btn-warning w-50" id="submit-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                <div class="col-12">
                    <div class="img-grid-row d-flex flex-wrap">
                        <div class="img-grid-col"></div>
                        <div class="img-grid-col"></div>
                        <div class="img-grid-col"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        // var vConsole = new window.VConsole();
    </script>
    <script>
        var script_url = 'https://script.google.com/macros/s/AKfycbzDtTiaRWBRWbtArS2Y9Lk5tzWOfBL5sRY8VOqYyBCySbvqobvsiqbN0NuLVcSndm0CzQ/exec'
        var profile
        var tg_const
        var history_code = {}
        $(document).on('select2:open', () => {
            document.querySelector('.select2-search__field').focus();
        });
        $(document).ready(function () {
            NProgress.start();
            NProgress.inc()
            $('#end').append($('#start option').not(':first-child').clone())
            $('#ups').click(function () {
                Swal.fire({
                    input: 'number',
                    title: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UPS',
                    inputPlaceholder: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç UPS',
                    customClass: {
                        input: 'text-center',
                        popup: 'rounded-4'
                    },
                    showCancelButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    preConfirm: (ups) => {
                        return ups
                    }
                }).then(res => {
                    if (res.isConfirmed) {
                        if (res.value == '' || res.value == null) $('#code').val('UPS')
                        else $('#code').val('UPS ' + ('00' + res.value).slice(-2))
                    }
                })
            })

            $('#scope').click(function () {
                $('#code').val('SCOPE')
            })

            liff.init({
                liffId: '1660749495-G5e9Av6r',
                // liffId: '1660749495-A2gmPQNb',
                withLoginOnExternalBrowser: true
            })
            // $('.loader').fadeOut(500)
            liff.ready.then(async () => {

                const fetchTelegramConstants = (retries = 5) => {
                    return new Promise((resolve, reject) => {
                        $.ajax({
                            url: script_url,
                            type: 'POST',
                            data: {
                                opt: 'gettelegram'
                            },
                            timeout: 30000,
                            success: function (res) {
                                tg_const = res;
                                console.log("Successfully retrieved telegram constants");
                                resolve(tg_const);
                            },
                            error: function () {
                                if (retries > 0) {
                                    console.log(`Failed to get telegram constants, retrying... (${5 - retries + 1}/5)`);
                                    setTimeout(() => {
                                        fetchTelegramConstants(retries - 1).then(resolve).catch(reject);
                                    }, 1000);
                                } else {
                                    console.error("Failed to get telegram constants after 5 retries");
                                    Swal.fire({
                                        customClass: {
                                            popup: 'rounded-4'
                                        },
                                        icon: 'warning',
                                        title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Telegram ‡πÑ‡∏î‡πâ',
                                        text: '‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ',
                                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                                    });
                                    resolve(null); // Resolve with null to not block other operations
                                }
                            }
                        });
                    });
                };

                // Run all initialization tasks in parallel
                await Promise.all([
                    new Promise((resolve) => {
                        $('#progress-history').addClass('loading');
                        $.getJSON(script_url, function (data) {
                            history_code = data;
                            console.log("Successfully retrieved history codes");
                            $('#progress-history')
                                .removeClass('loading')
                                .addClass('success')
                                .find('i')
                                .removeClass('bi-hourglass-split')
                                .addClass('bi-check-circle-fill');
                            $('#progress-history span').text('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            resolve(data);
                        }).fail(() => {
                            $('#progress-history')
                                .removeClass('loading')
                                .addClass('error')
                                .find('i')
                                .removeClass('bi-hourglass-split')
                                .addClass('bi-x-circle-fill');
                            $('#progress-history span').text('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                            resolve(null);
                        });
                    }),
                    (async () => {
                        $('#progress-regist').addClass('loading');
                        try {
                            await checkRegist();
                            $('#progress-regist')
                                .removeClass('loading')
                                .addClass('success')
                                .find('i')
                                .removeClass('bi-hourglass-split')
                                .addClass('bi-check-circle-fill');
                            $('#progress-regist span').text('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } catch (err) {
                            $('#progress-regist')
                                .removeClass('loading')
                                .addClass('error')
                                .find('i')
                                .removeClass('bi-hourglass-split')
                                .addClass('bi-x-circle-fill');
                            $('#progress-regist span').text('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                        }
                    })(),
                    (async () => {
                        $('#progress-telegram').addClass('loading');
                        try {
                            await fetchTelegramConstants();
                            $('#progress-telegram')
                                .removeClass('loading')
                                .addClass('success')
                                .find('i')
                                .removeClass('bi-hourglass-split')
                                .addClass('bi-check-circle-fill');
                            $('#progress-telegram span').text('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } catch (err) {
                            $('#progress-telegram')
                                .removeClass('loading')
                                .addClass('error')
                                .find('i')
                                .removeClass('bi-hourglass-split')
                                .addClass('bi-x-circle-fill');
                            $('#progress-telegram span').text('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Telegram ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                        }
                    })()
                ]);
                console.log("Successfully retrieved all initialization data");
                profile = await liff.getProfile()
                $('.loader').fadeOut(500)
                if (profile.userId == 'U5c0c8ed83945a138718d146af61636db' || profile.userId == 'U6664113cf382c2c6b77b94e8deb7b7ea') {
                    Swal.fire({
                        customClass: {
                            popup: 'rounded-4'
                        },
                        title: '‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Line ' + profile.displayName + ' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                        html: '<div container-fluid><div class="row"><div class="col-12"><select id="name-onc" class="form-select">' +
                            '<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</option>' +
                            '<option value="PASSAWAN TOANUN">PASSAWAN TOANUN</option>' +
                            '<option value="SERMKEAT HADJANG">SERMKEAT HADJANG</option>' +
                            '<option value="CHANCHAI SAE-LEE">CHANCHAI SAE-LEE</option>' +
                            '<option value="SARAN THAMMATHORN">SARAN THAMMATHORN</option>' +
                            '<option value="PUKARIN TONGKLIANG">PUKARIN TONGKLIANG</option>' +
                            '<option value="ANUPHAB CHANTO">ANUPHAB CHANTO</option>' +
                            '<option value="NARUECHA CHAIYAPHAN">NARUECHA CHAIYAPHAN</option>' +
                            '<option value="ITTIPAT IEMDEE">ITTIPAT IEMDEE</option>' +
                            '<option value="SASIMAPORN KHANTHAHOME">SASIMAPORN KHANTHAHOME</option>' +
                            '<option value="DARANPHOP YIMYAM">DARANPHOP YIMYAM</option>' +
                            '<option value="RAPIPHAN KHAMSUWAN">RAPIPHAN KHAMSUWAN</option>' +
                            '<option value="SOM KONKAEW">SOM KONKAEW</option>' +
                            '<option value="RATCHATA PIRIYAKITSAKUL">RATCHATA PIRIYAKITSAKUL</option>' +
                            '<option value="ILADA BUAPRALAT">ILADA BUAPRALAT</option>' +
                            '<option value="JIRASSAYA CHUENYOO">JIRASSAYA CHUENYOO</option>' +
                            '</div></div></div>',
                        customClass: {
                            input: 'form-select'
                        },
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        allowOutsideClick: false,
                        preConfirm: () => {
                            let name = $('#name-onc').val()
                            if (name == '' || name == null) {
                                Swal.showValidationMessage(
                                    `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`
                                )
                            }
                            return name
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            profile.displayName = result.value + ' (' + profile.displayName + ')'
                            $('#profile').attr('src', profile.pictureUrl)
                            $('#displayName').text(profile.displayName).attr('data-name', result.value.toUpperCase())
                            $('.navbar .container-fluid').show(400)
                            Swal.fire({
                                customClass: {
                                    popup: 'rounded-4'
                                },
                                title: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ' + result.value,
                                text: '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö',
                                showConfirmButton: false,
                                icon: 'success',
                                timer: 1000
                            })
                        }
                    })
                }
                $('#profile').attr('src', profile.pictureUrl)
                $('#displayName').text(profile.displayName)
                $('.navbar .container-fluid').show(400)
                console.log("User profile updated");
                NProgress.done();
            })
            $('select option').each(function () {
                $(this).val($(this).text().trim())
            })
            $('select').select2({
                theme: 'bootstrap-5'
            })
            initHistory_code()
            $('#start, #end').append(depts_array.sort().map(dept => {
                return `<option value="${dept}">${dept}</option>`
            }).join(''))

        })
        function initHistory_code() {
            const $input = $('#code');
            const $start = $('#start');
            const $end = $('#end');
            const $swapButton = $('.bi-arrow-down-up');
            const $swapParent = $swapButton.parent();
            const $divStart = $('#div-start');
            const $divEnd = $('#div-end');
            const DEBOUNCE_DELAY = 500;
            const ANIMATION_DURATION = 500;
            
            let typingTimer;

            // Debounced lookup function
            const lookupHistory = () => {
                const code = $input.val().toUpperCase().trim();
                
                if (!code) {
                    resetFields();
                    return;
                }

                // Find matching history entry
                const matchingEntry = Object.entries(history_code).find(([key]) => 
                    key.includes(code)
                );

                if (matchingEntry) {
                    const [, data] = matchingEntry;
                    $start.val(data.start).trigger('change');
                    $end.val(data.end).trigger('change');
                    $swapParent.show(200);
                } else {
                    resetFields();
                }
            };

            // Reset fields helper
            const resetFields = () => {
                $swapParent.hide(200);
                $start.val('').trigger('change');
                $end.val('').trigger('change');
            };

            // Input event handlers with debouncing
            $input.on('input', () => {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(lookupHistory, DEBOUNCE_DELAY);
            });

            // Swap animation handler
            $swapButton.on('click', function() {
                console.log("Swap button clicked");
                const $this = $(this);
                
                // Add exit animations
                $divStart.slideUp(ANIMATION_DURATION);
                $divEnd.slideUp(ANIMATION_DURATION);

                setTimeout(() => {
                    // Swap values
                    const startVal = $start.val();
                    const endVal = $end.val();
                    $start.val(endVal).trigger('change');
                    $end.val(startVal).trigger('change');

                    // Remove exit animations and add entry animations
                    $divStart.slideDown(ANIMATION_DURATION);
                    $divEnd.slideDown(ANIMATION_DURATION);
                }, ANIMATION_DURATION);

                // Rotate icon animation with CSS transform
                $this.css({
                    transition: 'transform 0.6s linear',
                    transform: 'rotate(-360deg)'
                });
                
                setTimeout(() => {
                    $this.css({
                        transition: '',
                        transform: ''
                    });
                }, 600);
            });
        }
        async function checkRegist() {
            return new Promise(async (resolve, reject) => {
                let uid = await getUID()
                let regist = localStorage.getItem('regist')
                if (regist != null) {
                    try {
                        regist = JSON.parse(regist)
                    } catch (e) {
                        regist = {
                            uid: null
                        }
                    }
                } else {
                    regist = {
                        uid: null
                    }
                }

                if (regist?.uid == uid && regist?.name != null && regist?.name != '' && regist?.telegram_id) {
                    // $.LoadingOverlay('hide')
                    // $('.loader').fadeOut(500)
                    $('#displayName').attr('data-name', regist.name.toUpperCase())
                    console.log("User registration found in local storage");
                    resolve()
                }
                $.ajax({
                    method: 'POST',
                    url: script_url,
                    data: {
                        opt: 'checkRegist',
                        uid: uid
                    },
                    success: function (res) {

                        // $.LoadingOverlay('hide')
                        $('.loader').fadeOut(500)
                        if (!res) {
                            Swal.fire({
                                customClass: {
                                    popup: 'rounded-4'
                                },
                                icon: 'error',
                                title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                                allowOutsideClick: false,
                                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                            }).then(() => {
                                liff.closeWindow()
                            })
                            console.log("No user registration found, redirecting to registration");
                            reject()
                        } else {
                            localStorage.setItem('regist', JSON.stringify(res))
                            $('#displayName').attr('data-name', res.name.toUpperCase())
                            console.log("User registration found from server");
                            resolve()
                        }
                    }
                })
            })
        }
        $('#submit-btn').click(async function () {
            var code = $('#code').val()
            var start = $('#start').val()
            var end = $('#end').val()
            if (code == '' && checkcode(code)) {
                Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            if (start == '' || start == null) {
                Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            if (end == '' || end == null) {
                Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            if ($('#telegram-files')[0].files.length == 0) {
                Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    icon: 'error',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û',
                    showConfirmButton: false,
                    timer: 1500
                })
                return false
            }
            let data = {
                opt: 'add',
                code: convertCode(code),
                start: start,
                end: end,
                name: $('#displayName').attr('data-name'),
                // uid: 'test',
                // displayName: 'yeah'
                uid: await getUID(),
                displayName: profile.displayName
            }
            if (start == end) {
                return Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
                    html: `<div class="container-fluid"><div class="row"><div class="col-12"><label for="start-room">‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input id="start-room" class="form-control"></div><div class="col-12"><label for="end-room">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label><input id="end-room" class="form-control"></div></div></div>`,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    preConfirm: () => {
                        let start_room = $('#start-room').val()
                        let end_room = $('#end-room').val()
                        if (start_room == '' || end_room == '') {
                            Swal.showValidationMessage(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á`)
                        }
                        return { start_room, end_room }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        data['start-room'] = result.value.start_room
                        data['end-room'] = end_room = result.value.end_room
                        sendPost(data)
                    }
                })
            } else if (start.toLowerCase().indexOf('ward') > -1 || end.toLowerCase().indexOf('ward') > -1 || start == '‡∏ä‡∏±‡πâ‡∏ô 20' || end == '‡∏ä‡∏±‡πâ‡∏ô 20') {
                let start_room_html = `<div class="col-12"><label for="start-room">‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á ${start}</label><input id="start-room" class="form-control"></div>`
                let end_room_html = `<div class="col-12"><label for="end-room">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ${end}</label><input id="end-room" class="form-control"></div>`
                let div = $('<div>', { class: 'container-fluid' }).append($('<div>', { class: 'row g-2' }))
                let title = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏'
                div.find('.row').append($('<div>', { class: 'col-12 h5' }).html(`<i class="bi bi-door-open-fill"></i><span id="room-swal-title">${title}</span>`))
                div.find('.row').append($('<div>', { class: 'col-12 alert alert-warning p-1' }).html(`<i class="bi bi-exclamation-triangle-fill"></i> <u>‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ</u>`))
                if (start.toLowerCase().indexOf('ward') > -1 || start == '‡∏ä‡∏±‡πâ‡∏ô 20') {
                    title += '‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á'
                    div.find('.row').append($(start_room_html))
                }
                if (end.toLowerCase().indexOf('ward') > -1 || end == '‡∏ä‡∏±‡πâ‡∏ô 20') {
                    title += ' ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
                    div.find('.row').append($(end_room_html))
                }
                return Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    html: div[0].outerHTML,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    preConfirm: () => {
                        let start_room = $('#start-room').val()
                        let end_room = $('#end-room').val()
                        return { start_room, end_room }
                    },
                    didOpen: () => {
                        $('#room-swal-title').text(title)
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (result.value.start_room != '') data['start-room'] = result.value.start_room
                        if (result.value.end_room != '') data['end-room'] = end_room = result.value.end_room
                        sendPost(data)
                    }
                })
            }
            else {
                sendPost(data)
            }
        })
        function getCompressionQuality(file) {
            let quality = 0.3
            switch (true) {
                case file.size / 1024 <= 200:
                    quality = 0.6
                    break;

                case file.size / 1024 <= 600:
                    quality = 0.4
                    break;

                case file.size / 1024 <= 2000:
                    quality = 0.2
                    break;
                default:
                    quality = 0.2
                    break;
            }
            return quality
        }

        $('#telegram-files').change(function () {
            if (this.files.length == 0) return
            // compress file
            Swal.fire({
                customClass: {
                    popup: 'rounded-4'
                },
                icon: 'info',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            let dataTransfer = new DataTransfer();
            const files = this.files;
            let length = files.length
            $('.img-grid-col').empty()
            Array.from(files).map((file, i) => {
                let mime = file.type == "" ? file.name.split('.')[1] : file.type.split('/')[1]
                const quality = getCompressionQuality(file)
                if (mime == 'heic') {
                    let reader = new FileReader();
                    reader.onload = function (e) {
                        let blob = new Blob([e.target.result], { type: file.type });

                        heic2any({
                            blob,
                            toType: "image/jpeg",
                            quality: quality
                        }).then((conversionResult) => {
                            let f = new File([conversionResult], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            dataTransfer.items.add(f);
                            appendPreview(URL.createObjectURL(f), i)
                            if (dataTransfer.items.length == length) {
                                $('#telegram-files')[0].files = dataTransfer.files;
                                Swal.close()
                            }
                        }).catch((e) => {
                            console.log("üöÄ ~ e:", e)
                        });
                    }
                    reader.readAsArrayBuffer(file);
                } else {
                    new Compressor(file, {
                        quality: quality,
                        success(result) {

                            let f = new File([result], file.name, {
                                type: file.type,
                                lastModified: Date.now()
                            });
                            dataTransfer.items.add(f);
                            appendPreview(URL.createObjectURL(f), i)
                            if (dataTransfer.items.length == length) {
                                $('#telegram-files')[0].files = dataTransfer.files;
                                Swal.close()
                            }
                        },
                        error(err) {
                            console.log(err.message);
                        },
                    });
                }
            })
        })
        const retryRequest = (fn, retries = 3) => {
            return fn().catch(err => {
                if (retries > 0) {
                    return retryRequest(fn, retries - 1);
                } else {
                    throw err;
                }
            });
        };
        let success_all = 0
        const checkDone = () => {

            if (success_all >= 6) {
                setTimeout(() => {
                    Swal.fire({
                        customClass: {
                            popup: 'rounded-4'
                        },
                        icon: 'success',
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                        timer: 800,
                        allowOutsideClick: false,
                        timerProgressBar: true
                    }).then(() => {
                        liff.closeWindow()
                    })
                }, 200);
            }
        }

        function appendPreview(fileurl, i) {

            let eq = i % 3

            $('.img-grid-col').eq(eq).append($('<img>', { src: fileurl }).on('click', function () {
                Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    imageUrl: fileurl,
                    imageWidth: '100%',
                    imageHeight: '100%',
                    showCloseButton: true,
                    showConfirmButton: false,
                    allowOutsideClick: false
                })
            }))
        }

        async function sendPost(data) {
            Swal.fire({
                customClass: {
                    popup: 'rounded-4'
                },
                icon: 'info',
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                html: '<div class="container-fluid"><div class="row">' +
                        '<div class="col-12 text-center text-muted" id="status-history"><i class="bi bi-hourglass-split"></i></i> ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>' +
                        '<div class="col-12 text-center text-muted" id="status-gsheet"><i class="bi bi-hourglass-split"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet</div>' +
                        '<div class="col-12 text-center text-muted" id="status-nsmart"><i class="bi bi-hourglass-split"></i></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Job Consult</div>' +
                        '<div class="col-12 text-center text-muted" id="status-telegram"><i class="bi bi-hourglass-split"></i></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram</div>'+
                    '</div></div>' ,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading()
                }
            })
            console.time('sendPost')
            let result_name, mediagroup_id
            let files = $('#telegram-files')[0].files;
            let tg_msg_id, tg_caption, tg_sent = false

            Promise.all([
                retryRequest(() => new Promise((resolve, reject) => {
                    if (files.length > 0) {
                        const media = [];
                        const formData = new FormData();
                        const sendMediaUrl = `https://api.telegram.org/bot${tg_const.token}/sendMediaGroup`;
                        Array.from(files).forEach((file) => {
                            media.push({
                                type: "photo",  // Set the type of media
                                media: `attach://${file.name}` // Use 'attach://' for file attachment
                            });
                            formData.append(file.name, file); // Attach the file to the FormData
                        });

                        // Attach media to FormData
                        formData.append("chat_id", tg_const.chatId); // Add chat_id
                        formData.append("media", JSON.stringify(media)); // Add media array

                        // Send images as a media group
                        $.ajax({
                            url: sendMediaUrl,
                            type: 'POST',
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: function (mediaResponse) {
                                if (mediaResponse.ok) {
                                    success_all++
                                    checkDone()
                                    mediagroup_id = mediaResponse.result[0].message_id
                                    tg_msg_id = mediaResponse.result[0].message_id
                                    if (tg_msg_id && tg_caption && !tg_sent) {
                                        tg_sent = true
                                        sendTelegram(tg_msg_id, tg_caption, data)
                                    }
                                    resolve(mediagroup_id)
                                } else {
                                    alert("Error sending images: " + mediaResponse.description);
                                    reject(mediaResponse.description);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                console.error("Error sending images:", errorThrown);
                                reject(errorThrown);
                            }
                        });
                    } else {
                        $('#status-telegram').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram').removeClass('text-muted').addClass('text-success')
                        resolve('no file')
                    }
                })),
                retryRequest(() => new Promise((resolve, reject) => {

                    $.ajax({
                        url: script_url,
                        type: 'POST',
                        data: data,
                        timeout: 10000,
                        success: function (res) {
                            if (res.status == 'success') {
                                success_all++
                                checkDone()
                                let data = res
                                $('#status-gsheet').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet').removeClass('text-muted').addClass('text-success')
                                let regist = JSON.parse(localStorage.getItem('regist'))
                                let msg = `
<b>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${data.e_name}</b> (${data.code})

‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å

üëâ <i>${data.start}</i>

‡πÑ‡∏õ‡∏¢‡∏±‡∏á

üëâ <i>${data.end}</i>

‡πÇ‡∏î‡∏¢ <a href="tg://user?id=${regist.telegram_id}">@${data.name == "" ? liff.getDecodedIDToken().name : data.name}</a>

<a href="https://lin.ee/9Ganv2I">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°</a>`
                                tg_caption = msg
                                if (tg_msg_id && tg_caption && !tg_sent) {
                                    tg_sent = true
                                    sendTelegram(tg_msg_id, tg_caption, data)
                                }
                                resolve(msg)
                            } else {
                                $('#status-gsheet').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet')
                                reject()
                            }
                        },
                        error: function () {
                            $('#status-gsheet').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet')
                            reject()
                        }
                    })
                })),
                retryRequest(() => new Promise((resolve, reject) => {

                    $.post(script_url, {
                        opt: 'setHistory',
                        code: data.code,
                        start: data.start,
                        end: data.end
                    }, (res) => {
                        if (res.status == 'success') {
                            success_all++
                            checkDone()
                            $('#status-history').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥').removeClass('text-muted').addClass('text-success')
                            resolve(res)
                        } else {
                            $('#status-history').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥')
                            reject()
                        }
                    })
                })),
                retryRequest(() => new Promise((resolve, reject) => {

                    $.post(script_url, {
                        opt: 'savejobconsult',
                        code: data.code,
                        start: data.start,
                        end: data.end,
                        name: $('#displayName').attr('data-name'),
                        ['start-room']: data['start-room'],
                        ['end-room']: data['end-room']
                    }, (res) => {
                        if (res.status == 'success') {
                            $('#status-nsmart').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Job Consult').removeClass('text-muted').addClass('text-success')
                            success_all++
                            checkDone()
                            resolve(res)
                        } else {
                            $('#status-nsmart').html('<i class="bi bi-x-circle-fill text-danger"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Job Consult')
                            reject()
                        }
                    })
                }))
            ]).then((save_res) => {

                console.timeEnd('sendPost')
                setTimeout(async () => {
                    liff.sendMessages([{
                        type: 'text',
                        text: `‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${data.code}\n‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å\nüëâ${data.start}\n‡πÑ‡∏õ‡∏¢‡∏±‡∏á\nüëâ${data.end}\n‡πÇ‡∏î‡∏¢ @${data.displayName}`
                    }]).then(() => {
                        success_all++
                        checkDone()
                    }).catch((err) => {
                        console.error('error', err);
                    });
                    // sendTelegram(save_res[0], save_res[1], data)
                }, 200);
            }).catch(err => {
                Swal.fire({
                    customClass: {
                        popup: 'rounded-4'
                    },
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n\n' + err,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            });
        }

        function checkcode(code) {
            code = code.toLowerCase().replace('pyt3_', '').replace('demo_', '')
            if (!Number(code) == NaN && (code.length < 4 || code.length > 11)) {
                return false
            }
            return true
        }
        function convertCode(code) {
            code = code.toLowerCase().replace('pyt3_', '').replace('demo_', '')
            if (isNaN(code)) {
                return code
            }
            if (code.length >= 4 || code.length <= 5) {
                code = ('00000' + code).slice(-5)
                code = 'PYT3_' + code
            } else if (code.length == 6) {
                code = ('000000' + code).slice(-6)
                code = 'DEMO_' + code
            }
            return code
        }

        async function sendTelegram(id, message, data) {
            let editMessageUrl = 'https://api.telegram.org/bot' + tg_const.token + '/editMessageCaption'
            let caption = message
            let { start, end, me_code } = data
            retryRequest(async () => {
                await new Promise((resolve, reject) => {
                    if (id == 'no file') {
                        $.ajax({
                            url: `https://api.telegram.org/bot${tg_const.token}/sendMessage`,
                            type: 'POST',
                            data: {
                                chat_id: tg_const.chatId,
                                text: caption,
                                parse_mode: 'HTML',
                                show_caption_above_media: true,
                            },
                            success: function (response) {
                                if (response.ok) {
                                    $('#status-telegram').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram').removeClass('text-muted').addClass('text-success')

                                    history_code[me_code] = {
                                        start: start,
                                        end: end
                                    }
                                    localStorage.setItem('history_code', JSON.stringify(history_code))
                                    success_all++
                                    checkDone()
                                    resolve(response)
                                } else {
                                    alert("Error sending message: " + response.description);
                                }
                            },
                        })
                    } else {
                        $.ajax({
                            url: editMessageUrl,
                            type: 'POST',
                            data: {
                                chat_id: tg_const.chatId,
                                message_id: id,
                                caption: caption,
                                parse_mode: 'HTML',
                                show_caption_above_media: true,

                            },
                            success: function (response) {
                                if (response.ok) {
                                    $('#status-telegram').html('<i class="bi bi-check-circle-fill text-success"></i>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram').removeClass('text-muted').addClass('text-success')

                                    history_code[me_code] = {
                                        start: start,
                                        end: end
                                    }
                                    localStorage.setItem('history_code', JSON.stringify(history_code))
                                    success_all++
                                    checkDone()
                                    resolve(response)
                                } else {
                                    alert("Error sending message: " + response.description);
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error:", error);
                                alert("Error sending message.");
                            }
                        })
                    }
                })

            })
        }

        async function getUID() {
            return await new Promise(async resolve => {
                if (liff.getDecodedIDToken()) {
                    resolve(liff.getDecodedIDToken().sub)
                } else {
                    await liff.getProfile().then(profile => {
                        resolve(profile.userId)
                    }).catch(err => {
                        console.log(err)
                        Swal.fire({
                            customClass: {
                                popup: 'rounded-4'
                            },
                            icon: 'error',
                            title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ',
                            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                        })
                    })
                }
            })
        }
    </script>
    <script src="https://fastly.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://fastly.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script charset="utf-8" src="./liff-sdk.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
</body>

</html>