<!DOCTYPE html>
<html lang="en">

<head>
    <!-- dont keep cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <base target="_top">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
    <!-- icon -->
    <link rel="icon" href="https://img.icons8.com/color/48/property-time.png" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.datatables.net/v/bs5/dt-1.13.8/r-2.5.0/datatables.min.css" rel="stylesheet">

    <script src="https://cdn.datatables.net/v/bs5/dt-1.13.8/r-2.5.0/datatables.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: 'Prompt', sans-serif;
            /* background-color: #26bbed; */
            /* background-color: #D3D3D3; */
        }

        #sticker {
            width: 100%;
            height: 100%;
        }

        .nsmart-img {
            cursor: grab;
        }

        .nsmart-img:active {
            cursor: grabbing;
        }
    </style>
    <title>Timesheet Form</title>
</head>

<body>
    <nav class="navbar" style="background-color: #242e68;">
        <div class="container-fluid">
            <img width="30" height="30" src="https://img.icons8.com/color/48/property-time.png" />
        </div>
    </nav>
    <header>
        <div class="container-fluid d-flex flex-column align-items-center justify-content-center w-100 mt-4">
            <div class="col-auto">
                <img width="80" height="80" src="https://img.icons8.com/color/48/property-time.png" />
            </div>
            <div class="col text-center">
                <h4 class="h1 fw-bold">Timesheet Form</h4>
                <h4 class="fw-bold">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h4>
            </div>
        </div>

    </header>
    <main>
        <div class="container-fluid">
            <form id="myForm" class="mt-3 mb-5" novalidate>
                <section class="m-md-2 m-1 mt-4 rounded-2 bg-light p-3 shadow">
                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <select name="month" id="month" class="form-select">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select name="year" id="year" class="form-select">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4 col-6">
                            <button type="button" class="btn btn-warning w-100" id="auto-onc">Auto Fill ON Call</button>
                        </div>
                        <div class="col-md-4 col-6">
                            <button type="button" class="btn btn-danger w-100" id="auto-off">Auto Fill Day-Off</button>
                        </div>
                    </div>
                    <div class="row mt-2 g-3">
                        <div class="col-md-4">
                            <label for="time-in" class="fw-bold mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="time-in" id="time-in1" value="716">
                                <label class="form-check-label" for="time-in1">
                                    07:00 - 16:00 ‡∏ô.
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="time-in" id="time-in2" value="817"
                                    checked>
                                <label class="form-check-label" for="time-in2">
                                    08:00 - 17:00 ‡∏ô.
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row justify-content-start mt-3">
                        <form id="myForm">
                            <div id="myForm" class="table-responsive"></div>
                        </form>
                    </div>
                    <div class="row mt-4 d-none">
                        <div class="col-12">
                            <div class="alert alert-primary">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="show-summary" value="option1">
                                    <label class="form-check-label" for="show-summary">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ON CALL</label>
                                </div>
                                <div class="row justify-content-start mt-3" style="display: none;">
                                    <div class="col-md-4">
                                        <label for="onc-hour">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á On Call</label>
                                        <input type="number" class="form-control" id="onc-hour" value="0">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="per-hour">‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</label>
                                        <input type="text" class="form-control" id="per-hour">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="total">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</label>
                                        <input type="text" class="form-control" id="total" readonly>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row justify-content-center">
                        <div class="col-md-4 mt-3 text-center">
                            <button type="button" id="submit-btn" class="btn btn-primary" style="min-width: 200px;"><img
                                    width="30" src="https://img.icons8.com/papercut/60/pdf.png" alt="opened-folder" />
                                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå</button>
                        </div>
                        <!-- print -->
                        <div class="col-md-4 mt-3 text-center d-none">
                            <button type="button" id="print-btn" class="btn btn-outline-primary"
                                style="min-width: 200px;"><img width="30"
                                    src="https://img.icons8.com/color/48/print.png" alt="opened-folder" />
                                ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        </div>
                </section>

            </form>
            <iframe id="pdf" style="width: 100%; height: calc(100vw *(1.4142)); display: none;"></iframe>
        </div>
    </main>
    <!-- vconsole -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vConsole/3.9.1/vconsole.min.js"></script>
    <script>
        var vConsole = new VConsole();
    </script> -->
    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwdHWd3KFg6GMJsNKmVp69oyRAhpzWRjiWxUYFU8QBXoLHkNYM07qUEbR0s5roYpAnHag/exec'
        var form_pdf_bytes, font_bytes
        var time_in = 817
        $(document).ready(async function () {
            $('[name="time-in"]').change(function () {
                Swal.fire({
                    icon: 'question',
                    title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô',
                    text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                    showCancelButton: true,
                    confirmButtonText: '‡πÉ‡∏ä‡πà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏¢',
                    cancelButtonText: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                }).then((result) => {
                    if (result.isConfirmed) {
                        time_in = $(this).val()
                        $('#table tbody tr td select.start_time').each(function () {
                            let row = $(this).closest('tr')
                            let worktype = row.find('select.worktype').val()
                            if (worktype == 'On Call' || worktype == 'Off') return
                            $(this).val(time_in == '716' ? '07:00' : '08:00')
                        })
                        $('#table tbody tr td select.end_time').each(function () {
                            let row = $(this).closest('tr')
                            let worktype = row.find('select.worktype').val()
                            if (worktype == 'On Call' || worktype == 'Off') return
                            $(this).val(time_in == '716' ? '16:00' : '17:00')
                        })
                    } else {
                        $('[name="time-in"]').val(time_in)
                    }
                })

            })
            form_pdf_bytes = await fetch('./timesheetForm.pdf').then(res => res.arrayBuffer())
            pdfDoc = await PDFDocument.load(form_pdf_bytes)

            $('#dept option').not(':disabled').each(function () {
                $(this).val($(this).text());
            });
            font_bytes = await fetch('./THSarabun.ttf').then(res => res.arrayBuffer())
            for (let i = new Date().getFullYear(); i >= new Date().getFullYear() - 5; i--) {
                $('#year').append($('<option>').val(i).text(i))
            }
            $('#year').val(new Date().getFullYear())
            $('#month').val(new Date().getMonth() + 1)
            generateTable()
            $('#month, #year').change(function () {
                generateTable()
            })
            $('#auto-onc').click(function () {
                event.preventDefault()
                Swal.fire({
                    title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô ON Call',
                    // calendar table
                    html: getCalendar(),
                    didOpen: function () {
                        $('#calendar tbody tr td').each(function () {
                            $(this).click(function () {
                                $(this).toggleClass('bg-warning text-white')
                            })
                        })
                    },
                    showCancelButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                }).then((result) => {
                    let val = $('#calendar td.bg-warning').map(function () {
                        return $(this).text()
                    }).get().join(',')
                    if (val == '') return
                    else val = val.split(',')
                    let windowWidth = window.innerWidth
                    val.forEach(v => {
                        if (windowWidth < 768) {
                            $('td.child [name="worktype-' + (Number(v) - 1) + '"]').val('On Call').trigger('change')
                            return
                        }
                        $('#worktype-' + (Number(v) - 1)).val('On Call').trigger('change')
                    })
                })
            })
            $('#auto-off').click(function () {
                event.preventDefault()
                Swal.fire({
                    title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô Day-Off',
                    html: getCalendar(),
                    didOpen: function () {
                        $('#calendar tbody tr td').each(function () {
                            $(this).click(function () {
                                $(this).toggleClass('bg-danger text-white')
                            })
                        })
                    },
                    showCancelButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                }).then((result) => {
                    let val = $('#calendar td.bg-danger').map(function () {
                        return $(this).text()
                    }).get().join(',')
                    if (val == '') return
                    else val = val.split(',')
                    if (window.innerWidth < 768) {
                        $('td.child .worktype').filter(function () {
                            return $(this).val() != 'On Call'
                        }).each(function () {
                            $(this).val('On').trigger('change')
                        })
                        val.forEach(v => {
                            $('td.child #worktype-' + (Number(v) - 1)).val('Off').trigger('change')
                        })
                        return
                    }
                    $('.worktype').filter(function () {
                        return $(this).val() != 'On Call'
                    }).each(function () {
                        $(this).val('On').trigger('change')
                    })
                    val.forEach(v => {
                        $('#worktype-' + (Number(v) - 1)).val('Off').trigger('change')
                    })
                })
            })
        })

        function generateTable() {
            $.LoadingOverlay("show");
            let monthArr = generateMonthArr($('#month').val(), $('#year').val())
            let table = $('<table>').addClass('table table-bordered table-hover').attr('id', 'table')
            let thead = $('<thead>')
            thead.append(`
            <tr>
                <th class="text-center text-bg-primary">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ</th>
                <th class="text-center text-bg-primary">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th class="text-center text-bg-primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                <th class="text-center text-bg-primary">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
                <th class="text-center text-bg-primary">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            </tr>
            `)
            let tbody = $('<tbody>')
            let worktype = ['On', 'Off', 'On Call', 'Annual Leave', 'Birthday Leave', 'Business Leave', 'Business Family Leave', 'Business Leave Specific', 'Funeral Leave', 'Sick Leave (Admit)', 'Sick No Medical Certificate', 'Sick with Medical Certificate', 'Special Leave', 'Sterilization Leave', 'Temporary Work Affiliate', 'Training Leave', 'Work from Home', 'Work Outside']
            let worktype_select = $('<select>', {
                class: 'form-select',
                name: 'worktype',
                id: 'worktype'
            })
            worktype.forEach(type => {
                worktype_select.append($('<option>').val(type).text(type))
            })
            let stsrt_time_select = $('<select>', {
                class: 'form-select',
                name: 'start_time',
                id: 'start_time'
            })
            let end_time_select = $('<select>', {
                class: 'form-select',
                name: 'end_time',
                id: 'end_time'
            })
            let type_select = $('<select>', {
                class: 'form-select',
                name: 'type',
                id: 'type'
            })
            for (let i = 0; i < 24; i++) {
                stsrt_time_select.append($('<option>').val(('00' + i).slice(-2) + ':00').text(('00' + i).slice(-2) + ':00'))
                end_time_select.append($('<option>').val(('00' + i).slice(-2) + ':00').text(('00' + i).slice(-2) + ':00'))
            }
            type_select.append($('<option>').val('‡∏õ‡∏Å‡∏ï‡∏¥').text('‡∏õ‡∏Å‡∏ï‡∏¥')).append($('<option>').val('‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤').text('‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤')).append($('<option>').val('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î').text('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î'))
            for (let i = 0; i < monthArr.length; i++) {
                let tr = $('<tr>')
                tr.append($('<td>').text(monthArr[i]).addClass('date').prop('id', 'date-' + i))
                tr.append($('<td>').append($(worktype_select).clone().attr('id', 'worktype-' + i).attr('name', 'worktype-' + i).addClass('worktype')))
                tr.append($('<td>').append($(stsrt_time_select).clone().attr('id', 'start_time-' + i).attr('name', 'start_time-' + i).addClass('start_time')))
                tr.append($('<td>').append($(end_time_select).clone().attr('id', 'end_time-' + i).attr('name', 'end_time-' + i).addClass('end_time')))
                tr.append($('<td>').append($(type_select).clone().attr('id', 'type-' + i).attr('name', 'type-' + i).addClass('type')))
                if (monthArr[i].includes('SU') || monthArr[i].includes('SA')) {
                    tr.addClass('isHoliday')
                }
                tbody.append(tr)
            }
            table.append(thead).append(tbody)
            console.log(table.prop('outerHTML'));
            $('.table-responsive').html(table)
            $('#table').DataTable({
                responsive: {
                    details: {
                        renderer: function (api, rowIdx, columns) {
                            let x = `<div class="row g-2 bg-body-tertiary"><div class="col-6">
                                    <span class="d-inline-block text-nowrap">${columns[1].title}:</span>
                                    ${columns[1].data}
                                </div>
                                <div class="col-6">
                                    <span class="d-inline-block text-nowrap">${columns[4].title}:</span>
                                    ${columns[4].data}
                                </div>
                                <div class="col-6">
                                    <span class="d-inline-block text-nowrap">${columns[2].title}:</span>
                                    ${columns[2].data}
                                </div>
                                <div class="col-6">
                                    <span class="d-inline-block text-nowrap">${columns[3].title}:</span>
                                    ${columns[3].data}
                                </div></div>`
                            return columns ? x : false;
                        },
                    },
                },
                columns: [
                    { class: 'all' },
                    { class: 'min-tablet' },
                    { class: 'min-tablet' },
                    { class: 'min-tablet' },
                    { class: 'min-tablet' },
                ],
                pageLength: 31,
                dom: 't',
                initComplete: function () {
                    if (window.innerWidth < 768) {
                        $('#table tbody tr td').each(function () {
                            if ($(this).html().includes('SA') || $(this).html().includes('SU')) return
                            $(this).addClass('bg-primary-subtle fw-bold')
                        })
                        // always show detail row
                        $('#table tbody tr td.date').each(async function () {
                            let _this = $(this)
                            await new Promise((resolve, reject) => {
                                setTimeout(() => {
                                    _this.trigger('click')
                                }, 10)
                                resolve()
                            })
                        })
                    }

                    setTimeout(() => {
                        let windowWidth = window.innerWidth
                        let start_time = time_in == '716' ? '07:00' : '08:00'
                        let end_time = time_in == '716' ? '16:00' : '17:00'
                        if (windowWidth < 768) {
                            $('td.child .worktype').off('change').on('change', function () {
                                let id = $(this).prop('id').split('-')[1]
                                let onc_hour = $('td.child .worktype').filter(function () {
                                    return $(this).val() == 'On Call'
                                }).length * 20
                                if (onc_hour <= 0) $('#show-summary').prop('checked', false).attr('data-isReload', 'no').trigger('change')
                                $('#onc-hour').val(onc_hour)
                                if ($('#per-hour').val()) $('#total').val(onc_hour * Number($('#per-hour').val().replace(/,/g, '')))
                                else $('#total').val('')
                                let tr = $(this).closest('tr')
                                if ($(this).val() == 'On Call') {
                                    $('[name="start_time-' + id + '"]').val('16:00')
                                    $('[name="end_time-' + id + '"]').val('08:00')
                                    $('[name="type-' + id + '"]').val('‡∏õ‡∏Å‡∏ï‡∏¥')
                                    tr.prev().find('td').first().removeClass('bg-primary-subtle text-bg-danger text-bg-info').addClass('text-bg-warning')
                                    $('#show-summary').prop('checked', true).attr('data-isReload', 'no').trigger('change')
                                } else if ($(this).val() == 'Off') {
                                    $('[name="start_time-' + id + '"]').val('')
                                    $('[name="end_time-' + id + '"]').val('')
                                    $('[name="type-' + id + '"]').val('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î')
                                    tr.prev().find('td').first().removeClass('bg-primary-subtle text-bg-warning text-bg-info').addClass('text-bg-danger')
                                } else if ($(this).val() != 'On') {
                                    tr.prev().find('td').first().removeClass('text-bg-warning text-bg-danger text-bg-warning').addClass('text-bg-info')
                                    $('[name="start_time-' + id + '"]').val('')
                                    $('[name="end_time-' + id + '"]').val('')
                                    $('[name="type-' + id + '"]').val('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î')
                                } else {
                                    tr.prev().find('td').first().removeClass('text-bg-warning text-bg-danger text-bg-info').addClass('bg-primary-subtle')
                                    $('[name="start_time-' + id + '"]').val(start_time)
                                    $('[name="end_time-' + id + '"]').val(end_time)
                                    $('[name="type-' + id + '"]').val('‡∏õ‡∏Å‡∏ï‡∏¥')
                                }
                            })
                        } else {
                            $('.worktype').off('change').on('change', function () {
                                let id = $(this).prop('id').split('-')[1]
                                let onc_hour = $('.worktype').filter(function () {
                                    return $(this).val() == 'On Call'
                                }).length * 20
                                $('#onc-hour').val(onc_hour)
                                if ($('#per-hour').val()) $('#total').val(onc_hour * Number($('#per-hour').val().replace(/,/g, '')))
                                else $('#total').val('')
                                let tr = $(this).closest('tr')
                                if ($(this).val() == 'On Call') {
                                    $('[name="start_time-' + id + '"]').val('16:00')
                                    $('[name="end_time-' + id + '"]').val('08:00')
                                    $('[name="type-' + id + '"]').val('‡∏õ‡∏Å‡∏ï‡∏¥')
                                    tr.find('td').removeClass('bg-primary-subtle text-bg-danger text-bg-info').addClass('text-bg-warning')
                                    $('#show-summary').prop('checked', true).attr('data-isReload', 'no').trigger('change')
                                } else if ($(this).val() == 'Off') {
                                    $('[name="start_time-' + id + '"]').val('')
                                    $('[name="end_time-' + id + '"]').val('')
                                    $('[name="type-' + id + '"]').val('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î')
                                    tr.find('td').removeClass('bg-primary-subtle text-bg-warning text-bg-info').addClass('text-bg-danger')
                                } else if ($(this).val() != 'On') {
                                    tr.find('td').removeClass('text-bg-warning text-bg-danger text-bg-warning').addClass('text-bg-info')
                                    $('[name="start_time-' + id + '"]').val('')
                                    $('[name="end_time-' + id + '"]').val('')
                                    $('[name="type-' + id + '"]').val('‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î')
                                }
                                else {
                                    tr.find('td').removeClass('text-bg-warning text-bg-danger').addClass('bg-primary-subtle')
                                    $('[name="start_time-' + id + '"]').val(start_time)
                                    $('[name="end_time-' + id + '"]').val(end_time)
                                    $('[name="type-' + id + '"]').val('‡∏õ‡∏Å‡∏ï‡∏¥')
                                }
                            })
                        }
                        $('#table').find('select').each(function () {
                            let id = $(this).prop('id')
                            let parent = $(this).closest('tr')
                            if (parent.hasClass('isHoliday')) return
                            switch (true) {
                                case id.indexOf('worktype') > -1:
                                    $(this).val('On')
                                    break
                                case id.indexOf('start_time') > -1:
                                    $(this).val(start_time)
                                    break
                                case id.indexOf('end_time') > -1:
                                    $(this).val(end_time)
                                    break
                                case id.indexOf('type') > -1:
                                    $(this).val('‡∏õ‡∏Å‡∏ï‡∏¥')
                                    break
                                default:
                                    break
                            }
                        })
                        $('.isHoliday').each(function () {
                            let id = $(this).find('td').first().prop('id').split('-')[1]
                            if (windowWidth < 768) {
                                $('td.child [name="worktype-' + id + '"]').val('Off').trigger('change')
                                return
                            }
                            $('[name="worktype-' + id + '"]').val('Off').trigger('change')
                        })
                        $('#onc-hour').off('change').on('change', function () {
                            if ($('#per-hour').val()) $('#total').val($(this).val() * Number($('#per-hour').val().replace(/,/g, '')))
                            else $('#total').val('')
                        })

                        $('#per-hour').off('change').on('change', function () {
                            if ($('#onc-hour').val()) $('#total').val($('#onc-hour').val() * Number($(this).val().replace(/,/g, '')))
                            else $('#total').val('')
                        })
                        $.LoadingOverlay("hide");
                    }, 1000);



                },
            });

        }

        function base64ToArrayBuffer(base64) {
            var binaryString = atob(base64);
            var bytes = new Uint8Array(binaryString.length);
            for (var i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function generateMonthArr(month = 1, year = 2024) {
            let firstDay_of_month = new Date(year, month - 1, 1);
            let lastDay_of_month = new Date(year, month, 0);
            let total_month_days = lastDay_of_month.getDate();
            let monthArr = []
            let weekdat = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA']
            for (let i = 1; i <= total_month_days; i++) {
                let day = new Date(year, month - 1, i);
                let text = `${('00' + day.getDate()).slice(-2)}/${('00' + (day.getMonth() + 1)).slice(-2)}/${day.getFullYear()} (${weekdat[day.getDay()]})`;
                monthArr.push(text);
            }
            return monthArr
        }

        function getCalendar() {
            let monthArr = generateMonthArr($('#month').val(), $('#year').val())
            let table = $('<table>').addClass('table table-bordered').attr('id', 'calendar')
            let thead = $('<thead>')
            thead.append(`<tr>
                <th>SU</th>
                <th>MO</th>
                <th>TU</th>
                <th>WE</th>
                <th>TH</th>
                <th>FR</th>
                <th>SA</th>
            </tr>`)
            let tbody = $('<tbody>')
            for (let i = 0; i < 5; i++) {
                let tr = $('<tr>')
                for (let j = 0; j < 7; j++) {
                    tr.append($('<td>'))
                }
                tbody.append(tr)
            }
            let count = 0
            for (let i = 0; i < monthArr.length; i++) {
                let day = new Date($('#year').val(), $('#month').val() - 1, i + 1)
                let dayOfWeek = day.getDay()
                console.log("üöÄ ~ getCalendar ~ dayOfWeek:", dayOfWeek)
                tbody.find('tr').eq(count).find('td').eq(dayOfWeek).text(i + 1).addClass('text-center').css('cursor', 'pointer')
                if (dayOfWeek == 6) count++
            }
            table.append(thead).append(tbody)
            return table.prop('outerHTML')
            // let count = 0
            // let tr = $('<tr>')
            // for (let i = 0; i < monthArr.length; i++) {
            //     let day = new Date($('#year').val(), $('#month').val() - 1, i + 1)
            //     let dayOfWeek = day.getDay()
            //     console.log("üöÄ ~ getCalendar ~ dayOfWeek:", dayOfWeek)
            //     if (dayOfWeek == 0) {
            //         tbody.append(tr)
            //         tr = $('<tr>')
            //     }
            //     tr.append($('<td>').text(i + 1).addClass('text-center').css('cursor', 'pointer').click(function () {
            //         $(this).toggleClass('bg-primary text-white')
            //     }))
            //     tbody.append(tr)
            // }
            // table.append(thead).append(tbody)
            // return table.prop('outerHTML')


        }
    </script>
    <script>
        var pdfDoc
        var PDFDocument = PDFLib.PDFDocument;
        var StandardFonts = PDFLib.StandardFonts;
        var pdfFiles = []
        $('#submit-btn').click(async function () {
            event.preventDefault()
            $.LoadingOverlay("show");
            if (!pdfDoc) pdfDoc = await PDFDocument.load(form_pdf_bytes)
            var form = pdfDoc.getForm()
            pdfDoc.registerFontkit(fontkit);
            const sarabun = await pdfDoc.embedFont(font_bytes, { subset: true })
            const symbol = await pdfDoc.embedFont(StandardFonts.ZapfDingbats, { subset: true })
            var signature, e_img
            let data = $('#table').DataTable().rows().data().map(function (row) {
                row = row.map(function (col) {
                    if (col.indexOf('select') > -1) return $('#' + col.split('id="')[1].split('"')[0]).val()
                    return col
                })
                return row
            })
            $('.date').each(function (i, ele) {
                let id = Number($(this).prop('id').split('-')[1]) + 1
                let textfield = form.getTextField('date-' + (id))
                textfield.setFontSize(10)
                form.getTextField('date-' + (id)).setText($(this).text().trim())
            })
            $('.worktype').each(function (i, ele) {
                let id = Number($(this).prop('id').split('-')[1]) + 1
                form.getTextField('worktype-' + (id)).setText($(this).val())
            })
            $('.start_time').each(function (i, ele) {
                let val = $(this).val()
                if (val == '' || val == null) val = ''
                let id = Number($(this).prop('id').split('-')[1]) + 1
                form.getTextField('start-' + (id)).setText(val)
            })
            $('.end_time').each(function (i, ele) {
                let val = $(this).val()
                if (val == '' || val == null) val = ''
                let id = Number($(this).prop('id').split('-')[1]) + 1
                form.getTextField('end-' + (id)).setText(val)
            })
            $('.type').each(function (i, ele) {
                let val = $(this).val()
                let id = Number($(this).prop('id').split('-')[1]) + 1
                let textfield
                switch (val) {
                    case '‡∏õ‡∏Å‡∏ï‡∏¥':
                        textfield = form.getTextField('type-normal-' + (id))
                        break;
                    case '‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤':
                        textfield = form.getTextField('type-ot-' + (id))
                        break;
                    case '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î':
                        textfield = form.getTextField('type-off-' + (id))
                        form.getTextField('start-' + (id)).setText('-')
                        form.getTextField('end-' + (id)).setText('-')
                        break;
                    default: break;

                }
                textfield.setText('‚úì')
                textfield.updateAppearances(symbol)

            })
            if ($('#show-summary').is(':checked')) {
                let onc_hour = Number($('#onc-hour').val())
                let per_hour = Number($('#per-hour').val())
                let total = onc_hour * per_hour
                form.getTextField('onc-hour').setText(onc_hour.toString())
                form.getTextField('per-hour').setText(per_hour.toFixed(2))
                form.getTextField('total').setText(total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ","))
            }

            form.updateFieldAppearances(sarabun);
            form.flatten()
            var pdfBytes = await pdfDoc.save()
            var pdfdatauri = await pdfDoc.saveAsBase64({ dataUri: true })
            $.LoadingOverlay("hide");
            Swal.fire({
                icon: 'success',
                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                timer: 2000,
                showConfirmButton: false,
            }).then(async () => {
                var iframe = document.getElementById('pdf')
                // open pdf in new small window
                var blob = new Blob([pdfBytes], { type: 'application/pdf' })
                var url = URL.createObjectURL(blob)
                if (window.innerWidth < 768) {
                    window.open(url + '#toolbar=1', '_blank')
                    return
                }
                iframe.src = url + '#toolbar=1&zoom=75'
                // disable download

                let name = 'TIMESHEET ' + new Date().getTime() + '.pdf'
                $(iframe).show(200)
                $(iframe).attr('download', name)
                $(iframe).attr('title', name)
                $('#print-btn').parent().removeClass('d-none')
                $('#print-btn').click(function () {
                    iframe.contentWindow.print()
                })


                // scroll to pdf
                $('html, body').animate({
                    scrollTop: $(iframe).offset().top
                }, 500);
                pdfDoc = await PDFDocument.load(form_pdf_bytes)

            })
        })
        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
</body>

</html>