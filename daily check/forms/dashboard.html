<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Akshar&family=Prompt:ital@0;1&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="icon" href="/icon.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.min.js"></script>
    <style>
        body {
            height: 100%;
            font-family: 'Akshar', sans-serif;
            font-family: 'Prompt', sans-serif;
            /* background-color: #fafafa; */
        }

        .nav-tabs .nav-link.active {
            background-color: #0080FF;
            color: #FFF;
        }

        .nav-tabs .nav-link {
            color: #0080FF;
        }

        .progress-bar[aria-valuenow="0"] {
            color: gray;
            min-width: 100%;
            background: transparent;
            box-shadow: none;
        }

        .progress-bar {
            /* color: black; */
            overflow: visible;
        }

        /* section{
            background-color: #fff;
        } */
    </style>
    <title>Daliy Check Dashboard</title>
</head>

<body class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://img.in.th/images/9a12e85d8bb613aa639e425f4ab87a09.png" alt="" height="20" class="d-inline-block">
                Daily Check
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link active" aria-current="page" href="">Home</a>
                    <a class="nav-link" href="login.html">For Approved</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col-12 text-center px-5 mt-3">
                <img src="https://img.in.th/images/92cc41f62e7a8b08398ed7cddcc22725.jpg" alt="banner" class="img-fluid" style="max-width: 150px;">
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col text-center">
                DASHBOARD&nbsp;<span id="thisdate"></span>
            </div>
            <div class="col-12 text-center mb-3" id="client-sel-div" style="display: none;">
                <label for="client-sel">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label>
                <select class="form-select" id="client-sel">
                    <option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                    <option value="pyt1">PYT1</option>
                    <option value="pyt2">PYT2</option>
                    <option value="pyt3">PYT3</option>
                    <option value="plp">PLP</option>
                </select>
            </div>
        </div>
        <div class="row justify-content-center" id="firstlevel-dashboard">
        </div>
    </div>
    <footer>
        <div class="row justify-content-center align-items-center">
            <div class="col-12 text-center">
                <img src="https://img.in.th/images/f54c58a2f8c9d8c09b308f12625a175e.jpg" alt="footer" class="img-fluid" style="max-height: 80px;">
            </div>
            <div class="col-12 text-center">
                <img src="https://img.in.th/images/e5f742132b3648b83a134257cc05d903.jpg" alt="footer" class="img-fluid" style="max-width:150px; max-height: 60px;">
            </div>
        </div>
        <div class="row justify-content-center align-items-center">
            <div class="col text-center text-end" style="font-size: 0.7rem;">
                Developed by <span class="text-primary">Daranphop Yimyam (BME PYT3)</span>
            </div>
        </div>
        <div class="copyright" align="center">
            <script>
                document.write('&copy;');
                document.write(' 2022 ');
                document.write('  N-Health Phayathai 3 Daily Check - All Rights Reserved.');
            </script>
        </div>
    </footer>
    <div class="modal fade" id="detail-modal" tabindex="-1" aria-labelledby="detail-modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header text-bg-warning">
                    <h5 class="modal-title" id="detail-modalLabel">Approve record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body row">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        var vConsole = new window.VConsole();
    </script>
    <script>
        var script_url = 'https://script.google.com/macros/s/AKfycbxlVshSHWBOLK3TlWk_KIykaUUSPLe2-OGM8qK0aYWWJWdtJ-0JBkfCDqCSiTsOzwMg/exec'
        var firestore, auth, client, uid
        $(document).ready(function () {
            liff
                .init({
                    liffId: "1657104960-R3P2nPO4",
                    withLoginOnExternalBrowser: true
                })
                .then(() => {
                    console.log('liff init success');
                    $('#thisdate').text(moment().format('DD/MM/YYYY'))
                    $.LoadingOverlay('show')
                    let config = localStorage.getItem("config")
                    if (config) {
                        setFirebase(JSON.parse(config))
                    } else {
                        $.post(script_url, { opt: 'getconst' }, async function (c) {
                            localStorage.setItem('config', JSON.stringify(c))
                            setFirebase(c)
                        })
                    }
                })
                .catch((err) => {
                    // Error happens during initialization
                    console.log(err.code, err.message);
                });
            $('#client-sel').change(function () {
                localStorage.setItem('client', $(this).val())
                $('#firstlevel-dashboard').html('')
                client = $(this).val()
                getSummary()
            })
        });
        async function setFirebase(c) {
            const firebaseConfig = c
            const defaultProject = firebase.initializeApp(firebaseConfig);
            firestore = defaultProject.firestore();
            auth = defaultProject.auth();
            if (!auth.currentUser) {
                // await getAuth()
                await getAuth(await liff.getDecodedIDToken().sub)
            }
            await getClient()
            await getSummary()
            $.LoadingOverlay("hide");
        }
        async function getClient() {
            uid = await liff.getDecodedIDToken().sub
            await firestore.collection('uid').doc(uid).get().then(doc => {
                if (doc.exists) {
                    client = doc.data().site
                    if (client == 'all') {
                        $('#client-sel-div').show()
                        client = localStorage.getItem('client') || 'pyt3'
                        $('#client-sel').val(client)
                    }
                    return true
                } else {
                    return false
                }
            })
        }
    </script>
    <script>
        async function getAuth(uid = 'Ufc119481401176eb18a80cb8379a55aa') {
            let email = uid + '@dailycheck.com'
            let password = 'dailycheck'
            await auth.signInWithEmailAndPassword(email, password).then(function (user) {
                console.log('sign in successful')
            }).catch(async function (error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                // The email of the user's account used.
                // var email = error.email;
                // The firebase.auth.AuthCredential type that was used.
                var credential = error.credential;
                // ...
                console.log(errorCode)
                console.log(errorMessage)
                console.log(credential)
                await auth.createUserWithEmailAndPassword(email, password).then(function (user) {
                    console.log('sign up successful')
                }).catch(function (error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // The email of the user's account used.
                    var email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    var credential = error.credential;
                    // ...
                    console.log(errorCode)
                    console.log(errorMessage)
                    console.log(email)
                    console.log(credential)
                });
            });
        }
        async function getSummary() {
            if (!client) {
                $.LoadingOverlay('hide')
                const { value: cl } = await Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô',
                    text: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÑ‡∏î‡πâ',
                    // buttonsStyling: false,
                    // customClass: {
                    //     confirmButton: 'btn btn-success',
                    //     input: 'form-control container-fluid'
                    // },
                    input: 'select',
                    inputOptions: {
                        "pyt1": "PYT1",
                        "pyt2": "PYT2",
                        "pyt3": "PYT3",
                        "plp": "PLP",
                    },
                    inputPlaceholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                    inputValidator: (value) => {
                        if (!value) {
                            return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô'
                        }
                    }
                })
                if (cl) {
                    client = cl
                    firestore.collection('uid').doc(uid).get()
                        .then((docSnapshot) => {
                            if (docSnapshot.exists) {
                                firestore.collection('uid').doc(uid).update({ uid: uid, site: client })
                            } else {
                                firestore.collection('uid').doc(uid).set({ uid: uid, site: client })
                            }
                        });
                }
            }
            let now = new Date()
            let start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0).getTime()
            let end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).getTime()
            let promises = await Promise.all([
                firestore.collection(client.toUpperCase())
                    .where('time', '>=', start)
                    .where('time', '<=', end)
                    .get().then(querySnapshot => {
                        return querySnapshot.docs.map(doc => {
                            return doc.data()
                        })
                    }).catch(function (error) {
                        console.error(error)
                    }),
                firestore.collection(client.toUpperCase() + '_summary').doc(client.toUpperCase()).get().then(doc => {
                    return doc.data()
                }).catch(function (error) {
                    console.error(error)
                })
            ])
            setFirstlevelDashboard(promises)
            return
        }
    </script>
    <script>
        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }
        function setFirstlevelDashboard(datas) {
            let data = getFirstlevelDashboard([...datas])
            data.forEach(a => {
                let html = `<div class="${a.percent == 0 ? 'col-6' : 'col-12'} col-md-3">
                <div class="card text-bg-light mb-3 ${a.percent == 0 ? '' : 'shadow'}">
                    <div class="card-header ${a.percent == 0 ? 'text-bg-light' : 'text-bg-primary'}" style="font-size: ${a.percent == 0 ? '0.8rem' : '1.2rem'}; overflow: hidden; white-space: nowrap; text-overflow: ellipsis">${toTitleCase(a.dept)}</div>
                    <div class="card-body">
                        <div class="progress" style="${a.percent == 0 ? '' : 'background-color: #95a5c3;'}">
                            <div class="progress-bar" role="progressbar" aria-label="${a.dept} progress" style="width: ${a.percent}%;" aria-valuenow="${a.percent}" aria-valuemin="0" aria-valuemax="100">${a.today}/${a.all}</div>
                        </div>
                    </div>
                </div>
            </div>`
                $('#firstlevel-dashboard').append(html)
            })
            $('.card').click(function () {
                let dept = $(this).find('.card-header').text()
                setSecondlevelDashboard([...datas], dept)
            }).hover(function () {
                $(this).css('cursor', 'pointer')
            }).mouseleave(function () {
                $(this).css('cursor', 'default')
            })
        }
        function setSecondlevelDashboard(datas, dept) {
            let data = getSecondlevelDashboard([...datas], dept)
            $('#detail-modal .modal-body').html('')
            $('#detail-modal .modal-title').html(dept.toUpperCase())
            data.forEach(a => {
                let html = `<div class="${a.percent == 0 ? 'col-6' : 'col-12'} col-md-6">
                <div class="card text-bg-light mb-3 ${a.percent == 0 ? '' : 'shadow border border-1 border-primary'} card-second">
                    <div class="card-header" style="font-size: ${a.percent == 0 ? '0.8rem' : '1.2rem'}; overflow: hidden; white-space: nowrap; text-overflow: ellipsis">${toTitleCase(a.name)}</div>
                    <div class="card-body">
                          <div class="progress" style="${a.percent == 0 ? '' : 'background-color: #95a5c3;'}">
                            <div class="progress-bar" role="progressbar" aria-label="${a.name} progress" style="width: ${a.percent}%;" aria-valuenow="${a.percent}" aria-valuemin="0" aria-valuemax="100">${a.today}/${a.all}</div>
                        </div>
                    </div>
                </div>
            </div>`
                $('#detail-modal .modal-body').append(html)
            })
            $('.card-second').click(function () {
                let name = $(this).find('.card-header').text()
                setThirdlevelDashboard([...datas], dept, name)
            }).hover(function () {
                $(this).css('cursor', 'pointer')
            }).mouseleave(function () {
                $(this).css('cursor', 'default')
            })
            $('#detail-modal').modal('show')
        }
        function setThirdlevelDashboard(datas, dept, name) {
            let data = getThirdlevelDashboard([...datas], dept, name)
            Swal.fire({
                title: name.toUpperCase(),
                html: `<div class="border border-2 border-success rounded mb-3" style="min-height: 150px">‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß<br>${data.done.map(a => '<span class="badge rounded-pill text-bg-success p-2 m-2" style="font-size: 1.2rem">' + a + '</span>').join('')}  </div>  
                <div class="border border-2 border-secondary rounded" style="min-height: 150px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥<br>${data.notyet.map(a => '<span class="badge rounded-pill text-bg-warning p-2 m-2" style="font-size: 1.1rem">' + a + '</span>').join('')}     </div>`,
                showConfirmButton: false,
                showCalcelButton: true,
                cancelButtonText: '‡∏õ‡∏¥‡∏î',
                cancelButonColor: '#808080',
            })
        }
        function getFirstlevelDashboard(datas) {
            datas[0] = [...new Set(datas[0].map(obj => obj.e_code))]
            let dashboard_data = {}
            Object.keys(datas[1]).forEach(key => {
                if (key == 'all') return
                let today = 0
                datas[0].forEach((e_code, i) => {
                    if (datas[1][key].all.includes(e_code)) {
                        today++
                    }
                })
                dashboard_data[key] = {
                    dept: key.toUpperCase(),
                    all: datas[1][key]?.all?.length || 0,
                    today: today,
                    remain: datas[1][key]?.all?.length - today,
                    percent: (today / datas[1][key]?.all?.length) * 100
                }
            })
            let d = Object.keys(dashboard_data).map(a => dashboard_data[a]).sort((a, b) => b.percent - a.percent)
            return d
        }
        function getSecondlevelDashboard(datas, dept) {
            console.log("üöÄ ~ dept", dept)
            console.log("üöÄ ~ datas", datas)
            dept = dept.replace(/\+/g, ' ').toUpperCase()
            datas[0] = [...new Set(datas[0].map(obj => obj.e_code))]
            let dashboard_data = {}
            Object.keys(datas[1][dept]).forEach(e => {
                if (e == 'sum' || e == 'all') return
                let today = 0
                datas[0].forEach(e_code => {
                    // 
                    if (datas[1][dept][e].arr.includes(e_code)) {
                        today++
                    }
                })
                dashboard_data[e] = {
                    dept: dept,
                    name: e,
                    all: datas[1][dept][e].sum,
                    today: today,
                    remain: datas[1][dept][e].sum - today,
                    percent: (today / datas[1][dept][e].sum) * 100
                }
            })
            let d = Object.keys(dashboard_data).map(a => dashboard_data[a]).sort((a, b) => b.percent - a.percent)
            return d
        }
        function getThirdlevelDashboard(datas, dept, name) {
            dept = dept.replace(/\+/g, ' ').toUpperCase()
            name = name.toLowerCase()
            let done = []
            datas[0] = [...new Set(datas[0].map(obj => obj.e_code))]
            let edata = [...datas[1][dept][name].arr]
            datas[0].forEach(e_code => {
                if (edata.includes(e_code)) {
                    done.push(e_code)
                    edata.splice(edata.indexOf(e_code), 1)
                }
            })
            let dashboard_data = {
                done: done,
                notyet: edata
            }
            // let d = Object.keys(dashboard_data).map(a => dashboard_data[a]).sort((a, b) => b.percent - a.percent)
            return dashboard_data
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>