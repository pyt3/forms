<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily check scancode</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="icon" href="/icon.png" type="image/png">
</head>

<body>
    <div id="reader" width="600px"></div>
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // VConsole will be exported to `window.VConsole` by default.
        var vConsole = new window.VConsole();
    </script>
    <script>
        var firestore
        window.onload = () => {
            scancodev2()
            const firebaseConfig = {
                apiKey: "AIzaSyANRS_sanVDjdunkY8z-F5UD-n3R1rgYKQ",
                authDomain: "daily-check-form.firebaseapp.com",
                projectId: "daily-check-form",
                storageBucket: "daily-check-form.appspot.com",
                messagingSenderId: "544837049860",
                appId: "1:544837049860:web:462e6b854290b1dec39f51"
            };
            const defaultProject = firebase.initializeApp(firebaseConfig);
            console.log(defaultProject.name);  // "[DEFAULT]"
            firestore = defaultProject.firestore();
        }

    </script>
    <script>
        // liff.init({ liffId: '1657104960-953rK3wq' })
        // liff.ready.then(() => {
        //     if (!liff.isLoggedIn()) {
        //         return liff.login()
        //     }
        //     // scancode()
        //     scancodev2()
        // })

        // var liffId = {
        //     defibrillator: '1657104960-wXQRkQ87',
        //     incubator: '1657104960-w9greg5D',
        //     temperature: '1657104960-92R4ZRQz',
        //     monitorbedside: '1657104960-p9V0QVJx'
        // }
        function scancode() {
            liff.scanCodeV2()
                .then((result) => {
                    let id = result.value.split('=')[1]
                    firestore.collection('PYT3_e').doc(id).get().then(docs => {
                        let d = docs.data()
                        if (docs.exists && liffId[d.form]) {
                            // let url = new URL('https://liff.line.me/' + liffId[d.form])
                            let url = new URL('line://app/' + liffId[d.form])
                            // let url = new URL('https://liff.line.me/1655873446-gp23vvmV')
                            // let url = new URL('https://pyt3.github.io/forms/daily%20check/forms/' + d.form + '?' + new Date().getTime())
                            url.searchParams.set("client", 'PYT3')
                            url.searchParams.set("id", d.code)
                            url.searchParams.set("name", d.name)
                            url.searchParams.set("dept", d.dept)
                            url.searchParams.set("brand", d.brand)
                            url.searchParams.set("model", d.model)
                            if (d.form == 'temperature') {
                                url.searchParams.set("mintemp", d.mintemp)
                                url.searchParams.set("maxtemp", d.maxtemp)
                            }
                            //url = `${url}?id=${id}&name=${d.name}&dept=${d.dept}&model=${d.model}&brand=${d.brand}`
                            // 

                            // liff.closeWindow()
                            window.open(url, '_self')
                        } else {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ไม่พบข้อมูล หรือท่านอาจเลือกชนิดเครื่องมือไม่ถูกต้อง',
                                confirmButtonText: 'แสกนอีกครั้ง',
                                cancelButtonText: 'ปิดหน้าต่าง',
                                showCancelButton: true,
                            }).then(result => {
                                if (result.isConfirmed) {
                                    scancode()
                                } else {
                                    liff.closeWindow()
                                }
                            })
                        }
                    })
                        .catch((err) => {
                            console.log(err);
                            liff.closeWindow()
                        });
                })
        }
    </script>
    <script>
        function scancodev2() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                /* handle success */
            };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
        }
    </script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>